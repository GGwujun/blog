<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog/umi.css" />
    <script>
      window.routerBase = "/blog";
    </script>
    <script>
      //! umi version: 3.5.17
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.indexOf(e) > -1 ? e : r[0]
        );
      })();
    </script>
    <title>基于实时数据库：在线对战五子棋小游戏</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/node-js/04.serverless/01" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>计算机基础<ul><li><a href="/blog/编译原理之美">编译原理之美</a></li><li><a href="/blog/编译原理实战">编译原理实战</a></li><li><a href="/blog/深入浅出计算机组成原理">深入浅出计算机组成原理</a></li><li><a href="/blog/详解http">详解http</a></li><li><a href="/blog/计算机网络通关29讲">计算机网络通关29讲</a></li><li><a href="/blog/网络排查案例课">网络排查案例课</a></li><li><a href="/blog/linux操作系统">linux操作系统</a></li><li><a href="/blog/linux性能优化实战">linux性能优化实战</a></li><li><a href="/blog/程序员数学基础">程序员数学基础</a></li><li><a href="/blog/趣谈网络协议">趣谈网络协议</a></li><li><a href="/blog/操作系统实战">操作系统实战</a></li><li><a href="/blog/软件工程之美">软件工程之美</a></li><li><a href="/blog/sql必知必会">sql必知必会</a></li><li><a href="/blog/操作系统实战45讲">操作系统实战45讲</a></li><li><a href="/blog/网络编程实战">网络编程实战</a></li></ul></span><span>算法<ul><li><a href="/blog/常用算法25讲">常用算法25讲</a></li><li><a href="/blog/数据结构与算法之美">数据结构与算法之美</a></li><li><a href="/blog/业务开发算法50讲">业务开发算法50讲</a></li><li><a href="/blog/动态规划面试宝典">动态规划面试宝典</a></li></ul></span><span>前端开发<ul><li><a href="/blog/浏览器工作原理与实践">浏览器工作原理与实践</a></li><li><a href="/blog/新时代产品经理进阶之路">新时代产品经理进阶之路</a></li><li><a href="/blog/全栈工程师修炼指南">全栈工程师修炼指南</a></li><li><a href="/blog/flutter核心技术与实战">flutter核心技术与实战</a></li><li><a href="/blog/java-script核心原理解析">java-script核心原理解析</a></li><li><a href="/blog/说透低代码">说透低代码</a></li><li><a href="/blog/nodejs应用开发实战">nodejs应用开发实战</a></li><li><a href="/blog/反爬虫兵法演绎20讲">反爬虫兵法演绎20讲</a></li><li><a href="/blog/reactnative新架构实战课">reactnative新架构实战课</a></li><li><a href="/blog/正则表达式入门">正则表达式入门</a></li><li><a href="/blog/重学前端">重学前端</a></li><li><a href="/blog/serverless入门课">serverless入门课</a></li><li><a href="/blog/type-script入门实战笔记">type-script入门实战笔记</a></li><li><a href="/blog/图解googlev8">图解googlev8</a></li><li><a href="/blog/vue3源码分析">vue3源码分析</a></li><li><a href="/blog/玩转Vue3全家桶">玩转Vue3全家桶</a></li><li><a href="/blog/webassembly入门">webassembly入门</a></li><li><a href="/blog/手把手带你写一个Web框架">手把手带你写一个Web框架</a></li><li><a href="/blog/web漏洞挖掘实战">web漏洞挖掘实战</a></li><li><a href="/blog/跟月影学可视化">跟月影学可视化</a></li><li><a href="/blog/搞定音频技术">搞定音频技术</a></li><li><a href="/blog/攻克视频技术">攻克视频技术</a></li></ul></span><span>前端工程化<ul><li><a href="/blog/logger">logger</a></li><li><a href="/blog/webpack">webpack</a></li><li><a href="/blog/webpackChain">webpackChain</a></li></ul></span><span>前端性能优化<ul><li><a href="/blog/react性能调优">react性能调优</a></li></ul></span><span>软件测试<ul><li><a href="/blog/全链路压测实战30讲">全链路压测实战30讲</a></li><li><a href="/blog/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog/自动化测试高手课">自动化测试高手课</a></li><li><a href="/blog/软件测试52讲">软件测试52讲</a></li></ul></span><span>面试<ul><li><a href="/blog/面试现场">面试现场</a></li></ul></span><span>杂谈<ul><li><a href="/blog/超级访谈对话张雪峰">超级访谈对话张雪峰</a></li><li><a href="/blog/Git实战手册">Git实战手册</a></li><li><a href="/blog/NodeJS">NodeJS</a></li><li><a href="/blog/ReactJS">ReactJS</a></li><li><a href="/blog/UI设计">UI设计</a></li><li><a href="/blog/webpack4系列教程">webpack4系列教程</a></li><li><a href="/blog/前端知识体系">前端知识体系</a></li><li><a href="/blog/剑指offer刷题笔记">剑指offer刷题笔记</a></li><li><a href="/blog/思考与成长">思考与成长</a></li><li><a href="/blog/设计模式手册">设计模式手册</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>计算机基础<ul><li><a href="/blog/编译原理之美">编译原理之美</a></li><li><a href="/blog/编译原理实战">编译原理实战</a></li><li><a href="/blog/深入浅出计算机组成原理">深入浅出计算机组成原理</a></li><li><a href="/blog/详解http">详解http</a></li><li><a href="/blog/计算机网络通关29讲">计算机网络通关29讲</a></li><li><a href="/blog/网络排查案例课">网络排查案例课</a></li><li><a href="/blog/linux操作系统">linux操作系统</a></li><li><a href="/blog/linux性能优化实战">linux性能优化实战</a></li><li><a href="/blog/程序员数学基础">程序员数学基础</a></li><li><a href="/blog/趣谈网络协议">趣谈网络协议</a></li><li><a href="/blog/操作系统实战">操作系统实战</a></li><li><a href="/blog/软件工程之美">软件工程之美</a></li><li><a href="/blog/sql必知必会">sql必知必会</a></li><li><a href="/blog/操作系统实战45讲">操作系统实战45讲</a></li><li><a href="/blog/网络编程实战">网络编程实战</a></li></ul></li><li>算法<ul><li><a href="/blog/常用算法25讲">常用算法25讲</a></li><li><a href="/blog/数据结构与算法之美">数据结构与算法之美</a></li><li><a href="/blog/业务开发算法50讲">业务开发算法50讲</a></li><li><a href="/blog/动态规划面试宝典">动态规划面试宝典</a></li></ul></li><li>前端开发<ul><li><a href="/blog/浏览器工作原理与实践">浏览器工作原理与实践</a></li><li><a href="/blog/新时代产品经理进阶之路">新时代产品经理进阶之路</a></li><li><a href="/blog/全栈工程师修炼指南">全栈工程师修炼指南</a></li><li><a href="/blog/flutter核心技术与实战">flutter核心技术与实战</a></li><li><a href="/blog/java-script核心原理解析">java-script核心原理解析</a></li><li><a href="/blog/说透低代码">说透低代码</a></li><li><a href="/blog/nodejs应用开发实战">nodejs应用开发实战</a></li><li><a href="/blog/反爬虫兵法演绎20讲">反爬虫兵法演绎20讲</a></li><li><a href="/blog/reactnative新架构实战课">reactnative新架构实战课</a></li><li><a href="/blog/正则表达式入门">正则表达式入门</a></li><li><a href="/blog/重学前端">重学前端</a></li><li><a href="/blog/serverless入门课">serverless入门课</a></li><li><a href="/blog/type-script入门实战笔记">type-script入门实战笔记</a></li><li><a href="/blog/图解googlev8">图解googlev8</a></li><li><a href="/blog/vue3源码分析">vue3源码分析</a></li><li><a href="/blog/玩转Vue3全家桶">玩转Vue3全家桶</a></li><li><a href="/blog/webassembly入门">webassembly入门</a></li><li><a href="/blog/手把手带你写一个Web框架">手把手带你写一个Web框架</a></li><li><a href="/blog/web漏洞挖掘实战">web漏洞挖掘实战</a></li><li><a href="/blog/跟月影学可视化">跟月影学可视化</a></li><li><a href="/blog/搞定音频技术">搞定音频技术</a></li><li><a href="/blog/攻克视频技术">攻克视频技术</a></li></ul></li><li>前端工程化<ul><li><a href="/blog/logger">logger</a></li><li><a href="/blog/webpack">webpack</a></li><li><a href="/blog/webpackChain">webpackChain</a></li></ul></li><li>前端性能优化<ul><li><a href="/blog/react性能调优">react性能调优</a></li></ul></li><li>软件测试<ul><li><a href="/blog/全链路压测实战30讲">全链路压测实战30讲</a></li><li><a href="/blog/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog/自动化测试高手课">自动化测试高手课</a></li><li><a href="/blog/软件测试52讲">软件测试52讲</a></li></ul></li><li>面试<ul><li><a href="/blog/面试现场">面试现场</a></li></ul></li><li>杂谈<ul><li><a href="/blog/超级访谈对话张雪峰">超级访谈对话张雪峰</a></li><li><a href="/blog/Git实战手册">Git实战手册</a></li><li><a href="/blog/NodeJS">NodeJS</a></li><li><a href="/blog/ReactJS">ReactJS</a></li><li><a href="/blog/UI设计">UI设计</a></li><li><a href="/blog/webpack4系列教程">webpack4系列教程</a></li><li><a href="/blog/前端知识体系">前端知识体系</a></li><li><a href="/blog/剑指offer刷题笔记">剑指offer刷题笔记</a></li><li><a href="/blog/思考与成长">思考与成长</a></li><li><a href="/blog/设计模式手册">设计模式手册</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog/">大师兄 - 前端架构师</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="1 项目概述" data-depth="2"><a href="/blog/node-js/04.serverless/01#1-项目概述"><span>1 项目概述</span></a></li><li title="2 任务目标" data-depth="2"><a href="/blog/node-js/04.serverless/01#2-任务目标"><span>2 任务目标</span></a></li><li title="3 准备工作" data-depth="2"><a href="/blog/node-js/04.serverless/01#3-准备工作"><span>3 准备工作</span></a></li><li title="4 游戏流程图" data-depth="2"><a href="/blog/node-js/04.serverless/01#4-游戏流程图"><span>4 游戏流程图</span></a></li><li title="5 实战任务" data-depth="2"><a href="/blog/node-js/04.serverless/01#5-实战任务"><span>5 实战任务</span></a></li><li title="5.1 创建云开发与小游戏环境" data-depth="3"><a href="/blog/node-js/04.serverless/01#51-创建云开发与小游戏环境"><span>5.1 创建云开发与小游戏环境</span></a></li><li title="5.2 准备配置文件" data-depth="3"><a href="/blog/node-js/04.serverless/01#52-准备配置文件"><span>5.2 准备配置文件</span></a></li><li title="5.3 创建云开发接口" data-depth="3"><a href="/blog/node-js/04.serverless/01#53-创建云开发接口"><span>5.3 创建云开发接口</span></a></li><li title="5.4 获取云存储资源的链接" data-depth="3"><a href="/blog/node-js/04.serverless/01#54-获取云存储资源的链接"><span>5.4 获取云存储资源的链接</span></a></li><li title="5.5 游戏进入与身份判断" data-depth="3"><a href="/blog/node-js/04.serverless/01#55-游戏进入与身份判断"><span>5.5 游戏进入与身份判断</span></a></li><li title="5.6 创建新房间" data-depth="3"><a href="/blog/node-js/04.serverless/01#56-创建新房间"><span>5.6 创建新房间</span></a></li><li title="5.7 监听玩家进入" data-depth="3"><a href="/blog/node-js/04.serverless/01#57-监听玩家进入"><span>5.7 监听玩家进入</span></a></li><li title="5.8 越权更新字段" data-depth="3"><a href="/blog/node-js/04.serverless/01#58-越权更新字段"><span>5.8 越权更新字段</span></a></li><li title="5.9 落子更新逻辑" data-depth="3"><a href="/blog/node-js/04.serverless/01#59-落子更新逻辑"><span>5.9 落子更新逻辑</span></a></li><li title="5.10 监听远程棋盘更新" data-depth="3"><a href="/blog/node-js/04.serverless/01#510-监听远程棋盘更新"><span>5.10 监听远程棋盘更新</span></a></li><li title="5.11 游戏结束与退出" data-depth="3"><a href="/blog/node-js/04.serverless/01#511-游戏结束与退出"><span>5.11 游戏结束与退出</span></a></li><li title="6. 课程完整源码" data-depth="2"><a href="/blog/node-js/04.serverless/01#6-课程完整源码"><span>6. 课程完整源码</span></a></li><li title="7. 联系我们" data-depth="2"><a href="/blog/node-js/04.serverless/01#7-联系我们"><span>7. 联系我们</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h2 id="1-项目概述"><a aria-hidden="true" tabindex="-1" href="/blog/node-js/04.serverless/01#1-项目概述"><span class="icon icon-link"></span></a>1 项目概述</h2><p>游戏开发，尤其是微信小游戏开发，是最近几年比较热门的话题。</p><p>本次「云开发」公开课，将通过实战「在线对战五子棋」，一步步带领大家，在不借助后端的情况下，利用「小程序 ✖ 云开发」，独立完成一款微信小游戏的开发与上线。</p><h2 id="2-任务目标"><a aria-hidden="true" tabindex="-1" href="/blog/node-js/04.serverless/01#2-任务目标"><span class="icon icon-link"></span></a>2 任务目标</h2><p>根据项目初始框架，阅读教程的同时，逐步完成棋盘绘制、音乐播放、玩家对战、输赢判定等功能，最终实现一个可以快乐玩耍的在线对战五子棋。</p><p>在这个过程中，会了解到 Serverless 的一些概念，并且实际应用它们，比如：<strong>云数据库</strong>、<strong>云存储</strong>、<strong>云函数</strong>、<strong>增值能力</strong>。除了这些基本功能，还准备了更多的硬核概念与落地实践，比如：<strong>实时数据库</strong>、<strong>聚合搜索</strong>、<strong>权限控制</strong>。</p><p>完成开发后，上传并且设置为体验版，欢迎邀请更多人来体验。</p><h2 id="3-准备工作"><a aria-hidden="true" tabindex="-1" href="/blog/node-js/04.serverless/01#3-准备工作"><span class="icon icon-link"></span></a>3 准备工作</h2><p>从 <a target="_blank" rel="noopener noreferrer" href="https://github.com/TencentCloudBase/tcb-game-gomoku">TencentCloudBase/tcb-game-gomoku<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中下载代码到本地：</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">git</span><span class="token plain"> clone https://github.com/TencentCloudBase/tcb-game-gomoku.git</span></div><div class="token-line"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> tcb-game-gomoku/</span></div></pre></div><p>切换课程专用的 <code>minigame-study</code> 分支：</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">git</span><span class="token plain"> checkout minigame-study</span></div></pre></div><p>⚠️<code>minigame</code>分支保存着「小游戏版」的完整代码，<code>miniprogram</code>分支保存着「小程序版」的完整代码。</p><h2 id="4-游戏流程图"><a aria-hidden="true" tabindex="-1" href="/blog/node-js/04.serverless/01#4-游戏流程图"><span class="icon icon-link"></span></a>4 游戏流程图</h2><p>小游戏版本的核心放在了实时对战上，中间穿插应用了云开发的各个方面。如果想体验完整的流程与交互，请前往<a target="_blank" rel="noopener noreferrer" href="https://github.com/TencentCloudBase/tcb-game-gomoku/tree/miniprogram"><code>miniprogram</code>分支<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p><img src="https://github.com/TencentCloudBase/tcb-game-gomoku/raw/minigame/static/%E6%9E%B6%E6%9E%84%E5%9B%BE.jpg" alt=""/></p><h2 id="5-实战任务"><a aria-hidden="true" tabindex="-1" href="/blog/node-js/04.serverless/01#5-实战任务"><span class="icon icon-link"></span></a>5 实战任务</h2><h3 id="51-创建云开发与小游戏环境"><a aria-hidden="true" tabindex="-1" href="/blog/node-js/04.serverless/01#51-创建云开发与小游戏环境"><span class="icon icon-link"></span></a>5.1 创建云开发与小游戏环境</h3><p>1、打开微信 IDE，点击左侧的小游戏，选择右侧的导入项目，导入之前下载的「在线对战五子棋」的目录，AppID 修改为你已经注册好的小游戏 AppID。</p><p><img src="https://puui.qpic.cn/vupload/0/20190813_1565686430445_67dhgo46ds9.png/0" alt=""/></p><p>2、进入后，点击上方的云开发按钮。如果之前没有开通过云开发，需要开通云开发，新开通的话需要等待 10 ～ 20 分钟。</p><p><img src="https://puui.qpic.cn/vupload/0/20190813_1565686451687_pdl8t1onir.png/0" alt=""/></p><p>3、进入「云开发/数据库」，创建新的集合，新集合的名称是<code>rooms</code>。</p><p><img src="https://puui.qpic.cn/vupload/0/20190813_1565686465563_rx5zo815jmj.png/0" alt=""/></p><p>4、进入「云开发/存储」，点击“上传文件”。上传的内容是<code>/static/</code>下的<code>bgm.mp3</code> 和 <code>fall.mp3</code>。之后的代码中会通过云存储的接口，请求文件的临时 url，这样做的目的是<strong>减少用户首次进入游戏加载的静态资源</strong>。</p><p><img src="https://puui.qpic.cn/vupload/0/20190813_1565686476650_7pts6bn8fr.png/0" alt=""/></p><h3 id="52-准备配置文件"><a aria-hidden="true" tabindex="-1" href="/blog/node-js/04.serverless/01#52-准备配置文件"><span class="icon icon-link"></span></a>5.2 准备配置文件</h3><p>创建配置文件：</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">cp</span><span class="token plain"> miniprogram/shared/config.example.js miniprogram/shared/config.js</span></div></pre></div><p>将关键字段的信息，换成自己账号的信息即可：</p><p><img src="https://puui.qpic.cn/vupload/0/20190813_1565686524751_pxxe5yawz6m.png/0" alt=""/></p><h3 id="53-创建云开发接口"><a aria-hidden="true" tabindex="-1" href="/blog/node-js/04.serverless/01#53-创建云开发接口"><span class="icon icon-link"></span></a>5.3 创建云开发接口</h3><p>打开 <code>miniprogram/shared/cloud.js</code>，在里面初始化云开发能力，并且对外暴露云数据库以及聚合搜索的 API。</p><p><img src="https://puui.qpic.cn/vupload/0/20190813_1565686536274_yusm5uxcxab.png/0" alt=""/></p><h3 id="54-获取云存储资源的链接"><a aria-hidden="true" tabindex="-1" href="/blog/node-js/04.serverless/01#54-获取云存储资源的链接"><span class="icon icon-link"></span></a>5.4 获取云存储资源的链接</h3><p>为了减少用户首屏加载的静态资源，音乐资源并没有放在<code>miniprogram</code>目录下，而是放在了云存储中，通过调用云存储的 api 接口，来返回静态资源的临时链接。</p><p>在 <code>miniprogram/modules/music.js</code>中，会调用资源接口，获取资源链接：</p><p><img src="https://puui.qpic.cn/vupload/0/20190813_1565686547006_efn2rd6bu4f.png/0" alt=""/></p><p><code>getTempFileURL</code>函数属于云开发相关，因此放在了 <code>miniprogram/shared/cloud.js</code>中。这里只需要临时链接<code>tempFileURL</code>属性，其它返回值直接过滤调即可。</p><p>为了方便外面调用，promise 内部不再用 reject 抛错。对于错误异常，返回空字符串。这样，加载失败的资源不会影响正常资源的加载和 Promise.all 中逻辑进行。</p><p><img src="https://puui.qpic.cn/vupload/0/20190813_1565686556058_24v2t5tkr4c.png/0" alt=""/></p><h3 id="55-游戏进入与身份判断"><a aria-hidden="true" tabindex="-1" href="/blog/node-js/04.serverless/01#55-游戏进入与身份判断"><span class="icon icon-link"></span></a>5.5 游戏进入与身份判断</h3><p>根据前面的流程图我们可以看到，游戏玩家的身份是分为 owner 与 player。它们的含义如下：</p><ul><li>owner：玩家进入游戏后，查找是否有空闲房间，如果不存在空闲房间，那么就会主动创建新的空闲房间。那么对于新创建的房间，玩家就是 owner。</li><li>player：玩家进入游戏后，查找是否有空闲房间，如果存在空闲房间，那么就加入空闲房间。那么对于空闲房间，玩家就是 player。</li></ul><p>判断的依据就是 <code>judgeIdentity</code> 方法中，读取云数据库集合中的 rooms 的记录。如果存在多个空闲房间，需要选取创建时间最近的一个房间。因此，这里需要用到「聚合搜索」的逻辑。</p><p>聚合搜索的条件，在这里有 3 个：</p><ol><li>标记人数的字段，是否为 1</li><li>创建时间倒叙排序</li><li>只选择 1 个</li></ol><p><img src="https://puui.qpic.cn/vupload/0/20190813_1565686565847_3yze316092d.png/0" alt=""/></p><h3 id="56-创建新房间"><a aria-hidden="true" tabindex="-1" href="/blog/node-js/04.serverless/01#56-创建新房间"><span class="icon icon-link"></span></a>5.6 创建新房间</h3><p>在上述的身份判断函数逻辑中，如果聚合搜索查询的结果为空，说明没有空闲房间，玩家需要作为 owner 来创建新的房间，等待其它玩家加入。</p><p>创建房间的逻辑就是将约定好的字段，放进云数据库的记录中。这些字段有：</p><ul><li>roomid&lt;<code>String</code>&gt;: 6 位房间号，<strong>唯一</strong></li><li>nextcolor&lt;<code>&quot;white&quot; | &quot;black&quot;</code>&gt;: 下一步是白棋/黑棋走</li><li>chessmen&lt;<code>String</code>&gt;: 编码后的棋盘数据</li><li>createTimestamp&lt;<code>String</code>&gt;: 记录创建时间戳，精确到 ms</li><li>people&lt;<code>Number</code>&gt;: 房间人数</li></ul><p>是的，你可能注意到了，这里需要保证 roomid 是不重复的。因此本地生成的随机 roomid，需要先调用云数据库的查询接口，检测是否存在。如果存在，那么递归调用，重新生成随机字符串。</p><p><img src="https://puui.qpic.cn/vupload/0/20190813_1565686576953_tjr37rmv9ae.png/0" alt=""/></p><h3 id="57-监听玩家进入"><a aria-hidden="true" tabindex="-1" href="/blog/node-js/04.serverless/01#57-监听玩家进入"><span class="icon icon-link"></span></a>5.7 监听玩家进入</h3><p>对于 owner 身份来说，除了要创建新房间，还需要在创建后监听 player 身份的玩家进入游戏。</p><p>对于 player 身份的玩家进入游戏后，会更新记录中的 people 字段（1 =&gt; 2）。这时候就需要利用「实时数据库」的功能，监听远程记录的 people 字段变化。</p><p>代码实现上，调用<code>watch</code>方法，并且传递<code>onChange</code>函数参数。一旦有任何风吹草动，都可以在<code>onChange</code>回调函数中获得。对于传递给回调函数的参数，有两个比较重要：</p><ul><li>docChanges&lt;<code>Array</code>&gt;: 数组中的每一项对应每条记录的变化类型，变化类型有 init、update、delete 等。</li><li>docs&lt;<code>Array</code>&gt;: 数组中的每一项对应每条记录的当前数据。</li></ul><p><img src="https://puui.qpic.cn/vupload/0/20190813_1565686591306_os588ni3m8.png/0" alt=""/></p><h3 id="58-越权更新字段"><a aria-hidden="true" tabindex="-1" href="/blog/node-js/04.serverless/01#58-越权更新字段"><span class="icon icon-link"></span></a>5.8 越权更新字段</h3><p>对于 player 身份来说，进入房间后，既不需要「创建新房间」，也不需要「监听玩家进入」。但需要更新记录的 people 字段。由于记录是由 owner 身份的玩家创建的，而云数据库只有以下 4 种权限：</p><ul><li>所有用户可读，仅创建者可读写</li><li>仅创建者可读写</li><li>所有用户可读</li><li>所有用户不可读写</li></ul><p>以上 4 种权限，并没有「所有用户可读写」。因此，对于越权读写的情况，需要通过调用云函数来以“管理员”的权限实现。在 <code>cloudfunction</code> 中创建 <code>updateDoc</code> 云函数，接收前端传来的 collection、docid、data 字段。对于 data 字段来说，就是数据记录的最新更新数据。</p><p><img src="https://puui.qpic.cn/vupload/0/20190813_1565686600499_7jw2an2f8er.png/0" alt=""/></p><p>在小游戏中，通过<code>wx.cloud.callFunction</code>来调用云函数。传入的 data 字段指明被调用的云函数，传入的 data 字段可以在云函数的回调函数的 event 参数中访问到（如上图所示）。</p><p><img src="https://puui.qpic.cn/vupload/0/20190813_1565686609491_51yce50b2tf.png/0" alt=""/></p><h3 id="59-落子更新逻辑"><a aria-hidden="true" tabindex="-1" href="/blog/node-js/04.serverless/01#59-落子更新逻辑"><span class="icon icon-link"></span></a>5.9 落子更新逻辑</h3><p>不论对于 player 还是 owner 身份，都需要处理落子的逻辑。落子逻辑中，下面的两种情况是属于无效落子：</p><ol><li>点击位置已经有棋子</li><li>对方还未落子，目前依然处于等待情况</li></ol><p>对于以上两种情况，处理的逻辑分别是：</p><ol><li>棋盘状态保存在内部类中，调用落子的函数，会返回是否成功的字段标识</li><li>只有监听到远程棋盘更新后，才会打开本地的锁，允许落子；落子后，会重新上锁</li></ol><p><img src="https://puui.qpic.cn/vupload/0/20190813_1565686620401_gfziqov00gm.png/0" alt=""/></p><p>落子成功后，要在本地判断是否胜利。如果胜利，需要调用退出的逻辑。但无论是否胜利，都要将本地的最新状态更新到云端。</p><p><img src="https://puui.qpic.cn/vupload/0/20190813_1565686628911_zv5160zwrhb.png/0" alt=""/></p><h3 id="510-监听远程棋盘更新"><a aria-hidden="true" tabindex="-1" href="/blog/node-js/04.serverless/01#510-监听远程棋盘更新"><span class="icon icon-link"></span></a>5.10 监听远程棋盘更新</h3><p>不论对于 player 还是 owner 身份的玩家，都需要监听远程棋盘的更新逻辑。当远程棋盘字段更新时，本地根据最新的棋盘状态，重绘整个棋盘。并且进行输赢判定，如果可以判定输赢，则退出游戏；否则，打开本地的锁，玩家可以落子。</p><p><strong>因为不同身份均需要监听，因此这一块的监听逻辑可以复用</strong>。<strong>不同的是，两种身份的监听启动时间不一样</strong>。owner 身份需要等待 player 身份玩家进入游戏后才开启棋盘监听；player 身份是更新了 people 字段后，开启棋盘监听。</p><p>在监听逻辑中，需要判断远程更新的字段是否是 chessmen，这是通过前面提及的 dataType 来实现的。还徐哟啊判断记录中的 nextcolor 字段是否和本地的 color 一样，来决定是否打开本地的锁。</p><p><img src="https://puui.qpic.cn/vupload/0/20190813_1565686878918_0fvrbmcw7xw.png/0" alt=""/></p><p>如果上述的两个条件均满足，则执行更新本地棋盘、判定输赢、打开本地锁的逻辑。</p><p><img src="https://puui.qpic.cn/vupload/0/20190813_1565686968256_u9wfsb9tcjj.png/0" alt=""/></p><h3 id="511-游戏结束与退出"><a aria-hidden="true" tabindex="-1" href="/blog/node-js/04.serverless/01#511-游戏结束与退出"><span class="icon icon-link"></span></a>5.11 游戏结束与退出</h3><p>每次需要判定输赢的地方，如果可以判定输赢，那么都会走到游戏退出逻辑。退出的逻辑分为 2 个部分，第 1 个是给用户提示，第 2 个是调用云函数清空记录。</p><p>第 1 个逻辑中用户提示，需要判定用户胜负状态：</p><p><img src="https://puui.qpic.cn/vupload/0/20190813_1565686982496_8w7g8tn7owp.png/0" alt=""/></p><p>第 2 个逻辑中清除记录的原因是为了方便调试，对于真正的业务场景，一般不会删除历史数据，方便问题定位。同时，这也是一个越权操作，需要调用云函数来实现。</p><p><img src="https://puui.qpic.cn/vupload/0/20190813_1565686993095_7g1lsvvydsn.png/0" alt=""/></p><h2 id="6-课程完整源码"><a aria-hidden="true" tabindex="-1" href="/blog/node-js/04.serverless/01#6-课程完整源码"><span class="icon icon-link"></span></a>6. 课程完整源码</h2><p><a target="_blank" rel="noopener noreferrer" href="https://github.com/TencentCloudBase/tcb-game-gomoku">https://github.com/TencentCloudBase/tcb-game-gomoku<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h2 id="7-联系我们"><a aria-hidden="true" tabindex="-1" href="/blog/node-js/04.serverless/01#7-联系我们"><span class="icon icon-link"></span></a>7. 联系我们</h2><p>更多云开发使用技巧及 Serverless 行业动态，扫码关注我们~</p><p align="center"><img src="https://puui.qpic.cn/vupload/0/20190603_1559545575934_lettsbvkvdn.jpeg/0" width="200px"/></p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/src/NodeJS/04.Serverless/01.基于实时数据库-在线对战五子棋小游戏.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">9/4/2021 09:58:48</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog/umi.js"></script>
  </body>
</html>
