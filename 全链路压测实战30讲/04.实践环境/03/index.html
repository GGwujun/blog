<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog/umi.css" />
    <script>
      window.routerBase = "/blog";
    </script>
    <script>
      //! umi version: 3.5.17
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.indexOf(e) > -1 ? e : r[0]
        );
      })();
    </script>
    <title>23 | 压测平台：如何改造对象存储和性能监控？</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/全链路压测实战30讲/04.实践环境/03" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>计算机基础<ul><li><a href="/blog/编译原理之美">编译原理之美</a></li><li><a href="/blog/编译原理实战">编译原理实战</a></li><li><a href="/blog/深入浅出计算机组成原理">深入浅出计算机组成原理</a></li><li><a href="/blog/详解http">详解http</a></li><li><a href="/blog/计算机网络通关29讲">计算机网络通关29讲</a></li><li><a href="/blog/网络排查案例课">网络排查案例课</a></li><li><a href="/blog/linux操作系统">linux操作系统</a></li><li><a href="/blog/linux性能优化实战">linux性能优化实战</a></li><li><a href="/blog/程序员数学基础">程序员数学基础</a></li><li><a href="/blog/趣谈网络协议">趣谈网络协议</a></li><li><a href="/blog/操作系统实战">操作系统实战</a></li><li><a href="/blog/软件工程之美">软件工程之美</a></li><li><a href="/blog/sql必知必会">sql必知必会</a></li><li><a href="/blog/操作系统实战45讲">操作系统实战45讲</a></li><li><a href="/blog/网络编程实战">网络编程实战</a></li></ul></span><span>算法<ul><li><a href="/blog/常用算法25讲">常用算法25讲</a></li><li><a href="/blog/数据结构与算法之美">数据结构与算法之美</a></li><li><a href="/blog/业务开发算法50讲">业务开发算法50讲</a></li><li><a href="/blog/动态规划面试宝典">动态规划面试宝典</a></li></ul></span><span>前端开发<ul><li><a href="/blog/浏览器工作原理与实践">浏览器工作原理与实践</a></li><li><a href="/blog/新时代产品经理进阶之路">新时代产品经理进阶之路</a></li><li><a href="/blog/全栈工程师修炼指南">全栈工程师修炼指南</a></li><li><a href="/blog/flutter核心技术与实战">flutter核心技术与实战</a></li><li><a href="/blog/java-script核心原理解析">java-script核心原理解析</a></li><li><a href="/blog/说透低代码">说透低代码</a></li><li><a href="/blog/nodejs应用开发实战">nodejs应用开发实战</a></li><li><a href="/blog/反爬虫兵法演绎20讲">反爬虫兵法演绎20讲</a></li><li><a href="/blog/reactnative新架构实战课">reactnative新架构实战课</a></li><li><a href="/blog/正则表达式入门">正则表达式入门</a></li><li><a href="/blog/重学前端">重学前端</a></li><li><a href="/blog/serverless入门课">serverless入门课</a></li><li><a href="/blog/type-script入门实战笔记">type-script入门实战笔记</a></li><li><a href="/blog/图解googlev8">图解googlev8</a></li><li><a href="/blog/vue3源码分析">vue3源码分析</a></li><li><a href="/blog/玩转Vue3全家桶">玩转Vue3全家桶</a></li><li><a href="/blog/webassembly入门">webassembly入门</a></li><li><a href="/blog/手把手带你写一个Web框架">手把手带你写一个Web框架</a></li><li><a href="/blog/web漏洞挖掘实战">web漏洞挖掘实战</a></li><li><a href="/blog/跟月影学可视化">跟月影学可视化</a></li><li><a href="/blog/搞定音频技术">搞定音频技术</a></li><li><a href="/blog/攻克视频技术">攻克视频技术</a></li></ul></span><span>前端工程化<ul><li><a href="/blog/logger">logger</a></li><li><a href="/blog/webpack">webpack</a></li><li><a href="/blog/webpackChain">webpackChain</a></li></ul></span><span>前端性能优化<ul><li><a href="/blog/react性能调优">react性能调优</a></li></ul></span><span>软件测试<ul><li><a aria-current="page" class="active" href="/blog/全链路压测实战30讲">全链路压测实战30讲</a></li><li><a href="/blog/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog/自动化测试高手课">自动化测试高手课</a></li><li><a href="/blog/软件测试52讲">软件测试52讲</a></li></ul></span><span>面试<ul><li><a href="/blog/面试现场">面试现场</a></li></ul></span><span>杂谈<ul><li><a href="/blog/超级访谈对话张雪峰">超级访谈对话张雪峰</a></li><li><a href="/blog/Git实战手册">Git实战手册</a></li><li><a href="/blog/NodeJS">NodeJS</a></li><li><a href="/blog/ReactJS">ReactJS</a></li><li><a href="/blog/UI设计">UI设计</a></li><li><a href="/blog/webpack4系列教程">webpack4系列教程</a></li><li><a href="/blog/前端知识体系">前端知识体系</a></li><li><a href="/blog/剑指offer刷题笔记">剑指offer刷题笔记</a></li><li><a href="/blog/思考与成长">思考与成长</a></li><li><a href="/blog/设计模式手册">设计模式手册</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>计算机基础<ul><li><a href="/blog/编译原理之美">编译原理之美</a></li><li><a href="/blog/编译原理实战">编译原理实战</a></li><li><a href="/blog/深入浅出计算机组成原理">深入浅出计算机组成原理</a></li><li><a href="/blog/详解http">详解http</a></li><li><a href="/blog/计算机网络通关29讲">计算机网络通关29讲</a></li><li><a href="/blog/网络排查案例课">网络排查案例课</a></li><li><a href="/blog/linux操作系统">linux操作系统</a></li><li><a href="/blog/linux性能优化实战">linux性能优化实战</a></li><li><a href="/blog/程序员数学基础">程序员数学基础</a></li><li><a href="/blog/趣谈网络协议">趣谈网络协议</a></li><li><a href="/blog/操作系统实战">操作系统实战</a></li><li><a href="/blog/软件工程之美">软件工程之美</a></li><li><a href="/blog/sql必知必会">sql必知必会</a></li><li><a href="/blog/操作系统实战45讲">操作系统实战45讲</a></li><li><a href="/blog/网络编程实战">网络编程实战</a></li></ul></li><li>算法<ul><li><a href="/blog/常用算法25讲">常用算法25讲</a></li><li><a href="/blog/数据结构与算法之美">数据结构与算法之美</a></li><li><a href="/blog/业务开发算法50讲">业务开发算法50讲</a></li><li><a href="/blog/动态规划面试宝典">动态规划面试宝典</a></li></ul></li><li>前端开发<ul><li><a href="/blog/浏览器工作原理与实践">浏览器工作原理与实践</a></li><li><a href="/blog/新时代产品经理进阶之路">新时代产品经理进阶之路</a></li><li><a href="/blog/全栈工程师修炼指南">全栈工程师修炼指南</a></li><li><a href="/blog/flutter核心技术与实战">flutter核心技术与实战</a></li><li><a href="/blog/java-script核心原理解析">java-script核心原理解析</a></li><li><a href="/blog/说透低代码">说透低代码</a></li><li><a href="/blog/nodejs应用开发实战">nodejs应用开发实战</a></li><li><a href="/blog/反爬虫兵法演绎20讲">反爬虫兵法演绎20讲</a></li><li><a href="/blog/reactnative新架构实战课">reactnative新架构实战课</a></li><li><a href="/blog/正则表达式入门">正则表达式入门</a></li><li><a href="/blog/重学前端">重学前端</a></li><li><a href="/blog/serverless入门课">serverless入门课</a></li><li><a href="/blog/type-script入门实战笔记">type-script入门实战笔记</a></li><li><a href="/blog/图解googlev8">图解googlev8</a></li><li><a href="/blog/vue3源码分析">vue3源码分析</a></li><li><a href="/blog/玩转Vue3全家桶">玩转Vue3全家桶</a></li><li><a href="/blog/webassembly入门">webassembly入门</a></li><li><a href="/blog/手把手带你写一个Web框架">手把手带你写一个Web框架</a></li><li><a href="/blog/web漏洞挖掘实战">web漏洞挖掘实战</a></li><li><a href="/blog/跟月影学可视化">跟月影学可视化</a></li><li><a href="/blog/搞定音频技术">搞定音频技术</a></li><li><a href="/blog/攻克视频技术">攻克视频技术</a></li></ul></li><li>前端工程化<ul><li><a href="/blog/logger">logger</a></li><li><a href="/blog/webpack">webpack</a></li><li><a href="/blog/webpackChain">webpackChain</a></li></ul></li><li>前端性能优化<ul><li><a href="/blog/react性能调优">react性能调优</a></li></ul></li><li>软件测试<ul><li><a aria-current="page" class="active" href="/blog/全链路压测实战30讲">全链路压测实战30讲</a></li><li><a href="/blog/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog/自动化测试高手课">自动化测试高手课</a></li><li><a href="/blog/软件测试52讲">软件测试52讲</a></li></ul></li><li>面试<ul><li><a href="/blog/面试现场">面试现场</a></li></ul></li><li>杂谈<ul><li><a href="/blog/超级访谈对话张雪峰">超级访谈对话张雪峰</a></li><li><a href="/blog/Git实战手册">Git实战手册</a></li><li><a href="/blog/NodeJS">NodeJS</a></li><li><a href="/blog/ReactJS">ReactJS</a></li><li><a href="/blog/UI设计">UI设计</a></li><li><a href="/blog/webpack4系列教程">webpack4系列教程</a></li><li><a href="/blog/前端知识体系">前端知识体系</a></li><li><a href="/blog/剑指offer刷题笔记">剑指offer刷题笔记</a></li><li><a href="/blog/思考与成长">思考与成长</a></li><li><a href="/blog/设计模式手册">设计模式手册</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog/全链路压测实战30讲">全链路压测实战30讲</a></li><li><a href="/blog/全链路压测实战30讲/01.开篇词">01.开篇词</a><ul><li><a href="/blog/全链路压测实战30讲/01.开篇词/01"><span>开篇词 | 打破认知神话，做接地气的全链路压测</span></a></li></ul></li><li><a href="/blog/全链路压测实战30讲/02.核心理论">02.核心理论</a><ul><li><a href="/blog/全链路压测实战30讲/02.核心理论/01"><span>01 | 全链路压测：为什么很多测试人员迷信它？</span></a></li><li><a href="/blog/全链路压测实战30讲/02.核心理论/02"><span>02 | RESAR 全链路流程：如何搞定所有容量场景？</span></a></li></ul></li><li><a href="/blog/全链路压测实战30讲/03.实践需求">03.实践需求</a><ul><li><a href="/blog/全链路压测实战30讲/03.实践需求/01"><span>03 | 压测方案：你是否忽略了一个重量级文档？</span></a></li><li><a href="/blog/全链路压测实战30讲/03.实践需求/02"><span>04 | 核心链路：如何梳理符合真实业务场景的核心链路？</span></a></li><li><a href="/blog/全链路压测实战30讲/03.实践需求/03"><span>05 | 铺底数据：真实的压测数据应该做成什么样子？</span></a></li><li><a href="/blog/全链路压测实战30讲/03.实践需求/04"><span>06 | 流量构建：流量平台如何选型？</span></a></li><li><a href="/blog/全链路压测实战30讲/03.实践需求/05"><span>07 | 全栈监控：如何设计全栈监控策略？</span></a></li><li><a href="/blog/全链路压测实战30讲/03.实践需求/06"><span>08 | 基础设施：全链路压测的环境有什么特点？</span></a></li><li><a href="/blog/全链路压测实战30讲/03.实践需求/07"><span>09 | 压测模型：如何建立一套完整的全链路压测模型？</span></a></li><li><a href="/blog/全链路压测实战30讲/03.实践需求/08"><span>10 | 场景执行：压测执行过程中的关键步骤是什么？</span></a></li><li><a href="/blog/全链路压测实战30讲/03.实践需求/09"><span>11 | 链路追踪：如何选择一款适合自己项目的工具？</span></a></li><li><a href="/blog/全链路压测实战30讲/03.实践需求/10"><span>12 | 链路追踪：如何对一个具体的项目进行追踪改造？</span></a></li><li><a href="/blog/全链路压测实战30讲/03.实践需求/11"><span>13 | 标记透传：微服务系统如何做标记透传方案选型？</span></a></li><li><a href="/blog/全链路压测实战30讲/03.实践需求/12"><span>14 | 标记透传：如何基于微服务技术进行标记透传？</span></a></li><li><a href="/blog/全链路压测实战30讲/03.实践需求/13"><span>15 | 流量隔离：MySQL数据库隔离是怎么做的？</span></a></li><li><a href="/blog/全链路压测实战30讲/03.实践需求/14"><span>16 | 流量隔离：Redis 缓存隔离是怎么做的？</span></a></li><li><a href="/blog/全链路压测实战30讲/03.实践需求/15"><span>17 | 流量隔离：MongoDB 数据库隔离是怎么做的？</span></a></li><li><a href="/blog/全链路压测实战30讲/03.实践需求/16"><span>18 | 流量隔离：RabbitMQ 消息隔离是怎么做的？</span></a></li><li><a href="/blog/全链路压测实战30讲/03.实践需求/17"><span>19｜日志隔离：如何落地日志隔离？</span></a></li><li><a href="/blog/全链路压测实战30讲/03.实践需求/18"><span>20 | Mock：如何屏蔽第三方接口的影响？</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog/全链路压测实战30讲/04.实践环境">04.实践环境</a><ul><li><a href="/blog/全链路压测实战30讲/04.实践环境/01"><span>21 | 压测平台：高效搭建 GoReplay 压测平台</span></a></li><li><a href="/blog/全链路压测实战30讲/04.实践环境/02"><span>22 | 压测平台：如何解决 GoReplay 动态数据关联？</span></a></li><li><a aria-current="page" class="active" href="/blog/全链路压测实战30讲/04.实践环境/03"><span>23 | 压测平台：如何改造对象存储和性能监控？</span></a></li><li><a href="/blog/全链路压测实战30讲/04.实践环境/04"><span>24 | 压测平台：如何改造分布式调度平台？</span></a></li><li><a href="/blog/全链路压测实战30讲/04.实践环境/05"><span>25 | 环境搭建：我们的系统是怎么搭建起来的？</span></a></li><li><a href="/blog/全链路压测实战30讲/04.实践环境/06"><span>26 | 全局监控（上）：如何快速落地全局监控？</span></a></li><li><a href="/blog/全链路压测实战30讲/04.实践环境/07"><span>27 | 全局监控（下）：如何快速落地全局监控？</span></a></li><li><a href="/blog/全链路压测实战30讲/04.实践环境/08"><span>28 | 定向监控：怎样快速发现业务异常？</span></a></li></ul></li><li><a href="/blog/全链路压测实战30讲/05.实践性能场景执行">05.实践性能场景执行</a><ul><li><a href="/blog/全链路压测实战30讲/05.实践性能场景执行/01"><span>29 | 基准场景：一个案例，带你搞懂基准场景的关键要点</span></a></li><li><a href="/blog/全链路压测实战30讲/05.实践性能场景执行/02"><span>30 | 预压测：如何基于小流量快速验证容量压测效果？</span></a></li><li><a href="/blog/全链路压测实战30讲/05.实践性能场景执行/03"><span>31 | 容量场景：决定线上容量场景的关键因素是什么？</span></a></li><li><a href="/blog/全链路压测实战30讲/05.实践性能场景执行/04"><span>32 | 稳定性场景：怎样搞定线上稳定性场景？</span></a></li><li><a href="/blog/全链路压测实战30讲/05.实践性能场景执行/05"><span>33 | 异常场景：如何模拟线上不同组件的异常场景？</span></a></li><li><a href="/blog/全链路压测实战30讲/05.实践性能场景执行/06"><span>34 | 容量规划：如何精准地对生产系统做容量预估？</span></a></li></ul></li><li><a href="/blog/全链路压测实战30讲/06.性能结果报告">06.性能结果报告</a><ul><li><a href="/blog/全链路压测实战30讲/06.性能结果报告/01"><span>35 | 压测报告：怎样写出一份让老板满意的报告？</span></a></li></ul></li><li><a href="/blog/全链路压测实战30讲/07.结束语">07.结束语</a><ul><li><a href="/blog/全链路压测实战30讲/07.结束语/01"><span>结束语 | 做能落地的全链路压测项目</span></a></li><li><a href="/blog/全链路压测实战30讲/07.结束语/02"><span>期末考试 |《全链路压测实战30讲》满分试卷，等你来挑战！</span></a></li></ul></li><li><a href="/blog/全链路压测实战30讲/summary">全链路压测实战30讲</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="对象存储" data-depth="2"><a href="/blog/全链路压测实战30讲/04.实践环境/03#对象存储"><span>对象存储</span></a></li><li title="性能监控" data-depth="2"><a href="/blog/全链路压测实战30讲/04.实践环境/03#性能监控"><span>性能监控</span></a></li><li title="总结" data-depth="2"><a href="/blog/全链路压测实战30讲/04.实践环境/03#总结"><span>总结</span></a></li><li title="课后题" data-depth="2"><a href="/blog/全链路压测实战30讲/04.实践环境/03#课后题"><span>课后题</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="23--压测平台如何改造对象存储和性能监控"><a aria-hidden="true" tabindex="-1" href="/blog/全链路压测实战30讲/04.实践环境/03#23--压测平台如何改造对象存储和性能监控"><span class="icon icon-link"></span></a>23 | 压测平台：如何改造对象存储和性能监控？</h1><p>你好，我是高楼。</p><p>这节课我们来聊聊如何改造分布式压测平台。</p><p>在第 6 讲，我们已经详细了解了流量工具的选型，我们一起来回顾下全链路流量平台必须具备的能力：</p><ol><li>能录制线上真实流量；</li><li>能实现海量数据的并发请求，并覆盖地域性的 CDN 边缘节点；</li><li>能支持常见协议的请求；</li><li>对线上尽量应用透明，也就是说无侵入性；</li><li>避免写请求的脏数据，压测流量能够被识别，方便压测后清理；</li><li>工具使用简单，能够满足压测实时监控，服务安全保护（过载熔断）。</li></ol><p>按照上面这几条能力需求，我还画了一个比较典型的全链路流量平台架构设计图。</p><p><img src="https://static001.geekbang.org/resource/image/71/82/713cb37c39316091a6b6e987cb83c382.jpg?wh=1920x1715" alt="图片"/></p><p>在这张架构图中，我把压测平台分为压测 web 管理端、调度服务、压测引擎、监控服务、对象存储、录制服务六大模块。这样的一个全链路流量平台基本上就可以覆盖大部分企业的需求了。</p><p>接下来，我会就这里面部分的技术细节进行拆解。因为内容比较多，我会分成两节课讲解。这节课，我们主要看一下对象存储和性能监控模块如何落地。</p><h2 id="对象存储"><a aria-hidden="true" tabindex="-1" href="/blog/全链路压测实战30讲/04.实践环境/03#对象存储"><span class="icon icon-link"></span></a>对象存储</h2><p>对象存储简单来说就是一种海量、安全、低成本、高可靠的云存储服务，适合存放任意类型的文件。它还支持快速查询、上传下载等功能。通俗来说就是一个文件仓库。</p><p>现在大部分的公有云厂商，都提供了自己的对象存储服务，比如阿里云的OSS、华为云的OBS，腾讯云的COS等，我们只需集成云厂商提供的SDK即可访问。而开源产品方面，比较常见的有 Ceph 和 <a target="_blank" rel="noopener noreferrer" href="http://www.minio.org.cn/overview.shtml#">MinIO<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>其中，Ceph是一个比较强大的分布式存储系统，但是它整个系统非常复杂，比较重量级，需要花费大力气去维护，很显然与我们的目标不是很符合，所以暂时不考虑。</p><p>而MinIO是一个基于Apache License V2.0开源协议的高性能、分布式的对象存储系统，而且兼容亚马逊S3云存储服务，非常适合存储大容量非结构化的数据，比如图片、视频、日志文件等。而且MinIO系统较为轻量级，可以很简单地和其它的应用结合，很显然，气质和我们的流量平台比较符合。</p><p>总而言之，如果想自建对象存储服务，而且有能力、规模又比较大的话，采用 Ceph 更好一点。但是我们只是想要一个对象存储，要求没有那么多，所以我们才选择了 MinIO。它的整体结构图如下：</p><p><img src="https://static001.geekbang.org/resource/image/e5/3c/e5500bd1ed32efe787f09d7c51d05d3c.jpg?wh=843x912" alt=""/></p><p>我们设计的上传文件的大致流程你可以看看下面这张图：</p><p><img src="https://static001.geekbang.org/resource/image/4a/46/4a304423ee40dbc8110646679e4c9f46.jpg?wh=1347x1564" alt="图片"/></p><p>知道了大致的流程，接下来看看我们如何落地。</p><ul><li>搭建 MinIO Server</li></ul><p>这里，为了方便调试，我们使用Docker快速搭建 MinIO Server，并设置端口号、容器名。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">docker run -d --name minio-server \</span></div><div class="token-line"><span class="token plain">    -p 9000:9000 \</span></div><div class="token-line"><span class="token plain">    -p 9001:9001 \</span></div><div class="token-line"><span class="token plain">    minio/minio server /data \</span></div><div class="token-line"><span class="token plain">    --console-address &quot;:9001&quot;</span></div></pre></div><p>如果你希望集成到k8s，还可以使用Operator方式搭建MinIO Server，具体方法可以参考<a target="_blank" rel="noopener noreferrer" href="http://docs.minio.org.cn/minio/k8s/deployment/deploy-minio-operator.html">官网文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>启动成功后，访问MinIO的IP地址，因为我的 MinIO Server 安装在本机，所以是 <a target="_blank" rel="noopener noreferrer" href="http://localhost:9001/">http://localhost:9001<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，输入默认的账号密码是 minioadmin/minioadmin。</p><p><img src="https://static001.geekbang.org/resource/image/6a/85/6a99f51224acf674c7464463efc70385.png?wh=1918x1034" alt="图片"/></p><p>登录后，进入控制台看板页。</p><p><img src="https://static001.geekbang.org/resource/image/11/74/11feff640cc83593f32de5f0bf3c8074.png?wh=1500x769" alt="图片"/></p><p>好了，搭建完 MinIO Server 之后，我们就需要实现自己的对象存储 HTTP服务了。</p><ul><li>通过 SpringBoot 实现 HTTP 服务</li></ul><p>因为项目使用的是 SpringBoot 应用，所以这里主要演示通过 SpringBoot 实现的 HTTP 服务。</p><p>首先， 在 pom.xml中 添加 MinIO 的相关依赖：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;!--MinIO JAVA SDK--&gt;</span></div><div class="token-line"><span class="token plain">    &lt;dependency&gt;</span></div><div class="token-line"><span class="token plain">        &lt;groupId&gt;io.minio&lt;/groupId&gt;</span></div><div class="token-line"><span class="token plain">        &lt;artifactId&gt;minio&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">        &lt;version&gt;3.0.10&lt;/version&gt;</span></div><div class="token-line"><span class="token plain">    &lt;/dependency&gt;</span></div></pre></div><p>第二步，在 SpringBoot 中开启文件上传功能，在 application.yml 中添加如下配置：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">spring:</span></div><div class="token-line"><span class="token plain">      servlet:</span></div><div class="token-line"><span class="token plain">        multipart:</span></div><div class="token-line"><span class="token plain">          enabled: true #开启文件上传</span></div><div class="token-line"><span class="token plain">          max-file-size: 10MB #限制文件上传大小为10M</span></div></pre></div><p>然后，添加一个 MinioController 控制器用于实现文件的上传、下载、删除操作：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">package com.dunshan.controller;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    import com.google.api.client.util.IOUtils;</span></div><div class="token-line"><span class="token plain">    import com.dunshan.common.api.CommonResult;</span></div><div class="token-line"><span class="token plain">    import com.dunshan.dto.MinioUploadDto;</span></div><div class="token-line"><span class="token plain">    import io.minio.MinioClient;</span></div><div class="token-line"><span class="token plain">    import io.minio.policy.PolicyType;</span></div><div class="token-line"><span class="token plain">    import io.swagger.annotations.Api;</span></div><div class="token-line"><span class="token plain">    import io.swagger.annotations.ApiOperation;</span></div><div class="token-line"><span class="token plain">    import org.slf4j.Logger;</span></div><div class="token-line"><span class="token plain">    import org.slf4j.LoggerFactory;</span></div><div class="token-line"><span class="token plain">    import org.springframework.beans.factory.annotation.Value;</span></div><div class="token-line"><span class="token plain">    import org.springframework.stereotype.Controller;</span></div><div class="token-line"><span class="token plain">    import org.springframework.web.bind.annotation.RequestMapping;</span></div><div class="token-line"><span class="token plain">    import org.springframework.web.bind.annotation.RequestMethod;</span></div><div class="token-line"><span class="token plain">    import org.springframework.web.bind.annotation.RequestParam;</span></div><div class="token-line"><span class="token plain">    import org.springframework.web.bind.annotation.ResponseBody;</span></div><div class="token-line"><span class="token plain">    import org.springframework.web.multipart.MultipartFile;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    import javax.servlet.http.HttpServletResponse;</span></div><div class="token-line"><span class="token plain">    import java.io.InputStream;</span></div><div class="token-line"><span class="token plain">    import java.io.OutputStream;</span></div><div class="token-line"><span class="token plain">    import java.net.URLEncoder;</span></div><div class="token-line"><span class="token plain">    import java.text.SimpleDateFormat;</span></div><div class="token-line"><span class="token plain">    import java.util.Date;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    /**</span></div><div class="token-line"><span class="token plain">     * Created by dunshan on 2019/12/25.</span></div><div class="token-line"><span class="token plain">     */</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    @Api(tags = &quot;MinioController&quot;, description = &quot;MinIO对象存储管理&quot;)</span></div><div class="token-line"><span class="token plain">    @Controller</span></div><div class="token-line"><span class="token plain">    @RequestMapping(&quot;/minio&quot;)</span></div><div class="token-line"><span class="token plain">    public class MinioController {</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        private static final Logger LOGGER = LoggerFactory.getLogger(MinioController.class);</span></div><div class="token-line"><span class="token plain">        @Value(&quot;${minio.endpoint}&quot;)</span></div><div class="token-line"><span class="token plain">        private String ENDPOINT;</span></div><div class="token-line"><span class="token plain">        @Value(&quot;${minio.bucketName}&quot;)</span></div><div class="token-line"><span class="token plain">        private String BUCKET_NAME;</span></div><div class="token-line"><span class="token plain">        @Value(&quot;${minio.accessKey}&quot;)</span></div><div class="token-line"><span class="token plain">        private String ACCESS_KEY;</span></div><div class="token-line"><span class="token plain">        @Value(&quot;${minio.secretKey}&quot;)</span></div><div class="token-line"><span class="token plain">        private String SECRET_KEY;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        @ApiOperation(&quot;文件上传&quot;)</span></div><div class="token-line"><span class="token plain">        @RequestMapping(value = &quot;/upload&quot;, method = RequestMethod.POST)</span></div><div class="token-line"><span class="token plain">        @ResponseBody</span></div><div class="token-line"><span class="token plain">        public CommonResult upload(@RequestParam(&quot;file&quot;) MultipartFile file) {</span></div><div class="token-line"><span class="token plain">            try {</span></div><div class="token-line"><span class="token plain">                //创建一个MinIO的Java客户端</span></div><div class="token-line"><span class="token plain">                MinioClient minioClient = new MinioClient(ENDPOINT, ACCESS_KEY, SECRET_KEY);</span></div><div class="token-line"><span class="token plain">                boolean isExist = minioClient.bucketExists(BUCKET_NAME);</span></div><div class="token-line"><span class="token plain">                if (isExist) {</span></div><div class="token-line"><span class="token plain">                    LOGGER.info(&quot;存储桶已经存在！&quot;);</span></div><div class="token-line"><span class="token plain">                } else {</span></div><div class="token-line"><span class="token plain">                    //创建存储桶并设置只读权限</span></div><div class="token-line"><span class="token plain">                    minioClient.makeBucket(BUCKET_NAME);</span></div><div class="token-line"><span class="token plain">                    minioClient.setBucketPolicy(BUCKET_NAME, &quot;*.*&quot;, PolicyType.READ_ONLY);</span></div><div class="token-line"><span class="token plain">                }</span></div><div class="token-line"><span class="token plain">                String filename = file.getOriginalFilename();</span></div><div class="token-line"><span class="token plain">                SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyyMMdd&quot;);</span></div><div class="token-line"><span class="token plain">                // 设置存储对象名称</span></div><div class="token-line"><span class="token plain">                String objectName = sdf.format(new Date()) + &quot;/&quot; + filename;</span></div><div class="token-line"><span class="token plain">                // 使用putObject上传一个文件到存储桶中</span></div><div class="token-line"><span class="token plain">                minioClient.putObject(BUCKET_NAME, objectName, file.getInputStream(), file.getContentType());</span></div><div class="token-line"><span class="token plain">                LOGGER.info(&quot;文件上传成功!&quot;);</span></div><div class="token-line"><span class="token plain">                MinioUploadDto minioUploadDto = new MinioUploadDto();</span></div><div class="token-line"><span class="token plain">                minioUploadDto.setName(filename);</span></div><div class="token-line"><span class="token plain">                minioUploadDto.setUrl(ENDPOINT + &quot;/&quot; + BUCKET_NAME + &quot;/&quot; + objectName);</span></div><div class="token-line"><span class="token plain">                return CommonResult.success(minioUploadDto);</span></div><div class="token-line"><span class="token plain">            } catch (Exception e) {</span></div><div class="token-line"><span class="token plain">                LOGGER.info(&quot;上传发生错误: {}！&quot;, e.getMessage());</span></div><div class="token-line"><span class="token plain">            }</span></div><div class="token-line"><span class="token plain">            return CommonResult.failed();</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        @ApiOperation(&quot;文件删除&quot;)</span></div><div class="token-line"><span class="token plain">        @RequestMapping(value = &quot;/delete&quot;, method = RequestMethod.POST)</span></div><div class="token-line"><span class="token plain">        @ResponseBody</span></div><div class="token-line"><span class="token plain">        public CommonResult delete(@RequestParam(&quot;objectName&quot;) String objectName) {</span></div><div class="token-line"><span class="token plain">            try {</span></div><div class="token-line"><span class="token plain">                MinioClient minioClient = new MinioClient(ENDPOINT, ACCESS_KEY, SECRET_KEY);</span></div><div class="token-line"><span class="token plain">                minioClient.removeObject(BUCKET_NAME, objectName);</span></div><div class="token-line"><span class="token plain">                return CommonResult.success(null);</span></div><div class="token-line"><span class="token plain">            } catch (Exception e) {</span></div><div class="token-line"><span class="token plain">                e.printStackTrace();</span></div><div class="token-line"><span class="token plain">            }</span></div><div class="token-line"><span class="token plain">            return CommonResult.failed();</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">        </span></div><div class="token-line"><span class="token plain">        @ApiOperation(&quot;文件下载&quot;)</span></div><div class="token-line"><span class="token plain">        @RequestMapping(value = &quot;/download&quot;, method = RequestMethod.GET)</span></div><div class="token-line"><span class="token plain">        @ResponseBody</span></div><div class="token-line"><span class="token plain">        public CommonResult download(@RequestParam(&quot;filename&quot;) String filename, HttpServletResponse httpResponse) {</span></div><div class="token-line"><span class="token plain">            try {</span></div><div class="token-line"><span class="token plain">                MinioClient minioClient = new MinioClient(ENDPOINT, ACCESS_KEY, SECRET_KEY);</span></div><div class="token-line"><span class="token plain">                InputStream inputStream= minioClient.getObject(BUCKET_NAME, filename);</span></div><div class="token-line"><span class="token plain">                httpResponse.reset();</span></div><div class="token-line"><span class="token plain">                httpResponse.setHeader(&quot;Content-Disposition&quot;, &quot;attachment;filename=&quot; + URLEncoder.encode(filename, &quot;UTF-8&quot;));</span></div><div class="token-line"><span class="token plain">                httpResponse.setContentType(&quot;application/octet-stream&quot;);</span></div><div class="token-line"><span class="token plain">                httpResponse.setCharacterEncoding(&quot;utf-8&quot;);</span></div><div class="token-line"><span class="token plain">                OutputStream outputStream = httpResponse.getOutputStream();</span></div><div class="token-line"><span class="token plain">                IOUtils.copy(inputStream, outputStream);</span></div><div class="token-line"><span class="token plain">                outputStream.close();</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            } catch (Exception e) {</span></div><div class="token-line"><span class="token plain">                LOGGER.info(&quot;导出失败：&quot;, e.getMessage());</span></div><div class="token-line"><span class="token plain">                e.printStackTrace();</span></div><div class="token-line"><span class="token plain">            }</span></div><div class="token-line"><span class="token plain">            return null;</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>最后，在 application.yml 中对 MinIO 客户端进行配置：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain"># MinIO对象存储相关配置</span></div><div class="token-line"><span class="token plain">    minio:</span></div><div class="token-line"><span class="token plain">      endpoint: http://127.0.0.1:9000 #MinIO服务所在地址</span></div><div class="token-line"><span class="token plain">      bucketName: goreplay #存储桶名称</span></div><div class="token-line"><span class="token plain">      accessKey: minioadmin #访问的key</span></div><div class="token-line"><span class="token plain">      secretKey: minioadmin #访问的秘钥</span></div></pre></div><ul><li>接口测试</li></ul><p>接下来我们启动 SpringBoot 应用，使用 Postman 来测试验证一下功能。</p><p>首先，访问上传接口，进行文件上传。上传接口的地址是：<a target="_blank" rel="noopener noreferrer" href="http://localhost:8080/minio/upload">http://localhost:8080/minio/upload<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p><img src="https://static001.geekbang.org/resource/image/97/91/97d28bf2379590a77357f5513d681d91.png?wh=1500x897" alt="图片"/></p><p>上传完成后，我们打开 MinIO 的管理界面，可以看到上传后的文件。</p><p><img src="https://static001.geekbang.org/resource/image/4b/e7/4b4eca50dd7546ee1c2f9653f16419e7.png?wh=1500x831" alt="图片"/></p><p>我们还可以调用删除接口来删除其中某文件，需要注意的是，objectName 参数值是存储桶（Buckets）中的文件相对路径，删除文件接口地址：<a target="_blank" rel="noopener noreferrer" href="http://localhost:8080/minio/delete">http://localhost:8080/minio/delete<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p><img src="https://static001.geekbang.org/resource/image/57/3d/574acaf12f603b89a23e88a8a542593d.png?wh=1500x924" alt="图片"/></p><p>最后，我们还可以调用下载接口来下载文件，下载文件接口地址：<a target="_blank" rel="noopener noreferrer" href="http://localhost:8080/minio/download">http://localhost:8080/minio/download<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p><img src="https://static001.geekbang.org/resource/image/32/yy/32c6a4a957d88e00254f4a1c71f3dcyy.png?wh=1500x731" alt="图片"/></p><p>导出文件时填好文件名称，选择 <strong>send and download</strong>按钮就可以在 Postman 中下载文件了。</p><p>好了，到这里，我们的对象存储服务就改造完成了，这样，我们流量仓库的功能也就差不多实现了。</p><h2 id="性能监控"><a aria-hidden="true" tabindex="-1" href="/blog/全链路压测实战30讲/04.实践环境/03#性能监控"><span class="icon icon-link"></span></a>性能监控</h2><p>接下来，我们要对 GoReplay 性能监控进行改造。</p><ul><li>GoReplay 统计请求队列信息</li></ul><p>前面我们讲过， GoReplay 通过参数：-stats --out-http-stats 在控制台将统计的发送请求队列信息默认每 5 秒输出到控制台。</p><p>下面是参数 --stats --output-http-stats 的说明：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">--stats  //打开输出队列的状态</span></div><div class="token-line"><span class="token plain">            Turn on queue stats output</span></div><div class="token-line"><span class="token plain">    -output-http-stats  //每5秒钟输出一次输出队列的状态</span></div><div class="token-line"><span class="token plain">            Report http output queue stats to console every N milliseconds. See output-http-stats-ms</span></div><div class="token-line"><span class="token plain">    -output-http-stats-ms int</span></div><div class="token-line"><span class="token plain">            Report http output queue stats to console every N milliseconds. default: 5000 (default 5000)</span></div></pre></div><p>统计并发送请求队列信息的核心代码主要会用到下面两个函数。</p><p>我们用 <a target="_blank" rel="noopener noreferrer" href="https://github.com/buger/goreplay/blob/master/output_http.go">output_http.go<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 实现统计信息收集：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// PluginWrite writes message to this plugin</span></div><div class="token-line"><span class="token plain">    // 统计信息收集</span></div><div class="token-line"><span class="token plain">    func (o *HTTPOutput) PluginWrite(msg *Message) (n int, err error) {</span></div><div class="token-line"><span class="token plain">    	if !isRequestPayload(msg.Meta) {</span></div><div class="token-line"><span class="token plain">    		return len(msg.Data), nil</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    	select {</span></div><div class="token-line"><span class="token plain">    	case &lt;-o.stop:</span></div><div class="token-line"><span class="token plain">    		return 0, ErrorStopped</span></div><div class="token-line"><span class="token plain">    	case o.queue &lt;- msg:</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    	if o.config.Stats {</span></div><div class="token-line"><span class="token plain">    		o.queueStats.Write(len(o.queue))</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	if len(o.queue) &gt; 0 {</span></div><div class="token-line"><span class="token plain">    		// try to start a new worker to serve</span></div><div class="token-line"><span class="token plain">    		if atomic.LoadInt32(&amp;o.activeWorkers) &lt; int32(o.config.WorkersMax) {</span></div><div class="token-line"><span class="token plain">    			go o.startWorker()</span></div><div class="token-line"><span class="token plain">    			atomic.AddInt32(&amp;o.activeWorkers, 1)</span></div><div class="token-line"><span class="token plain">    		}</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	return len(msg.Data) + len(msg.Meta), nil</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p><a target="_blank" rel="noopener noreferrer" href="https://github.com/buger/goreplay/blob/master/gor_stat.go">gor_stat.go<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 类中用 NewGorStat 函数构造统计：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// NewGorStat统计函数</span></div><div class="token-line"><span class="token plain">    func NewGorStat(statName string, rateMs int) (s *GorStat) {</span></div><div class="token-line"><span class="token plain">    	s = new(GorStat)</span></div><div class="token-line"><span class="token plain">    	s.statName = statName</span></div><div class="token-line"><span class="token plain">    	s.rateMs = rateMs</span></div><div class="token-line"><span class="token plain">    	s.latest = 0</span></div><div class="token-line"><span class="token plain">    	s.mean = 0</span></div><div class="token-line"><span class="token plain">    	s.max = 0</span></div><div class="token-line"><span class="token plain">    	s.count = 0</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    	if Settings.Stats {</span></div><div class="token-line"><span class="token plain">    		go s.reportStats()</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	return</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>控制台输出的发送请求队列信息是这样的：</p><p><img src="https://static001.geekbang.org/resource/image/fa/f2/fab6fb7d04705d0c47cfb639e34769f2.png?wh=547x357" alt="图片"/></p><p>其中，倒数第二列等同于当前的TPS，但是这就是仅有的统计项了。如果想要更复杂的测试统计结果，就需要我们自己去埋点丰富监控指标了。</p><ul><li>GoReplay 埋点思路</li></ul><p>在前面的课程中，我们已经选用了Exporter+Prometheus+Grafana作为我们全局的监控解决方案了，这里我们能不能把 GoReplay 的 Metrics 实时接入进来呢？</p><p>事实上是可以做到的。</p><p>我们先来看看 node_exporter+Prometheus+Grafana套件的运行效果：</p><p><img src="https://static001.geekbang.org/resource/image/60/68/6048c0f6a90cf1ae1b0f4d67f1425168.png?wh=1842x873" alt="图片"/></p><p>Prometheus 提供了 <a target="_blank" rel="noopener noreferrer" href="https://github.com/prometheus/client_golang">官方版 Golang 库<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ，用于采集并暴露监控数据。我们只需要埋点，让 GoReplay 支持实时 Metrics 统计就可以了。这样，在 GoReplay 执行流量回放时，我们就可以实时采集TPS和响应时间等各项压测指标了，另外，结合 Grafana 看板还可以做到图形可视化展示。</p><p>既然我们要去 GoReplay 埋点，那么就得知道去哪里埋，对吧？所以我们得先分析源码，找出 GoReplay 发出请求的代码，理清 GoReplay 埋点的思路。</p><p>在用 GoReplay 进行流量回放时，我们主要使用的是HTTP输出的插件<a target="_blank" rel="noopener noreferrer" href="https://github.com/buger/goreplay/blob/master/output_http.go">output_http.go<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 。它通过实现 HTTP 协议， 进而实现 io.Writer 接口，最后根据配置注册到 Plugin.outputs 队列里。</p><p>在<a target="_blank" rel="noopener noreferrer" href="https://github.com/buger/goreplay/blob/master/output_http.go">output_http.go<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中， NewHTTPOutput 是默认初始化函数：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// NewHTTPOutput constructor for HTTPOutput</span></div><div class="token-line"><span class="token plain">    // Initialize workers</span></div><div class="token-line"><span class="token plain">    func NewHTTPOutput(address string, config *HTTPOutputConfig) PluginReadWriter {</span></div><div class="token-line"><span class="token plain">    	o := new(HTTPOutput)</span></div><div class="token-line"><span class="token plain">    	var err error</span></div><div class="token-line"><span class="token plain">    	config.url, err = url.Parse(address)</span></div><div class="token-line"><span class="token plain">    	if err != nil {</span></div><div class="token-line"><span class="token plain">    		log.Fatal(fmt.Sprintf(&quot;[OUTPUT-HTTP] parse HTTP output URL error[%q]&quot;, err))</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	if config.url.Scheme == &quot;&quot; {</span></div><div class="token-line"><span class="token plain">    		config.url.Scheme = &quot;http&quot;</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	config.rawURL = config.url.String()</span></div><div class="token-line"><span class="token plain">    	if config.Timeout &lt; time.Millisecond*100 {</span></div><div class="token-line"><span class="token plain">    		config.Timeout = time.Second</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	if config.BufferSize &lt;= 0 {</span></div><div class="token-line"><span class="token plain">    		config.BufferSize = 100 * 1024 // 100kb</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	if config.WorkersMin &lt;= 0 {</span></div><div class="token-line"><span class="token plain">    		config.WorkersMin = 1</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	if config.WorkersMin &gt; 1000 {</span></div><div class="token-line"><span class="token plain">    		config.WorkersMin = 1000</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	if config.WorkersMax &lt;= 0 {</span></div><div class="token-line"><span class="token plain">    		config.WorkersMax = math.MaxInt32 // idealy so large</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	if config.WorkersMax &lt; config.WorkersMin {</span></div><div class="token-line"><span class="token plain">    		config.WorkersMax = config.WorkersMin</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	if config.QueueLen &lt;= 0 {</span></div><div class="token-line"><span class="token plain">    		config.QueueLen = 1000</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	if config.RedirectLimit &lt; 0 {</span></div><div class="token-line"><span class="token plain">    		config.RedirectLimit = 0</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	if config.WorkerTimeout &lt;= 0 {</span></div><div class="token-line"><span class="token plain">    		config.WorkerTimeout = time.Second * 2</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	o.config = config</span></div><div class="token-line"><span class="token plain">    	o.stop = make(chan bool)</span></div><div class="token-line"><span class="token plain">    	//是否收集统计信息，统计输出间隔是多少</span></div><div class="token-line"><span class="token plain">    	if o.config.Stats {</span></div><div class="token-line"><span class="token plain">    		o.queueStats = NewGorStat(&quot;output_http&quot;, o.config.StatsMs)</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    	o.queue = make(chan *Message, o.config.QueueLen)</span></div><div class="token-line"><span class="token plain">    	if o.config.TrackResponses {</span></div><div class="token-line"><span class="token plain">    		o.responses = make(chan *response, o.config.QueueLen)</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	// it should not be buffered to avoid races</span></div><div class="token-line"><span class="token plain">    	o.stopWorker = make(chan struct{})</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    	if o.config.ElasticSearch != &quot;&quot; {</span></div><div class="token-line"><span class="token plain">    		o.elasticSearch = new(ESPlugin)</span></div><div class="token-line"><span class="token plain">    		o.elasticSearch.Init(o.config.ElasticSearch)</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	o.client = NewHTTPClient(o.config)</span></div><div class="token-line"><span class="token plain">    	o.activeWorkers += int32(o.config.WorkersMin)</span></div><div class="token-line"><span class="token plain">    	for i := 0; i &lt; o.config.WorkersMin; i++ {</span></div><div class="token-line"><span class="token plain">    		go o.startWorker()</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	go o.workerMaster()</span></div><div class="token-line"><span class="token plain">    	return o</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>初始化配置后，启动 HttpClient 网络库：</p><p><img src="https://static001.geekbang.org/resource/image/dc/34/dc34079b07eece4b32370b950a687f34.png?wh=620x438" alt="图片"/></p><p>紧接着，HttpClient 会启动多个发送请求协程：</p><p><img src="https://static001.geekbang.org/resource/image/e8/38/e81f619ff63648f6b4aa34f1fee52038.png?wh=616x767" alt="图片"/></p><p>HttpClient 执行请求发送：</p><p><img src="https://static001.geekbang.org/resource/image/81/c3/817fb12cae9c908672dca0a340c754c3.png?wh=1173x849" alt="图片"/></p><p>我们可以看看HttpClient 发送请求的细节，下面这张图中，我圈出的内容是各种配置的生效点：</p><p><img src="https://static001.geekbang.org/resource/image/24/e6/2453ee30abf8f331d086d156c84afde6.png?wh=1165x950" alt="图片"/></p><p>为了对<a target="_blank" rel="noopener noreferrer" href="https://github.com/buger/goreplay/blob/master/output_http.go">output_http.go<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 有一个更清晰的理解，你可以看看下面这张核心代码逻辑调用图：</p><p><img src="https://static001.geekbang.org/resource/image/c6/c5/c66dcecb6e3148274b13b1810d2d5cc5.png?wh=1419x964" alt="图片"/></p><p>好了，搞懂了 GoReplay 发出请求的逻辑，接下来，我们就需要具体埋点了。</p><ul><li>GoReplay 实现埋点</li></ul><p>我们之所以要埋点，主要是为了实现获取请求的状态码以及对应的 TPS，然后在获取请求返回值的位置插入对应的 Metric。</p><p>在此之前，我们先要了解 Prometheus 中常见的四大指标类型：</p><ul><li>Counter（计数器）：一个递增的计数器，只增不减，但是它可以被重置为0（例如重启服务）。常用于需要记录请求次数、错误数量的场景；</li><li>Gauge（仪表盘）：可以用它来表示一个可以任意变化的浮动值，可增可减。常用于反馈当前情况的场景；</li><li>Histogram（累积直方图）：多用于需要统计一些数据分布的情况。它可以计算在一定范围内的分布情况，同时还提供了度量指标值的总和。常用于记录请求延迟、响应大小等统计场景；</li><li>Summary（摘要）：在一段时间范围内对数据进行采样，和 Histogram 累积直方图比较类似，主要用于计算在一定时间窗口范围内，度量指标对象的总数以及所有度量指标值的总和。</li></ul><p>更多内容你可以参考 <a target="_blank" rel="noopener noreferrer" href="https://prometheus.io/docs/instrumenting/writing_clientlibs/#counter">Prometheus官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>了解了基础概念，我们就来看看要怎么在 GoReplay 中进行改造。</p><p>第一步，通过 go get 命令来安装相关依赖库，示例如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">go get github.com/prometheus/client_golang/prometheus/promhttp</span></div></pre></div><p>有关全面的 API 文档，你可以参考 Prometheus 的各种 Go 库的 <a target="_blank" rel="noopener noreferrer" href="https://godoc.org/github.com/prometheus/client_golang">GoDoc<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 文档。</p><p>第二步，创建 prometheus_family.go 类，初始化监控 Metric。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">package metrics</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    import &quot;github.com/prometheus/client_golang/prometheus&quot;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    // 创建 Prometheus 数据Metric, 就相当于SQL 数据库 声明table</span></div><div class="token-line"><span class="token plain">    var (</span></div><div class="token-line"><span class="token plain">    	//Counter（计数器）</span></div><div class="token-line"><span class="token plain">    	totalRequestsCounter = prometheus.NewCounterVec(</span></div><div class="token-line"><span class="token plain">    		prometheus.CounterOpts{</span></div><div class="token-line"><span class="token plain">    			Name: &quot;goreplay_total_requests&quot;,</span></div><div class="token-line"><span class="token plain">    			Help: &quot;total income requests&quot;,</span></div><div class="token-line"><span class="token plain">    		},</span></div><div class="token-line"><span class="token plain">    		[]string{&quot;location&quot;, &quot;code&quot;},</span></div><div class="token-line"><span class="token plain">    	)</span></div><div class="token-line"><span class="token plain">    	//Counter (计数器)</span></div><div class="token-line"><span class="token plain">    	subRequestsCounter = prometheus.NewCounterVec(</span></div><div class="token-line"><span class="token plain">    		prometheus.CounterOpts{</span></div><div class="token-line"><span class="token plain">    			Name: &quot;test_sub_requests&quot;,</span></div><div class="token-line"><span class="token plain">    			Help: &quot;sub requests&quot;,</span></div><div class="token-line"><span class="token plain">    		},</span></div><div class="token-line"><span class="token plain">    		[]string{&quot;test&quot;},</span></div><div class="token-line"><span class="token plain">    	)</span></div><div class="token-line"><span class="token plain">    	//Gauge（仪表盘）</span></div><div class="token-line"><span class="token plain">    	circuitBreakerRateGauge = prometheus.NewGaugeVec(</span></div><div class="token-line"><span class="token plain">    		prometheus.GaugeOpts{</span></div><div class="token-line"><span class="token plain">    			Name: &quot;goreplay_circuit_breaker_rate&quot;,</span></div><div class="token-line"><span class="token plain">    			Help: &quot;rate of circuit breaker&quot;,</span></div><div class="token-line"><span class="token plain">    		},</span></div><div class="token-line"><span class="token plain">    		[]string{&quot;location&quot;, &quot;code&quot;},</span></div><div class="token-line"><span class="token plain">    	)</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    	buckets = []float64{0, 100, 200}</span></div><div class="token-line"><span class="token plain">    	// Histogram(累积直方图)</span></div><div class="token-line"><span class="token plain">    	totalRequestsTimeHistogram = prometheus.NewHistogramVec(</span></div><div class="token-line"><span class="token plain">    		prometheus.HistogramOpts{</span></div><div class="token-line"><span class="token plain">    			Name:    &quot;goreplay_total_requests_time&quot;,</span></div><div class="token-line"><span class="token plain">    			Help:    &quot;income requests time&quot;,</span></div><div class="token-line"><span class="token plain">    			Buckets: buckets,</span></div><div class="token-line"><span class="token plain">    		},</span></div><div class="token-line"><span class="token plain">    		[]string{&quot;location&quot;},</span></div><div class="token-line"><span class="token plain">    	)</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    )</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    // 注册定义好的Metric 相当于执行SQL create table 语句</span></div><div class="token-line"><span class="token plain">    func init() {</span></div><div class="token-line"><span class="token plain">    	prometheus.MustRegister(totalRequestsCounter)</span></div><div class="token-line"><span class="token plain">    	prometheus.MustRegister(subRequestsCounter)</span></div><div class="token-line"><span class="token plain">    	prometheus.MustRegister(circuitBreakerRateGauge)</span></div><div class="token-line"><span class="token plain">    	prometheus.MustRegister(totalRequestsTimeHistogram)</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    func IncreaseTotalRequests(location,code string) {</span></div><div class="token-line"><span class="token plain">    	totalRequestsCounter.With(prometheus.Labels{&quot;location&quot;: location, &quot;code&quot;: code}).Add(1)</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    func IncreaseSubRequests() {</span></div><div class="token-line"><span class="token plain">    	subRequestsCounter.With(prometheus.Labels{}).Add(1)</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    func ObserveTotalRequestsTimeHistogram(location string, d float64) {</span></div><div class="token-line"><span class="token plain">    	totalRequestsTimeHistogram.With(prometheus.Labels{&quot;location&quot;: location}).Observe(d)</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>这里，我在项目中创建了 package metrics，初始化了 API 请求相关的 Metric，并且注册到了github.com/prometheus/client_golang/prometheus 。</p><p>第三步，改造 output_http.go 类，在业务代码中采集数据。</p><p><img src="https://static001.geekbang.org/resource/image/fb/cb/fb287c1e977bb01f2c111897bf36f4cb.png?wh=1500x1734" alt="图片"/></p><p>从这张截图可以看到，我们为了获取请求状态码以及对应的TPS，在获取请求返回值的位置插入了counter metric；为了获取不同请求的响应时间等指标，我们还需要在发出请求前记录开始时间，待请求返回后记录结束时间，同时还要记录时间消耗的 Histogram Metric。</p><p>这里大家可以举一反三，扩展其它的 Metric。</p><p>第四步，改造 main.go ，进行 Metric 注册，提供/metric 接口给 Prometheus TSDB 时序数据库收集数据。</p><p><img src="https://static001.geekbang.org/resource/image/cc/b4/cc4c813da3f554a6cd84290a94ed19b4.png?wh=1500x1427" alt="图片"/></p><p>第五步，重新编译 GoReplay 程序。</p><p>在代码所在目录（./src/goreplay）下使用 go build 命令。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">go build</span></div></pre></div><p>第六步，在启动 GoReplay 进行流量回放时，查看监听端口，可以看到我们注册的端口 28081，访问接口：<a target="_blank" rel="noopener noreferrer" href="http://localhost:28081/metrics">http://localhost:28081/metrics<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">。......</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # HELP goreplay_total_requests total income requests</span></div><div class="token-line"><span class="token plain">    # TYPE goreplay_total_requests counter</span></div><div class="token-line"><span class="token plain">    goreplay_total_requests{code=&quot;200 &quot;,location=&quot;&quot;} 22</span></div><div class="token-line"><span class="token plain">    # HELP goreplay_total_requests_time income requests time</span></div><div class="token-line"><span class="token plain">    # TYPE goreplay_total_requests_time histogram</span></div><div class="token-line"><span class="token plain">    goreplay_total_requests_time_bucket{location=&quot;&quot;,le=&quot;0&quot;} 0</span></div><div class="token-line"><span class="token plain">    goreplay_total_requests_time_bucket{location=&quot;&quot;,le=&quot;100&quot;} 22</span></div><div class="token-line"><span class="token plain">    goreplay_total_requests_time_bucket{location=&quot;&quot;,le=&quot;200&quot;} 22</span></div><div class="token-line"><span class="token plain">    goreplay_total_requests_time_bucket{location=&quot;&quot;,le=&quot;+Inf&quot;} 22</span></div><div class="token-line"><span class="token plain">    goreplay_total_requests_time_sum{location=&quot;&quot;} 2.1513923769999996</span></div><div class="token-line"><span class="token plain">    goreplay_total_requests_time_count{location=&quot;&quot;} 22</span></div><div class="token-line"><span class="token plain">    # HELP promhttp_metric_handler_requests_in_flight Current number of scrapes being served.</span></div><div class="token-line"><span class="token plain">    # TYPE promhttp_metric_handler_requests_in_flight gauge</span></div><div class="token-line"><span class="token plain">    promhttp_metric_handler_requests_in_flight 1</span></div><div class="token-line"><span class="token plain">    # HELP promhttp_metric_handler_requests_total Total number of scrapes by HTTP status code.</span></div><div class="token-line"><span class="token plain">    # TYPE promhttp_metric_handler_requests_total counter</span></div><div class="token-line"><span class="token plain">    promhttp_metric_handler_requests_total{code=&quot;200&quot;} 20</span></div><div class="token-line"><span class="token plain">    promhttp_metric_handler_requests_total{code=&quot;500&quot;} 0</span></div><div class="token-line"><span class="token plain">    promhttp_metric_handler_requests_total{code=&quot;503&quot;} 0</span></div></pre></div><p>第七步，在Prometheus 主程序中拉取采集数据。</p><p>在Prometheus主程序的配置文件中填写第四步的API接口信息，这样，Prometheus TSDB 时序数据库就可以开始定时收集 Metric 数据了。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">###################### GoReolay ######################</span></div><div class="token-line"><span class="token plain">    - job_name: &quot;GoReolays5&quot;</span></div><div class="token-line"><span class="token plain">      static_configs:</span></div><div class="token-line"><span class="token plain">      - targets: [&#x27;172.31.184.225:28081&#x27;]</span></div><div class="token-line"><span class="token plain">        labels:</span></div><div class="token-line"><span class="token plain">          instance: s5</span></div></pre></div><p>第八步，在 Grafana 做图形数据展示。</p><p>Prometheus 提供了一种功能表达式语言 PromQL，这种语言可以允许用户实时选择和汇聚时间序列数据。另外，表达式的结果可以在结合 Grafana 的控件中显示为图形，也可以显示为表格数据，或者由外部系统通过 HTTP API 调用，因为篇幅有限，网上关于这部分的资料又很多，这里我就不多说了。</p><p>到这里，我们对 GoReplay 的埋点改造工作就做完了，通过 Metric 实现了从客户端统计压测过程中的各项指标。</p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="/blog/全链路压测实战30讲/04.实践环境/03#总结"><span class="icon icon-link"></span></a>总结</h2><p>好，这节课就讲到这里。</p><p>刚才，我们介绍了流量平台的对象存储和性能监控功能的选型及改造，我还对这两个部分做了详细的演示。通过结合 MinIO Server 和 HTTP 服务，我们可以实现程序二进制包、执行器 jar 包、流量文件等文件管理，并能够使用通用的 HTTP 上传下载功能。另外，通过 Prometheus 在GoReplay 埋点，我们还进一步丰富了性能监控指标。</p><p>在当前的全链路压测的市场中，对全链路压测工具的分布式改造总是讳忌莫深的部分，而压力工具对全链路压测来说，目标是能够实现足够的流量即可。从本节课的内容可以看到，相比传统的压力工具，全链路压测工具在改造上的技术成本还算是高的，但值得欣慰的是开源的工具也是完全可以实现的。</p><p>下一节课，我们将继续讲解分布式改造的各环节，我会通过案例给你演示怎样进行分布式调度改造工作。</p><h2 id="课后题"><a aria-hidden="true" tabindex="-1" href="/blog/全链路压测实战30讲/04.实践环境/03#课后题"><span class="icon icon-link"></span></a>课后题</h2><p>学完这节课，请你思考两个问题：</p><ol><li>你有没有做过 Prometheus 埋点，谈谈你对业务埋点的一些心得吧！</li><li>相比文件系统，你觉得对象存储的优势在什么地方？</li></ol><p>欢迎你在留言区与我交流讨论。当然了，你也可以把这节课分享给你身边的朋友，他们的一些想法或许会让你有更大的收获。我们下节课见！</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/docs/全链路压测实战30讲/04.实践环境/03.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">5/2/2022 10:57:05</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog/umi.js"></script>
  </body>
</html>
