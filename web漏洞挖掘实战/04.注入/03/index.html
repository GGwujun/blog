<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog/umi.css" />
    <script>
      window.routerBase = "/blog";
    </script>
    <script>
      //! umi version: 3.5.17
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.indexOf(e) > -1 ? e : r[0]
        );
      })();
    </script>
    <title>14｜自动化注入神器（一）：sqlmap的设计思路解析</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/web漏洞挖掘实战/04.注入/03" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>计算机基础<ul><li><a href="/blog/编译原理之美">编译原理之美</a></li><li><a href="/blog/编译原理实战">编译原理实战</a></li><li><a href="/blog/深入浅出计算机组成原理">深入浅出计算机组成原理</a></li><li><a href="/blog/详解http">详解http</a></li><li><a href="/blog/计算机网络通关29讲">计算机网络通关29讲</a></li><li><a href="/blog/网络排查案例课">网络排查案例课</a></li><li><a href="/blog/linux操作系统">linux操作系统</a></li><li><a href="/blog/linux性能优化实战">linux性能优化实战</a></li><li><a href="/blog/程序员数学基础">程序员数学基础</a></li><li><a href="/blog/趣谈网络协议">趣谈网络协议</a></li><li><a href="/blog/操作系统实战">操作系统实战</a></li><li><a href="/blog/软件工程之美">软件工程之美</a></li><li><a href="/blog/sql必知必会">sql必知必会</a></li><li><a href="/blog/操作系统实战45讲">操作系统实战45讲</a></li><li><a href="/blog/网络编程实战">网络编程实战</a></li></ul></span><span>算法<ul><li><a href="/blog/常用算法25讲">常用算法25讲</a></li><li><a href="/blog/数据结构与算法之美">数据结构与算法之美</a></li><li><a href="/blog/业务开发算法50讲">业务开发算法50讲</a></li><li><a href="/blog/动态规划面试宝典">动态规划面试宝典</a></li></ul></span><span>前端开发<ul><li><a href="/blog/浏览器工作原理与实践">浏览器工作原理与实践</a></li><li><a href="/blog/新时代产品经理进阶之路">新时代产品经理进阶之路</a></li><li><a href="/blog/全栈工程师修炼指南">全栈工程师修炼指南</a></li><li><a href="/blog/flutter核心技术与实战">flutter核心技术与实战</a></li><li><a href="/blog/java-script核心原理解析">java-script核心原理解析</a></li><li><a href="/blog/说透低代码">说透低代码</a></li><li><a href="/blog/nodejs应用开发实战">nodejs应用开发实战</a></li><li><a href="/blog/反爬虫兵法演绎20讲">反爬虫兵法演绎20讲</a></li><li><a href="/blog/reactnative新架构实战课">reactnative新架构实战课</a></li><li><a href="/blog/正则表达式入门">正则表达式入门</a></li><li><a href="/blog/重学前端">重学前端</a></li><li><a href="/blog/serverless入门课">serverless入门课</a></li><li><a href="/blog/type-script入门实战笔记">type-script入门实战笔记</a></li><li><a href="/blog/图解googlev8">图解googlev8</a></li><li><a href="/blog/vue3源码分析">vue3源码分析</a></li><li><a href="/blog/玩转Vue3全家桶">玩转Vue3全家桶</a></li><li><a href="/blog/webassembly入门">webassembly入门</a></li><li><a href="/blog/手把手带你写一个Web框架">手把手带你写一个Web框架</a></li><li><a aria-current="page" class="active" href="/blog/web漏洞挖掘实战">web漏洞挖掘实战</a></li><li><a href="/blog/跟月影学可视化">跟月影学可视化</a></li><li><a href="/blog/搞定音频技术">搞定音频技术</a></li><li><a href="/blog/攻克视频技术">攻克视频技术</a></li></ul></span><span>前端工程化<ul><li><a href="/blog/logger">logger</a></li><li><a href="/blog/webpack">webpack</a></li><li><a href="/blog/webpackChain">webpackChain</a></li></ul></span><span>前端性能优化<ul><li><a href="/blog/react性能调优">react性能调优</a></li></ul></span><span>软件测试<ul><li><a href="/blog/全链路压测实战30讲">全链路压测实战30讲</a></li><li><a href="/blog/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog/自动化测试高手课">自动化测试高手课</a></li><li><a href="/blog/软件测试52讲">软件测试52讲</a></li></ul></span><span>面试<ul><li><a href="/blog/面试现场">面试现场</a></li></ul></span><span>杂谈<ul><li><a href="/blog/超级访谈对话张雪峰">超级访谈对话张雪峰</a></li><li><a href="/blog/Git实战手册">Git实战手册</a></li><li><a href="/blog/NodeJS">NodeJS</a></li><li><a href="/blog/ReactJS">ReactJS</a></li><li><a href="/blog/UI设计">UI设计</a></li><li><a href="/blog/webpack4系列教程">webpack4系列教程</a></li><li><a href="/blog/前端知识体系">前端知识体系</a></li><li><a href="/blog/剑指offer刷题笔记">剑指offer刷题笔记</a></li><li><a href="/blog/思考与成长">思考与成长</a></li><li><a href="/blog/设计模式手册">设计模式手册</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>计算机基础<ul><li><a href="/blog/编译原理之美">编译原理之美</a></li><li><a href="/blog/编译原理实战">编译原理实战</a></li><li><a href="/blog/深入浅出计算机组成原理">深入浅出计算机组成原理</a></li><li><a href="/blog/详解http">详解http</a></li><li><a href="/blog/计算机网络通关29讲">计算机网络通关29讲</a></li><li><a href="/blog/网络排查案例课">网络排查案例课</a></li><li><a href="/blog/linux操作系统">linux操作系统</a></li><li><a href="/blog/linux性能优化实战">linux性能优化实战</a></li><li><a href="/blog/程序员数学基础">程序员数学基础</a></li><li><a href="/blog/趣谈网络协议">趣谈网络协议</a></li><li><a href="/blog/操作系统实战">操作系统实战</a></li><li><a href="/blog/软件工程之美">软件工程之美</a></li><li><a href="/blog/sql必知必会">sql必知必会</a></li><li><a href="/blog/操作系统实战45讲">操作系统实战45讲</a></li><li><a href="/blog/网络编程实战">网络编程实战</a></li></ul></li><li>算法<ul><li><a href="/blog/常用算法25讲">常用算法25讲</a></li><li><a href="/blog/数据结构与算法之美">数据结构与算法之美</a></li><li><a href="/blog/业务开发算法50讲">业务开发算法50讲</a></li><li><a href="/blog/动态规划面试宝典">动态规划面试宝典</a></li></ul></li><li>前端开发<ul><li><a href="/blog/浏览器工作原理与实践">浏览器工作原理与实践</a></li><li><a href="/blog/新时代产品经理进阶之路">新时代产品经理进阶之路</a></li><li><a href="/blog/全栈工程师修炼指南">全栈工程师修炼指南</a></li><li><a href="/blog/flutter核心技术与实战">flutter核心技术与实战</a></li><li><a href="/blog/java-script核心原理解析">java-script核心原理解析</a></li><li><a href="/blog/说透低代码">说透低代码</a></li><li><a href="/blog/nodejs应用开发实战">nodejs应用开发实战</a></li><li><a href="/blog/反爬虫兵法演绎20讲">反爬虫兵法演绎20讲</a></li><li><a href="/blog/reactnative新架构实战课">reactnative新架构实战课</a></li><li><a href="/blog/正则表达式入门">正则表达式入门</a></li><li><a href="/blog/重学前端">重学前端</a></li><li><a href="/blog/serverless入门课">serverless入门课</a></li><li><a href="/blog/type-script入门实战笔记">type-script入门实战笔记</a></li><li><a href="/blog/图解googlev8">图解googlev8</a></li><li><a href="/blog/vue3源码分析">vue3源码分析</a></li><li><a href="/blog/玩转Vue3全家桶">玩转Vue3全家桶</a></li><li><a href="/blog/webassembly入门">webassembly入门</a></li><li><a href="/blog/手把手带你写一个Web框架">手把手带你写一个Web框架</a></li><li><a aria-current="page" class="active" href="/blog/web漏洞挖掘实战">web漏洞挖掘实战</a></li><li><a href="/blog/跟月影学可视化">跟月影学可视化</a></li><li><a href="/blog/搞定音频技术">搞定音频技术</a></li><li><a href="/blog/攻克视频技术">攻克视频技术</a></li></ul></li><li>前端工程化<ul><li><a href="/blog/logger">logger</a></li><li><a href="/blog/webpack">webpack</a></li><li><a href="/blog/webpackChain">webpackChain</a></li></ul></li><li>前端性能优化<ul><li><a href="/blog/react性能调优">react性能调优</a></li></ul></li><li>软件测试<ul><li><a href="/blog/全链路压测实战30讲">全链路压测实战30讲</a></li><li><a href="/blog/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog/自动化测试高手课">自动化测试高手课</a></li><li><a href="/blog/软件测试52讲">软件测试52讲</a></li></ul></li><li>面试<ul><li><a href="/blog/面试现场">面试现场</a></li></ul></li><li>杂谈<ul><li><a href="/blog/超级访谈对话张雪峰">超级访谈对话张雪峰</a></li><li><a href="/blog/Git实战手册">Git实战手册</a></li><li><a href="/blog/NodeJS">NodeJS</a></li><li><a href="/blog/ReactJS">ReactJS</a></li><li><a href="/blog/UI设计">UI设计</a></li><li><a href="/blog/webpack4系列教程">webpack4系列教程</a></li><li><a href="/blog/前端知识体系">前端知识体系</a></li><li><a href="/blog/剑指offer刷题笔记">剑指offer刷题笔记</a></li><li><a href="/blog/思考与成长">思考与成长</a></li><li><a href="/blog/设计模式手册">设计模式手册</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog/web漏洞挖掘实战">web漏洞挖掘实战</a></li><li><a href="/blog/web漏洞挖掘实战/01.课前必读">01.课前必读</a><ul><li><a href="/blog/web漏洞挖掘实战/01.课前必读/01"><span>开篇词｜从黑客的视角找漏洞，从安全的角度优雅coding</span></a></li><li><a href="/blog/web漏洞挖掘实战/01.课前必读/02"><span>导读｜解读OWASP Top10 2021</span></a></li></ul></li><li><a href="/blog/web漏洞挖掘实战/02.失效的访问控制">02.失效的访问控制</a><ul><li><a href="/blog/web漏洞挖掘实战/02.失效的访问控制/01"><span>01｜失效的访问控制：攻击者如何获取其他用户信息？</span></a></li><li><a href="/blog/web漏洞挖掘实战/02.失效的访问控制/02"><span>02｜路径穿越：你的Web应用系统成了攻击者的资源管理器？</span></a></li><li><a href="/blog/web漏洞挖掘实战/02.失效的访问控制/03"><span>03 | 敏感数据泄露：攻击者如何获取用户账户？</span></a></li><li><a href="/blog/web漏洞挖掘实战/02.失效的访问控制/04"><span>04｜权限不合理：攻击者进来就是root权限？</span></a></li><li><a href="/blog/web漏洞挖掘实战/02.失效的访问控制/05"><span>05｜CSRF：为什么用户的操作他自己不承认？</span></a></li></ul></li><li><a href="/blog/web漏洞挖掘实战/03.加密失败">03.加密失败</a><ul><li><a href="/blog/web漏洞挖掘实战/03.加密失败/01"><span>06｜加密失败：使用了加密算法也会被破解吗？</span></a></li><li><a href="/blog/web漏洞挖掘实战/03.加密失败/02"><span>07｜弱编码：程序之间的沟通语言安全吗？</span></a></li><li><a href="/blog/web漏洞挖掘实战/03.加密失败/03"><span>08｜数字证书：攻击者可以伪造证书吗？</span></a></li><li><a href="/blog/web漏洞挖掘实战/03.加密失败/04"><span>09｜密码算法问题：数学知识如何提高代码可靠性？</span></a></li><li><a href="/blog/web漏洞挖掘实战/03.加密失败/05"><span>10｜弱随机数生成器：攻击者如何预测随机数？</span></a></li><li><a href="/blog/web漏洞挖掘实战/03.加密失败/06"><span>11｜忘记加“盐”：加密结果强度不够吗？</span></a></li><li><a href="/blog/web漏洞挖掘实战/03.加密失败/07"><span>大咖助场｜数字证书，困境与未来</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog/web漏洞挖掘实战/04.注入">04.注入</a><ul><li><a href="/blog/web漏洞挖掘实战/04.注入/01"><span>12｜注入（上）：SQL注入起手式</span></a></li><li><a href="/blog/web漏洞挖掘实战/04.注入/02"><span>13｜注入（下）：SQL注入技战法及相关安全实践</span></a></li><li><a aria-current="page" class="active" href="/blog/web漏洞挖掘实战/04.注入/03"><span>14｜自动化注入神器（一）：sqlmap的设计思路解析</span></a></li><li><a href="/blog/web漏洞挖掘实战/04.注入/04"><span>15｜自动化注入神器（二）：sqlmap的设计架构解析</span></a></li><li><a href="/blog/web漏洞挖掘实战/04.注入/05"><span>16｜自动化注入神器（三）：sqlmap的核心实现拆解</span></a></li><li><a href="/blog/web漏洞挖掘实战/04.注入/06"><span>17｜自动化注入神器（四）：sqlmap的核心功能解析</span></a></li><li><a href="/blog/web漏洞挖掘实战/04.注入/07"><span>18 | 命令注入：开发的Web应用为什么成为了攻击者的bash？</span></a></li><li><a href="/blog/web漏洞挖掘实战/04.注入/08"><span>19 | 失效的输入检测（上）：攻击者有哪些绕过方案？</span></a></li><li><a href="/blog/web漏洞挖掘实战/04.注入/09"><span>20 | 失效的输入检测（下）：攻击者有哪些绕过方案？</span></a></li><li><a href="/blog/web漏洞挖掘实战/04.注入/10"><span>21｜XSS（上）：前端攻防的主战场</span></a></li><li><a href="/blog/web漏洞挖掘实战/04.注入/11"><span>22｜XSS（中）：跨站脚本攻击的危害性</span></a></li><li><a href="/blog/web漏洞挖掘实战/04.注入/12"><span>23｜XSS（下）：检测与防御方案解析</span></a></li><li><a href="/blog/web漏洞挖掘实战/04.注入/13"><span>24｜资源注入：攻击方式为什么会升级？</span></a></li></ul></li><li><a href="/blog/web漏洞挖掘实战/05.春节特别策划">05.春节特别策划</a><ul><li><a href="/blog/web漏洞挖掘实战/05.春节特别策划/01"><span>春节策划（一）｜ 视频课内容精选：Web渗透测试工具教学</span></a></li><li><a href="/blog/web漏洞挖掘实战/05.春节特别策划/02"><span>春节策划（二） ｜ 给你推荐4本Web安全图书</span></a></li><li><a href="/blog/web漏洞挖掘实战/05.春节特别策划/03"><span>春节策划（三） | 一套测试题，看看对课程内容的掌握情况</span></a></li></ul></li><li><a href="/blog/web漏洞挖掘实战/06.不安全的设计">06.不安全的设计</a><ul><li><a href="/blog/web漏洞挖掘实战/06.不安全的设计/01"><span>25｜业务逻辑漏洞：好的开始是成功的一半</span></a></li><li><a href="/blog/web漏洞挖掘实战/06.不安全的设计/02"><span>26｜包含敏感信息的报错：将安全开发标准应用到项目中</span></a></li><li><a href="/blog/web漏洞挖掘实战/06.不安全的设计/03"><span>27｜用户账户安全：账户安全体系设计方案与实践</span></a></li></ul></li><li><a href="/blog/web漏洞挖掘实战/07.安全配置错误">07.安全配置错误</a><ul><li><a href="/blog/web漏洞挖掘实战/07.安全配置错误/01"><span>28｜安全配置错误：安全问题不只是代码安全</span></a></li><li><a href="/blog/web漏洞挖掘实战/07.安全配置错误/02"><span>29｜Session与Cookie：账户体系的安全设计原理</span></a></li><li><a href="/blog/web漏洞挖掘实战/07.安全配置错误/03"><span>30｜HTTP Header安全标志：协议级别的安全支持</span></a></li></ul></li><li><a href="/blog/web漏洞挖掘实战/08.其他安全风险串讲">08.其他安全风险串讲</a><ul><li><a href="/blog/web漏洞挖掘实战/08.其他安全风险串讲/01"><span>31｜易受攻击和过时的组件：DevSecOps与依赖项安全检查</span></a></li><li><a href="/blog/web漏洞挖掘实战/08.其他安全风险串讲/02"><span>32｜软件和数据完整性故障：SolarWinds事件的幕后⿊⼿</span></a></li><li><a href="/blog/web漏洞挖掘实战/08.其他安全风险串讲/03"><span>33｜SSRF：穿越边界防护的利刃</span></a></li></ul></li><li><a href="/blog/web漏洞挖掘实战/09.综合实战篇">09.综合实战篇</a><ul><li><a href="/blog/web漏洞挖掘实战/09.综合实战篇/01"><span>34｜Crawler VS Fuzzing：DAST与机器学习</span></a></li><li><a href="/blog/web漏洞挖掘实战/09.综合实战篇/02"><span>35｜自动化攻防：低代码驱动的渗透工具积累</span></a></li><li><a href="/blog/web漏洞挖掘实战/09.综合实战篇/03"><span>36｜智能攻防：构建个性化攻防平台</span></a></li></ul></li><li><a href="/blog/web漏洞挖掘实战/10.结束语">10.结束语</a><ul><li><a href="/blog/web漏洞挖掘实战/10.结束语/01"><span>结束语｜无畏前行</span></a></li><li><a href="/blog/web漏洞挖掘实战/10.结束语/02"><span>期末测试｜来赴一场满分之约吧！</span></a></li></ul></li><li><a href="/blog/web漏洞挖掘实战/summary">web漏洞挖掘实战</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="sqlmap" data-depth="2"><a href="/blog/web漏洞挖掘实战/04.注入/03#sqlmap"><span>sqlmap</span></a></li><li title="初始化过程" data-depth="2"><a href="/blog/web漏洞挖掘实战/04.注入/03#初始化过程"><span>初始化过程</span></a></li><li title="总结" data-depth="2"><a href="/blog/web漏洞挖掘实战/04.注入/03#总结"><span>总结</span></a></li><li title="思考" data-depth="2"><a href="/blog/web漏洞挖掘实战/04.注入/03#思考"><span>思考</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="14自动化注入神器一sqlmap的设计思路解析"><a aria-hidden="true" tabindex="-1" href="/blog/web漏洞挖掘实战/04.注入/03#14自动化注入神器一sqlmap的设计思路解析"><span class="icon icon-link"></span></a>14｜自动化注入神器（一）：sqlmap的设计思路解析</h1><p>你好，我是王昊天。</p><p>从古至今，人们为了方便自己的生活，发明出各种各样的工具。就拿扫地来说，这是我小时候最讨厌的家务活动，因为扫地时扬起的灰尘会让我十分难受，而且有的死角很难被打扫干净。扫地机器人的出现给我们带来了极大的便利，我们只要拥有它，就不需要再亲自扫地了。</p><p>在前几节课中，我们学习了SQL注入的原理和方法，相信你已经小试牛刀了。不知道你在做注入测试的时候是否会觉得困难呢？反正我学的时候是遇到了不少困难，比如，绕过技巧多种多样，我们几乎不可能全部记住它们，就算记住了我们一一去尝试也需要很多的时间，费时又伤神。</p><p>就像我们刚才说过的，当问题出现时，我们常常会创造出一种工具，来解决对应的问题。那么有没有一款工具，能帮我们自动去进行注入测试呢？答案是肯定的，这个工具就是sqlmap。</p><p>这节课呢，我们正式开启sqlmap学习之旅，深入探究这款自动化注入神器的实现原理。<strong>首先我们要对一些知识有所了解，包括如何获取软件的代码，如何搭建软件的运行环境，以及软件文件功能等。接下来，我们会对sqlmap的工作流程做一个整体的介绍，这会为我们后续学习sqlmap打好基础。</strong></p><h2 id="sqlmap"><a aria-hidden="true" tabindex="-1" href="/blog/web漏洞挖掘实战/04.注入/03#sqlmap"><span class="icon icon-link"></span></a>sqlmap</h2><p><img src="https://static001.geekbang.org/resource/image/34/9a/347a42c49613eea753d176b53396ba9a.png?wh=1895x662" alt="图片"/></p><p>我们先来看看到底什么是sqlmap。</p><p>sqlmap是一个帮助我们自动检测sql注入是否存在的测试工具，它会使用不同注入方法进行测试，并将测试结果展示给我们，供我们利用。这些方法都是我们之前学过的内容，包括联合注入、时延注入、布尔盲注、报错注入和堆查询注入。如果你感兴趣，可以去上节课寻找更加详细的介绍。</p><p>因为它的持续更新和维护，所以大家普遍认为它既方便又好用，从图片中我们可以看到超过4k的fork数量，以及高频的源码更新。就像一枚硬币的两面，这种优势也会伴随一些问题，比如给我们阅读源代码增加了难度，而我们要想真正去理解、掌握这款工具，就必须要迎难而上，对它的源代码进行剖析。</p><p><img src="https://static001.geekbang.org/resource/image/2e/ca/2e17e69bf2856256754fc409ab2ebaca.png?wh=1751x480" alt="图片"/></p><p><strong>代码获取</strong></p><p>我们用如下命令将sqlmap的源代码克隆下来。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">git clone https://github.com/sqlmapproject/sqlmap</span></div><div class="token-line"><span class="token plain">    cd sqlmap</span></div></pre></div><p>因为该过程需要访问外网，所以克隆的速度会较为缓慢，当然我们可以借助一些代理工具来加速这个过程。</p><p>这里我们分析的sqlmap版本是最新的版本1.6，它于2022年初发布，相比于上一代1.5.12版本，只是修复了几个编码异常，并且替换版本信息，并没有什么重大的改动。因此学习两个大版本的代码都是可以的。</p><p><img src="https://static001.geekbang.org/resource/image/35/80/35e9758f3c123549d2a25488c9224580.png?wh=1296x363" alt="图片"/><img src="https://static001.geekbang.org/resource/image/65/e6/65ff8f7d9aca2ac1b79afbf44548fbe6.png?wh=1243x347" alt="图片"/></p><p>在获取到源代码之后，我们还需要配置软件的运行环境，这样sqlmap才能顺利的运行。下面让我们进入到环境搭建这一步骤。</p><p><strong>环境搭建</strong></p><p>这节课，我们采用的分析环境是python3.10.1，可以利用下面的命令新建一个虚拟的解释环境，这样做有利于运行环境的隔离，防止其他环境因素干扰sqlmap的执行过程。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">python3 -m venv venv</span></div></pre></div><p><strong>配置文件</strong></p><p>在做完环境搭建之后，sqlmap已经具有运行能力了。但是我们还需要知道哪个文件才是它的配置文件，即哪个文件会对它的运行产生影响。所以呢，接下来我们就来看看，sqlmap中有哪些重要的文件，它们又有哪些功能。</p><p>首先我们一起看下sqlmap的配置文件<code>sqlmap.conf</code>：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain"># At least one of these options has to be specified to set the source to</span></div><div class="token-line"><span class="token plain">    # get target URLs from.</span></div><div class="token-line"><span class="token plain">    [Target]</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # Target URL.</span></div><div class="token-line"><span class="token plain">    # Example: http://192.168.1.121/sqlmap/mysql/get_int.php?id=1&amp;cat=2</span></div><div class="token-line"><span class="token plain">    url =</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # Direct connection to the database.</span></div><div class="token-line"><span class="token plain">    # Examples:</span></div><div class="token-line"><span class="token plain">    #   mysql://USER:PASSWORD@DBMS_IP:DBMS_PORT/DATABASE_NAME</span></div><div class="token-line"><span class="token plain">    #   oracle://USER:PASSWORD@DBMS_IP:DBMS_PORT/DATABASE_SID</span></div><div class="token-line"><span class="token plain">    direct = </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # Parse targets from Burp or WebScarab logs</span></div><div class="token-line"><span class="token plain">    # Valid: Burp proxy (http://portswigger.net/suite/) requests log file path</span></div><div class="token-line"><span class="token plain">    # or WebScarab proxy (http://www.owasp.org/index.php/Category:OWASP_WebScarab_Project)</span></div><div class="token-line"><span class="token plain">    # &#x27;conversations/&#x27; folder path</span></div><div class="token-line"><span class="token plain">    logFile = </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # Scan multiple targets enlisted in a given textual file</span></div><div class="token-line"><span class="token plain">    bulkFile =</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # Load HTTP request from a file</span></div><div class="token-line"><span class="token plain">    # Example (file content): POST /login.jsp HTTP/1.1\nHost: example.com\nUser-Agent: Mozilla/4.0\n\nuserid=joe&amp;password=guessme</span></div><div class="token-line"><span class="token plain">    requestFile = </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # At least one of these options has to be specified to set the source to</span></div><div class="token-line"><span class="token plain">    # get target URLs from.</span></div><div class="token-line"><span class="token plain">    [Target]</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # Target URL.</span></div><div class="token-line"><span class="token plain">    # Example: http://192.168.1.121/sqlmap/mysql/get_int.php?id=1&amp;cat=2</span></div><div class="token-line"><span class="token plain">    url =</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # Direct connection to the database.</span></div><div class="token-line"><span class="token plain">    # Examples:</span></div><div class="token-line"><span class="token plain">    #   mysql://USER:PASSWORD@DBMS_IP:DBMS_PORT/DATABASE_NAME</span></div><div class="token-line"><span class="token plain">    #   oracle://USER:PASSWORD@DBMS_IP:DBMS_PORT/DATABASE_SID</span></div><div class="token-line"><span class="token plain">    direct = </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # Parse targets from Burp or WebScarab logs</span></div><div class="token-line"><span class="token plain">    # Valid: Burp proxy (http://portswigger.net/suite/) requests log file path</span></div><div class="token-line"><span class="token plain">    # or WebScarab proxy (http://www.owasp.org/index.php/Category:OWASP_WebScarab_Project)</span></div><div class="token-line"><span class="token plain">    # &#x27;conversations/&#x27; folder path</span></div><div class="token-line"><span class="token plain">    logFile = </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # Scan multiple targets enlisted in a given textual file</span></div><div class="token-line"><span class="token plain">    bulkFile =</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # Load HTTP request from a file</span></div><div class="token-line"><span class="token plain">    # Example (file content): POST /login.jsp HTTP/1.1\nHost: example.com\nUser-Agent: Mozilla/4.0\n\nuserid=joe&amp;password=guessme</span></div><div class="token-line"><span class="token plain">    requestFile = </span></div><div class="token-line"><span class="token plain">    ......</span></div><div class="token-line"><span class="token plain">    # Force back-end DBMS operating system to provided value. If this option is</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # set, the back-end DBMS identification process will be minimized as</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # needed.</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # If not set, sqlmap will detect back-end DBMS operating system</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # automatically by default.</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # Valid: linux, windows</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    os = </span></div><div class="token-line"><span class="token plain">    ......</span></div></pre></div><p>由于配置文件很长，所以这里没有全部展示出来。我们需要知道的是，<strong>配置文件的参数配置可以对sqlmap程序运行的流程产生影响</strong>。举个例子，在配置文件中可以设置OS配置项，sqlmap就无需探测操作系统的类型了，这样就可以帮助我们在一些特定情况下优化sqlmap的执行速度。</p><p>看完配置文件之后，我们回忆一下之前学过的内容，在做SQL注入时，都需要经历哪些步骤呢？</p><p>我们知道，一般来说SQL注入攻击可以分为三步，首先是寻找注入点，之后要选择闭合参数的位置，最后要根据需求选择合适的payload，来实现我们的注入攻击操作。</p><p>sqlmap和手动SQL注入的思想是相似的，程序可以直接从请求的参数中获取到注入点位置的信息，而闭合参数的位置和payload的选择则会因为它们的多样性变得略微复杂，下面就让我们一起来看看与之相关的两个配置文件。</p><p>我们先来看sqlmap中闭合参数的配置内容，这里举个例子帮助你来理解什么是闭合参数。以一个典型的SQL注入语句为例：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">SELECT id FROM users WHERE name = &#x27;$name&#x27;;</span></div></pre></div><p>想要对其进行注入，就需要将name参数闭合，这在前两节课中有过较深入的探讨。</p><p>对于sqlmap而言，data.xml.boundaries.xml就是用于闭合参数的配置文件，通过该文件我们可以确定闭合元素的字符和位置等等信息，了解该文件有助于我们理解sqlmap真正发送的测试payload的格式，关于payload格式这部分的内容我们会在下一讲具体的讲解。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    &lt;!--</span></div><div class="token-line"><span class="token plain">    Tag: &lt;boundary&gt;</span></div><div class="token-line"><span class="token plain">        How to prepend and append to the test &#x27; &lt;payload&gt;&lt;comment&gt; &#x27; string.</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        Sub-tag: &lt;level&gt;</span></div><div class="token-line"><span class="token plain">            From which level check for this test.</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            Valid values:</span></div><div class="token-line"><span class="token plain">                1: Always (&lt;100 requests)</span></div><div class="token-line"><span class="token plain">                2: Try a bit harder (100-200 requests)</span></div><div class="token-line"><span class="token plain">                3: Good number of requests (200-500 requests)</span></div><div class="token-line"><span class="token plain">                4: Extensive test (500-1000 requests)</span></div><div class="token-line"><span class="token plain">                5: You have plenty of time (&gt;1000 requests)</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        Sub-tag: &lt;clause&gt;</span></div><div class="token-line"><span class="token plain">            In which clause the payload can work.</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            NOTE: for instance, there are some payload that do not have to be</span></div><div class="token-line"><span class="token plain">            tested as soon as it has been identified whether or not the</span></div><div class="token-line"><span class="token plain">            injection is within a WHERE clause condition.</span></div><div class="token-line"><span class="token plain">    ......</span></div></pre></div><p>而关于payload这一部分，就让我们看一看sqlmap中payload的配置文件夹，<code>data.xml.payloads/</code>。这个文件夹储存有不同注入攻击类型的payload信息。</p><p>该文件夹下的每一个文件都与程序中一个重要的结构test息息相关，它是一个payload的基本信息单元，每个test里面包含了一个完整的payload需要的信息， sqlmap发送的攻击载荷就是在此基础上进行加工得出的，如下代码就是这个文件夹下的<code>boolean_blind.xml</code>文件的部分内容，这里我们选取了完整的test结构方便你了解。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;test&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            &lt;title&gt;AND boolean-based blind - WHERE or HAVING clause (MySQL comment)&lt;/title&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            &lt;stype&gt;1&lt;/stype&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            &lt;level&gt;3&lt;/level&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            &lt;risk&gt;1&lt;/risk&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            &lt;clause&gt;1&lt;/clause&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            &lt;where&gt;1&lt;/where&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            &lt;vector&gt;AND [INFERENCE]&lt;/vector&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            &lt;request&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">                &lt;payload&gt;AND [RANDNUM]=[RANDNUM]&lt;/payload&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">                &lt;comment&gt;#&lt;/comment&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            &lt;/request&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            &lt;respons e&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">                &lt;comparison&gt;AND [RANDNUM]=[RANDNUM1]&lt;/comparison&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            &lt;/response&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            &lt;details&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">                &lt;dbms&gt;MySQL&lt;/dbms&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            &lt;/details&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        &lt;/test&gt;</span></div></pre></div><p>可以看到它的结构内部定义攻击类型、方式、生效位置、关联数据库等等信息。<br/>至此，我们大致了解了sqlmap工作的底层依赖。下一步只需要分析和掌握sqlmap的运行过程，日后在使用中我们就可以更加得心应手。</p><p>sqlmap作为一个规模较大的工具，在启动过程中首先会执行一些初始化操作，下面就让我们一起学习sqlmap的初始化过程，通过这部分内容你可以明白sqlmap在启动之初做了哪些事情。</p><h2 id="初始化过程"><a aria-hidden="true" tabindex="-1" href="/blog/web漏洞挖掘实战/04.注入/03#初始化过程"><span class="icon icon-link"></span></a>初始化过程</h2><p>sqlmap的初始化过程包含四个步骤：环境初始化、命令行参数的解析、全局变量的赋值，以及运行环境的检查。我们将结合代码和图片注释，顺着sqlmap代码运行的顺序，详细讲述每一个步骤。下面让我们从环境初始化开始吧。</p><p><strong>环境初始化</strong></p><p>首先我们会发现，sqlmap的入口文件是sqlmap.py，这个文件的main如下所示：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">if __name__ == &quot;__main__&quot;:</span></div><div class="token-line"><span class="token plain">        try:</span></div><div class="token-line"><span class="token plain">            main()</span></div><div class="token-line"><span class="token plain">        except KeyboardInterrupt:</span></div><div class="token-line"><span class="token plain">            pass</span></div><div class="token-line"><span class="token plain">        except SystemExit:</span></div><div class="token-line"><span class="token plain">            raise</span></div><div class="token-line"><span class="token plain">        except:</span></div><div class="token-line"><span class="token plain">            traceback.print_exc()</span></div><div class="token-line"><span class="token plain">        finally:</span></div><div class="token-line"><span class="token plain">            if threading.active_count() &gt; 1:</span></div><div class="token-line"><span class="token plain">                os._exit(getattr(os, &quot;_exitcode&quot;, 0))</span></div><div class="token-line"><span class="token plain">            else:</span></div><div class="token-line"><span class="token plain">                sys.exit(getattr(os, &quot;_exitcode&quot;, 0))</span></div><div class="token-line"><span class="token plain">    else:</span></div><div class="token-line"><span class="token plain">        __import__(&quot;lib.controller.controller&quot;)</span></div></pre></div><p>根据main函数的名字，我们可以知道，程序的核心逻辑一定被封装在了mian函数里面。因此，我们可以进入到mian函数里查看。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">def main():</span></div><div class="token-line"><span class="token plain">        try:</span></div><div class="token-line"><span class="token plain">            dirtyPatches()</span></div><div class="token-line"><span class="token plain">            resolveCrossReferences()</span></div><div class="token-line"><span class="token plain">            checkEnvironment()</span></div><div class="token-line"><span class="token plain">            setPaths(modulePath())</span></div><div class="token-line"><span class="token plain">            banner()</span></div><div class="token-line"><span class="token plain">            args = cmdLineParser()</span></div><div class="token-line"><span class="token plain">            cmdLineOptions.update(args.__dict__ if hasattr(args, &quot;__dict__&quot;) else args)</span></div><div class="token-line"><span class="token plain">            initOptions(cmdLineOptions)</span></div><div class="token-line"><span class="token plain">            if checkPipedInput():</span></div><div class="token-line"><span class="token plain">                conf.batch = True</span></div><div class="token-line"><span class="token plain">            if conf.get(&quot;api&quot;):</span></div><div class="token-line"><span class="token plain">                from lib.utils.api import StdDbOut</span></div><div class="token-line"><span class="token plain">                from lib.utils.api import setRestAPILog</span></div><div class="token-line"><span class="token plain">                sys.stdout = StdDbOut(conf.taskid, messagetype=&quot;stdout&quot;)</span></div><div class="token-line"><span class="token plain">                sys.stderr = StdDbOut(conf.taskid, messagetype=&quot;stderr&quot;)</span></div><div class="token-line"><span class="token plain">                setRestAPILog()</span></div><div class="token-line"><span class="token plain">            conf.showTime = True</span></div><div class="token-line"><span class="token plain">            dataToStdout(&quot;[!] legal disclaimer: %s\n\n&quot; % LEGAL_DISCLAIMER, forceOutput=True)</span></div><div class="token-line"><span class="token plain">            dataToStdout(&quot;[*] starting @ %s\n\n&quot; % time.strftime(&quot;%X /%Y-%m-%d/&quot;), forceOutput=True)</span></div><div class="token-line"><span class="token plain">            init()</span></div></pre></div><p>进入到mian函数之后我们就会发现，环境初始化初始化过程的代码就在这里，该过程引入了两个重要数据容器的映射conf和kb。他们都是全局的环境变量，是存储程序运行中间数据和信息数据的容器，其中sqlmap的结果信息、注入信息、控制信息都是通过它们进行读写来完成程序的执行的。这部分内容我们会在下节课展开。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">from lib.core.data import conf</span></div><div class="token-line"><span class="token plain">    from lib.core.data import kb</span></div></pre></div><p>在这里，为了你更好地理解它们，我们先来看看这两个数据结构是什么，这里我们可以找到lib.core.data.py文件进行观察。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain"># object to share within function and classes command</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # line options and settings</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    conf = AttribDict()</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # object to share within function and classes results</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    kb = AttribDict()</span></div></pre></div><p>可以发现，这两个数据结构是作者自己封装的函数，封装的主要目的是实现深拷贝（<code>__deepcopy__</code> ）这个魔法函数。通过这种方式，Python内容数据的拷贝操作会被大大优化。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">class AttribDict(dict):</span></div><div class="token-line"><span class="token plain">          ......</span></div><div class="token-line"><span class="token plain">        def __deepcopy__(self, memo):</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            retVal = self.__class__()</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            memo[id(self)] = retVal</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            for attr in dir(self):</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">                if not attr.startswith(&#x27;_&#x27;):</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">                    value = getattr(self, attr)</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">                    if not isinstance(value, (types.BuiltinFunctionType, types.FunctionType, types.MethodType)):</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">                        setattr(retVal, attr, copy.deepcopy(value, memo))</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            for key, value in self.items():</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">                retVal.__setitem__(key, copy.deepcopy(value, memo))</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            return retVal</span></div></pre></div><p>接下来我们继续观察main函数。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">dirtyPatches()  # 补丁函数</span></div><div class="token-line"><span class="token plain">            resolveCrossReferences()  # 消除交叉引用</span></div><div class="token-line"><span class="token plain">            checkEnvironment()  # 检查环境</span></div><div class="token-line"><span class="token plain">            setPaths(modulePath())  # 如果使用py2exe 作为file获取程序路径的替代 设置绝对路径</span></div><div class="token-line"><span class="token plain">            banner()</span></div></pre></div><p>我们可以看到，程序在进入到try语句之后，首先会执行几个函数。</p><p>第一个函数是dirtyPatches() ，它是一个补丁函数。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">def dirtyPatches():</span></div><div class="token-line"><span class="token plain">        &quot;&quot;&quot;</span></div><div class="token-line"><span class="token plain">        Place for &quot;dirty&quot; Python related patches</span></div><div class="token-line"><span class="token plain">        &quot;&quot;&quot;</span></div><div class="token-line"><span class="token plain">        # accept overly long result lines (e.g. SQLi results in HTTP header responses)</span></div><div class="token-line"><span class="token plain">        _http_client._MAXLINE = 1 * 1024 * 1024</span></div><div class="token-line"><span class="token plain">        # prevent double chunked encoding in case of sqlmap chunking (Note: Python3 does it automatically if &#x27;Content-length&#x27; is missing)</span></div><div class="token-line"><span class="token plain">        if six.PY3:</span></div><div class="token-line"><span class="token plain">            if not hasattr(_http_client.HTTPConnection, &quot;__send_output&quot;):</span></div><div class="token-line"><span class="token plain">                _http_client.HTTPConnection.__send_output = _http_client.HTTPConnection._send_output</span></div><div class="token-line"><span class="token plain">            def _send_output(self, *args, **kwargs):</span></div><div class="token-line"><span class="token plain">                if conf.get(&quot;chunked&quot;) and &quot;encode_chunked&quot; in kwargs:</span></div><div class="token-line"><span class="token plain">                    kwargs[&quot;encode_chunked&quot;] = False</span></div><div class="token-line"><span class="token plain">                self.__send_output(*args, **kwargs)</span></div><div class="token-line"><span class="token plain">            _http_client.HTTPConnection._send_output = _send_output</span></div><div class="token-line"><span class="token plain">        # add support for inet_pton() on Windows OS</span></div><div class="token-line"><span class="token plain">        if IS_WIN:</span></div><div class="token-line"><span class="token plain">            from thirdparty.wininetpton import win_inet_pton</span></div><div class="token-line"><span class="token plain">        # Reference: https://github.com/nodejs/node/issues/12786#issuecomment-298652440</span></div><div class="token-line"><span class="token plain">        codecs.register(lambda name: codecs.lookup(&quot;utf-8&quot;) if name == &quot;cp65001&quot; else None)</span></div><div class="token-line"><span class="token plain">        # Reference: http://bugs.python.org/issue17849</span></div><div class="token-line"><span class="token plain">        if hasattr(_http_client, &quot;LineAndFileWrapper&quot;):</span></div><div class="token-line"><span class="token plain">            def _(self, *args):</span></div><div class="token-line"><span class="token plain">                return self._readline()</span></div><div class="token-line"><span class="token plain">            _http_client.LineAndFileWrapper._readline = _http_client.LineAndFileWrapper.readline</span></div><div class="token-line"><span class="token plain">            _http_client.LineAndFileWrapper.readline = _</span></div><div class="token-line"><span class="token plain">        # to prevent too much &quot;guessing&quot; in case of binary data retrieval</span></div><div class="token-line"><span class="token plain">        thirdparty.chardet.universaldetector.MINIMUM_THRESHOLD = 0.90</span></div><div class="token-line"><span class="token plain">        match = re.search(r&quot; --method[= ](\w+)&quot;, &quot; &quot;.join(sys.argv))</span></div><div class="token-line"><span class="token plain">        if match and match.group(1).upper() != PLACE.POST:</span></div><div class="token-line"><span class="token plain">            PLACE.CUSTOM_POST = PLACE.CUSTOM_POST.replace(&quot;POST&quot;, &quot;%s (body)&quot; % match.group(1))</span></div><div class="token-line"><span class="token plain">        # https://github.com/sqlmapproject/sqlmap/issues/4314</span></div><div class="token-line"><span class="token plain">        try:</span></div><div class="token-line"><span class="token plain">            os.urandom(1)</span></div><div class="token-line"><span class="token plain">        except NotImplementedError:</span></div><div class="token-line"><span class="token plain">            if six.PY3:</span></div><div class="token-line"><span class="token plain">                os.urandom = lambda size: bytes(random.randint(0, 255) for _ in range(size))</span></div><div class="token-line"><span class="token plain">            else:</span></div><div class="token-line"><span class="token plain">                os.urandom = lambda size: &quot;&quot;.join(chr(random.randint(0, 255)) for _ in xrange(size))</span></div></pre></div><p>之所称它为补丁函数呢，是因为这个函数功能，主要用来处理sqlmap的一些历史信息。例如支持Python2升级Python3、支持Windows平台的inet_pton()函数、限制httplib的最大行长度等等。这些操作对sqlmap的实际功能影响并不是特别大，属于保证用户体验和系统设置的正常选项，我们不需要过多关心。</p><p>接下来是resolveCrossReferences函数，它的作用是消除交叉引用。我们通过下面这个示例理解下什么是交叉引用。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">```python</span></div><div class="token-line"><span class="token plain">    a.py</span></div><div class="token-line"><span class="token plain">    from b import b_var</span></div><div class="token-line"><span class="token plain">    a_var = 1</span></div><div class="token-line"><span class="token plain">    b.py</span></div><div class="token-line"><span class="token plain">    from a import a_var</span></div><div class="token-line"><span class="token plain">    b_var = 2</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">这就是一个交叉引用的示例，文件`a.py`和`b.py`互相引用导致了运行的python解释器报错。为了避免交叉引用引起这样的问题，这里我们选择通过`resolveCrossReferences()`函数来消除交叉引用。</span></div><div class="token-line"><span class="token plain">    ```python</span></div><div class="token-line"><span class="token plain">    def resolveCrossReferences():</span></div><div class="token-line"><span class="token plain">        “””</span></div><div class="token-line"><span class="token plain">        Place for cross-reference resolution</span></div><div class="token-line"><span class="token plain">        “””</span></div><div class="token-line"><span class="token plain">        lib.core.threads.isDigit = isDigit</span></div><div class="token-line"><span class="token plain">        lib.core.threads.readInput = readInput</span></div><div class="token-line"><span class="token plain">        lib.core.common.getPageTemplate = getPageTemplate</span></div><div class="token-line"><span class="token plain">        lib.core.convert.filterNone = filterNone</span></div><div class="token-line"><span class="token plain">        lib.core.convert.isListLike = isListLike</span></div><div class="token-line"><span class="token plain">        lib.core.convert.shellExec = shellExec</span></div><div class="token-line"><span class="token plain">        lib.core.convert.singleTimeWarnMessage = singleTimeWarnMessage</span></div><div class="token-line"><span class="token plain">        lib.core.option._pympTempLeakPatch = pympTempLeakPatch</span></div><div class="token-line"><span class="token plain">        lib.request.connect.setHTTPHandlers = _setHTTPHandlers</span></div><div class="token-line"><span class="token plain">        lib.utils.search.setHTTPHandlers = _setHTTPHandlers</span></div><div class="token-line"><span class="token plain">        lib.controller.checks.setVerbosity = setVerbosity</span></div><div class="token-line"><span class="token plain">        lib.utils.sqlalchemy.getSafeExString = getSafeExString</span></div><div class="token-line"><span class="token plain">        thirdparty.ansistrm.ansistrm.stdoutEncode = stdoutEncode</span></div></pre></div><p>sqlmap在消除交叉引用之后，程序会开始运行检查环境的函数checkEnvironment()。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">def checkEnvironment():</span></div><div class="token-line"><span class="token plain">        try:</span></div><div class="token-line"><span class="token plain">             os.path.isdir(modulePath())</span></div><div class="token-line"><span class="token plain">        except UnicodeEncodeError:</span></div><div class="token-line"><span class="token plain">            errMsg = “your system does not properly handle non-ASCII paths. “</span></div><div class="token-line"><span class="token plain">            errMsg += “Please move the sqlmap’s directory to the other location”</span></div><div class="token-line"><span class="token plain">            logger.critical(errMsg)</span></div><div class="token-line"><span class="token plain">            raise SystemExit</span></div><div class="token-line"><span class="token plain">        if LooseVersion(VERSION) &lt; LooseVersion(“1.0”):</span></div><div class="token-line"><span class="token plain">            errMsg = “your runtime environment (e.g. PYTHONPATH) is “</span></div><div class="token-line"><span class="token plain">            errMsg += “broken. Please make sure that you are not running “</span></div><div class="token-line"><span class="token plain">            errMsg += “newer versions of sqlmap with runtime scripts for older “</span></div><div class="token-line"><span class="token plain">            errMsg += “versions”</span></div><div class="token-line"><span class="token plain">            logger.critical(errMsg)</span></div><div class="token-line"><span class="token plain">            raise SystemExit</span></div><div class="token-line"><span class="token plain">        # Patch for pip (import) environment</span></div><div class="token-line"><span class="token plain">        if “sqlmap.sqlmap” in sys.modules:</span></div><div class="token-line"><span class="token plain">            for _ in (“cmdLineOptions”, “conf”, “kb”):</span></div><div class="token-line"><span class="token plain">                globals()[_] = getattr(sys.modules[“lib.core.data”], _)</span></div><div class="token-line"><span class="token plain">            for _ in (“SqlmapBaseException”, “SqlmapShellQuitException”, “SqlmapSilentQuitException”, “SqlmapUserQuitException”):</span></div><div class="token-line"><span class="token plain">                globals()[_] = getattr(sys.modules[“lib.core.exception”], _)</span></div></pre></div><p>checkEnvironment函数会对当前的环境进行初步检查，检查的内容包括，存放sqlmap的路径是否包含非ASCII字符，以及sqlmap的版本是否小于1.0。</p><p>下一个函数<code>setPaths(modulePath())</code>是用来给项目中的文件夹和文件设置绝对路径的。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">def setPaths(rootPath):</span></div><div class="token-line"><span class="token plain">        &quot;&quot;&quot;</span></div><div class="token-line"><span class="token plain">        Sets absolute paths for project directories and files</span></div><div class="token-line"><span class="token plain">        &quot;&quot;&quot;</span></div><div class="token-line"><span class="token plain">        paths.SQLMAP_ROOT_PATH = rootPath</span></div><div class="token-line"><span class="token plain">        # sqlmap paths</span></div><div class="token-line"><span class="token plain">        paths.SQLMAP_DATA_PATH = os.path.join(paths.SQLMAP_ROOT_PATH, &quot;data&quot;)</span></div><div class="token-line"><span class="token plain">        paths.SQLMAP_EXTRAS_PATH = os.path.join(paths.SQLMAP_ROOT_PATH, &quot;extra&quot;)</span></div><div class="token-line"><span class="token plain">        paths.SQLMAP_SETTINGS_PATH = os.path.join(paths.SQLMAP_ROOT_PATH, &quot;lib&quot;, &quot;core&quot;, &quot;settings.py&quot;)</span></div><div class="token-line"><span class="token plain">        paths.SQLMAP_TAMPER_PATH = os.path.join(paths.SQLMAP_ROOT_PATH, &quot;tamper&quot;)</span></div><div class="token-line"><span class="token plain">        paths.SQLMAP_PROCS_PATH = os.path.join(paths.SQLMAP_DATA_PATH, &quot;procs&quot;)</span></div><div class="token-line"><span class="token plain">        paths.SQLMAP_SHELL_PATH = os.path.join(paths.SQLMAP_DATA_PATH, &quot;shell&quot;)</span></div><div class="token-line"><span class="token plain">        paths.SQLMAP_TXT_PATH = os.path.join(paths.SQLMAP_DATA_PATH, &quot;txt&quot;)</span></div><div class="token-line"><span class="token plain">        paths.SQLMAP_UDF_PATH = os.path.join(paths.SQLMAP_DATA_PATH, &quot;udf&quot;)</span></div><div class="token-line"><span class="token plain">        paths.SQLMAP_XML_PATH = os.path.join(paths.SQLMAP_DATA_PATH, &quot;xml&quot;)</span></div><div class="token-line"><span class="token plain">        paths.SQLMAP_XML_BANNER_PATH = os.path.join(paths.SQLMAP_XML_PATH, &quot;banner&quot;)</span></div><div class="token-line"><span class="token plain">        paths.SQLMAP_XML_PAYLOADS_PATH = os.path.join(paths.SQLMAP_XML_PATH, &quot;payloads&quot;)</span></div><div class="token-line"><span class="token plain">        # sqlmap files</span></div><div class="token-line"><span class="token plain">        paths.COMMON_COLUMNS = os.path.join(paths.SQLMAP_TXT_PATH, &quot;common-columns.txt&quot;)</span></div><div class="token-line"><span class="token plain">        paths.COMMON_FILES = os.path.join(paths.SQLMAP_TXT_PATH, &quot;common-files.txt&quot;)</span></div><div class="token-line"><span class="token plain">        paths.COMMON_TABLES = os.path.join(paths.SQLMAP_TXT_PATH, &quot;common-tables.txt&quot;)</span></div><div class="token-line"><span class="token plain">        paths.COMMON_OUTPUTS = os.path.join(paths.SQLMAP_TXT_PATH, &#x27;common-outputs.txt&#x27;)</span></div><div class="token-line"><span class="token plain">        paths.SQL_KEYWORDS = os.path.join(paths.SQLMAP_TXT_PATH, &quot;keywords.txt&quot;)</span></div><div class="token-line"><span class="token plain">        paths.SMALL_DICT = os.path.join(paths.SQLMAP_TXT_PATH, &quot;smalldict.txt&quot;)</span></div><div class="token-line"><span class="token plain">        paths.USER_AGENTS = os.path.join(paths.SQLMAP_TXT_PATH, &quot;user-agents.txt&quot;)</span></div><div class="token-line"><span class="token plain">        paths.WORDLIST = os.path.join(paths.SQLMAP_TXT_PATH, &quot;wordlist.tx_&quot;)</span></div><div class="token-line"><span class="token plain">        paths.ERRORS_XML = os.path.join(paths.SQLMAP_XML_PATH, &quot;errors.xml&quot;)</span></div><div class="token-line"><span class="token plain">        paths.BOUNDARIES_XML = os.path.join(paths.SQLMAP_XML_PATH, &quot;boundaries.xml&quot;)</span></div><div class="token-line"><span class="token plain">        paths.QUERIES_XML = os.path.join(paths.SQLMAP_XML_PATH, &quot;queries.xml&quot;)</span></div><div class="token-line"><span class="token plain">        paths.GENERIC_XML = os.path.join(paths.SQLMAP_XML_BANNER_PATH, &quot;generic.xml&quot;)</span></div><div class="token-line"><span class="token plain">        paths.MSSQL_XML = os.path.join(paths.SQLMAP_XML_BANNER_PATH, &quot;mssql.xml&quot;)</span></div><div class="token-line"><span class="token plain">        paths.MYSQL_XML = os.path.join(paths.SQLMAP_XML_BANNER_PATH, &quot;mysql.xml&quot;)</span></div><div class="token-line"><span class="token plain">        paths.ORACLE_XML = os.path.join(paths.SQLMAP_XML_BANNER_PATH, &quot;oracle.xml&quot;)</span></div><div class="token-line"><span class="token plain">        paths.PGSQL_XML = os.path.join(paths.SQLMAP_XML_BANNER_PATH, &quot;postgresql.xml&quot;)</span></div><div class="token-line"><span class="token plain">        for path in paths.values():</span></div><div class="token-line"><span class="token plain">            if any(path.endswith(_) for _ in (&quot;.txt&quot;, &quot;.xml&quot;, &quot;.tx_&quot;)):</span></div><div class="token-line"><span class="token plain">                checkFile(path)</span></div><div class="token-line"><span class="token plain">        if IS_WIN:</span></div><div class="token-line"><span class="token plain">            # Reference: https://pureinfotech.com/list-environment-variables-windows-10/</span></div><div class="token-line"><span class="token plain">            if os.getenv(&quot;LOCALAPPDATA&quot;):</span></div><div class="token-line"><span class="token plain">                paths.SQLMAP_HOME_PATH = os.path.expandvars(&quot;%LOCALAPPDATA%\\sqlmap&quot;)</span></div><div class="token-line"><span class="token plain">            elif os.getenv(&quot;USERPROFILE&quot;):</span></div><div class="token-line"><span class="token plain">                paths.SQLMAP_HOME_PATH = os.path.expandvars(&quot;%USERPROFILE%\\Local Settings\\sqlmap&quot;)</span></div><div class="token-line"><span class="token plain">            else:</span></div><div class="token-line"><span class="token plain">                paths.SQLMAP_HOME_PATH = os.path.join(os.path.expandvars(os.path.expanduser(&quot;~&quot;)), &quot;sqlmap&quot;)</span></div><div class="token-line"><span class="token plain">        else:</span></div><div class="token-line"><span class="token plain">            paths.SQLMAP_HOME_PATH = os.path.join(os.path.expandvars(os.path.expanduser(&quot;~&quot;)), &quot;.sqlmap&quot;)</span></div><div class="token-line"><span class="token plain">            if not os.path.isdir(paths.SQLMAP_HOME_PATH):</span></div><div class="token-line"><span class="token plain">                if &quot;XDG_DATA_HOME&quot; in os.environ:</span></div><div class="token-line"><span class="token plain">                    paths.SQLMAP_HOME_PATH = os.path.join(os.environ[&quot;XDG_DATA_HOME&quot;], &quot;sqlmap&quot;)</span></div><div class="token-line"><span class="token plain">                else:</span></div><div class="token-line"><span class="token plain">                    paths.SQLMAP_HOME_PATH = os.path.join(os.path.expandvars(os.path.expanduser(&quot;~&quot;)), &quot;.local&quot;, &quot;share&quot;, &quot;sqlmap&quot;)</span></div><div class="token-line"><span class="token plain">        paths.SQLMAP_OUTPUT_PATH = getUnicode(paths.get(&quot;SQLMAP_OUTPUT_PATH&quot;, os.path.join(paths.SQLMAP_HOME_PATH, &quot;output&quot;)), encoding=sys.getfilesystemencoding() or UNICODE_ENCODING)</span></div><div class="token-line"><span class="token plain">        paths.SQLMAP_DUMP_PATH = os.path.join(paths.SQLMAP_OUTPUT_PATH, &quot;%s&quot;, &quot;dump&quot;)</span></div><div class="token-line"><span class="token plain">        paths.SQLMAP_FILES_PATH = os.path.join(paths.SQLMAP_OUTPUT_PATH, &quot;%s&quot;, &quot;files&quot;)</span></div><div class="token-line"><span class="token plain">        # History files</span></div><div class="token-line"><span class="token plain">        paths.SQLMAP_HISTORY_PATH = getUnicode(os.path.join(paths.SQLMAP_HOME_PATH, &quot;history&quot;), encoding=sys.getfilesystemencoding() or UNICODE_ENCODING)</span></div><div class="token-line"><span class="token plain">        paths.API_SHELL_HISTORY = os.path.join(paths.SQLMAP_HISTORY_PATH, &quot;api.hst&quot;)</span></div><div class="token-line"><span class="token plain">        paths.OS_SHELL_HISTORY = os.path.join(paths.SQLMAP_HISTORY_PATH, &quot;os.hst&quot;)</span></div><div class="token-line"><span class="token plain">        paths.SQL_SHELL_HISTORY = os.path.join(paths.SQLMAP_HISTORY_PATH, &quot;sql.hst&quot;)</span></div><div class="token-line"><span class="token plain">        paths.SQLMAP_SHELL_HISTORY = os.path.join(paths.SQLMAP_HISTORY_PATH, &quot;sqlmap.hst&quot;)</span></div><div class="token-line"><span class="token plain">        paths.GITHUB_HISTORY = os.path.join(paths.SQLMAP_HISTORY_PATH, &quot;github.hst&quot;)</span></div></pre></div><p>设置完绝对路径后我们可以看到，sqlmap运行了一个banner函数，它对于sqlmap的运行没有实际的作用，但是作者可以通过banner函数绘制一幅字符画，是不是很酷！</p><p><img src="https://static001.geekbang.org/resource/image/a5/c2/a5dc76a4f24686649413121e108d58c2.png?wh=1556x290" alt="图片"/></p><p>下方是banner函数的代码，你在构建自己工具的时候也可以考虑引入这种有趣的小函数，为你的工具增添个性化色彩，让它看起来又酷又实用。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">def banner():</span></div><div class="token-line"><span class="token plain">        &quot;&quot;&quot;</span></div><div class="token-line"><span class="token plain">        This function prints sqlmap banner with its version</span></div><div class="token-line"><span class="token plain">        &quot;&quot;&quot;</span></div><div class="token-line"><span class="token plain">        if not any(_ in sys.argv for _ in (&quot;--version&quot;, &quot;--api&quot;)) and not conf.get(&quot;disableBanner&quot;):</span></div><div class="token-line"><span class="token plain">            result = BANNER</span></div><div class="token-line"><span class="token plain">            if not IS_TTY or any(_ in sys.argv for _ in (&quot;--disable-coloring&quot;, &quot;--disable-colouring&quot;)):</span></div><div class="token-line"><span class="token plain">                result = clearColors(result)</span></div><div class="token-line"><span class="token plain">            elif IS_WIN:</span></div><div class="token-line"><span class="token plain">                coloramainit()</span></div><div class="token-line"><span class="token plain">            dataToStdout(result, forceOutput=True)</span></div></pre></div><p><strong>命令行参数解析</strong></p><p>经过上面的函数执行之后，基本环境已经配置好了，程序将开始处理用户的输入，包括有命令行参数以及配置的文件参数。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">def main():</span></div><div class="token-line"><span class="token plain">        &quot;&quot;&quot;</span></div><div class="token-line"><span class="token plain">        Main function of sqlmap when running from command line.</span></div><div class="token-line"><span class="token plain">        &quot;&quot;&quot;</span></div><div class="token-line"><span class="token plain">        try:</span></div><div class="token-line"><span class="token plain">            dirtyPatches()</span></div><div class="token-line"><span class="token plain">            resolveCrossReferences()</span></div><div class="token-line"><span class="token plain">            checkEnvironment()</span></div><div class="token-line"><span class="token plain">            setPaths(modulePath())</span></div><div class="token-line"><span class="token plain">            banner()</span></div><div class="token-line"><span class="token plain">            # Store original command line options for possible later restoration</span></div><div class="token-line"><span class="token plain">            args = cmdLineParser()</span></div><div class="token-line"><span class="token plain">            cmdLineOptions.update(args.__dict__ if hasattr(args, &quot;__dict__&quot;) else args)</span></div><div class="token-line"><span class="token plain">            initOptions(cmdLineOptions)</span></div></pre></div><p><strong>全局变量赋值与环境检查</strong></p><p>在接收用户的输入参数之后，程序开始进入init方法，这个方法是一个重要的前期配置方法，里面包含大量的配置操作，这些操作我们可以进入函数中观察。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">def init():</span></div><div class="token-line"><span class="token plain">        _useWizardInterface() # 启动引导模式</span></div><div class="token-line"><span class="token plain">        setVerbosity() # 设置默认的日志输出详细度</span></div><div class="token-line"><span class="token plain">        _saveConfig()  # 保存当前扫描的配置</span></div><div class="token-line"><span class="token plain">        _setRequestFromFile() # 解析 request file 的文件内容</span></div><div class="token-line"><span class="token plain">        _cleanupOptions() # 为 conf 中的参数赋初值</span></div><div class="token-line"><span class="token plain">        _cleanupEnvironment() </span></div><div class="token-line"><span class="token plain">        _purge() # 清空 sqlmap 相关信息</span></div><div class="token-line"><span class="token plain">        _checkDependencies() # 检查是否缺失依赖</span></div><div class="token-line"><span class="token plain">        _createHomeDirectories() # 创建 output、history 目录</span></div><div class="token-line"><span class="token plain">        _createTemporaryDirectory() # 创建临时目录</span></div><div class="token-line"><span class="token plain">        _basicOptionValidation() # 验证部分参数值是否符合预期</span></div><div class="token-line"><span class="token plain">        _setProxyList() # 解析 proxy file 的文件内容</span></div><div class="token-line"><span class="token plain">        _setTorProxySettings() # 设置 tor 代理</span></div><div class="token-line"><span class="token plain">        _setDNSServer() # 创建 DNS 服务器</span></div><div class="token-line"><span class="token plain">        _adjustLoggingFormatter() # 初始化日志格式化工具</span></div><div class="token-line"><span class="token plain">        _setMultipleTargets() # 解析 burp log 的文件内容</span></div><div class="token-line"><span class="token plain">        _listTamperingFunctions() # 输出 tamper 的详细信息</span></div><div class="token-line"><span class="token plain">        _setTamperingFunctions() # 设置后续要调用的 tamper</span></div><div class="token-line"><span class="token plain">        _setPreprocessFunctions() # 设置处理请求的函数</span></div><div class="token-line"><span class="token plain">        _setPostprocessFunctions() # 设置处理响应的函数</span></div><div class="token-line"><span class="token plain">        _setTrafficOutputFP() # 创建 trafficFile 并获取文件句柄</span></div><div class="token-line"><span class="token plain">        _setupHTTPCollector() # 创建 HAR 文件</span></div><div class="token-line"><span class="token plain">        _setHttpChunked() # 设置 chunked </span></div><div class="token-line"><span class="token plain">        _checkWebSocket() # 检查 websocket 环境是否正常</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        parseTargetDirect() # 解析数据库链接</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        if any((conf.url, conf.logFile, conf.bulkFile, conf.requestFile, conf.googleDork, conf.stdinPipe)):</span></div><div class="token-line"><span class="token plain">            _setHostname() # 设置 conf 中的 hostname</span></div><div class="token-line"><span class="token plain">            _setHTTPTimeout() # 设置请求最大超时时间</span></div><div class="token-line"><span class="token plain">            _setHTTPExtraHeaders() # 设置请求的 headers</span></div><div class="token-line"><span class="token plain">            _setHTTPCookies() # 设置请求的 cookies</span></div><div class="token-line"><span class="token plain">            _setHTTPReferer() # 设置请求的 referer</span></div><div class="token-line"><span class="token plain">            _setHTTPHost() # 设置请求的 host</span></div><div class="token-line"><span class="token plain">            _setHTTPUserAgent() # 设置请求的 UA</span></div><div class="token-line"><span class="token plain">            _setHTTPAuthentication() # 设置请求的认证信息</span></div><div class="token-line"><span class="token plain">            _setHTTPHandlers() # 设置对应的请求处理类</span></div><div class="token-line"><span class="token plain">            _setDNSCache() # 设置 dns 缓存</span></div><div class="token-line"><span class="token plain">            _setSocketPreConnect() </span></div><div class="token-line"><span class="token plain">            _setSafeVisit()</span></div><div class="token-line"><span class="token plain">            _doSearch() # 处理 Google Dork 解析</span></div><div class="token-line"><span class="token plain">            _setStdinPipeTargets() # 从 pipeline 中获取 targets</span></div><div class="token-line"><span class="token plain">            _setBulkMultipleTargets() # 从文本中获取 targets</span></div><div class="token-line"><span class="token plain">            _checkTor() # 检查 tor 代理</span></div><div class="token-line"><span class="token plain">            _setCrawler() # 设置爬虫信息</span></div><div class="token-line"><span class="token plain">            _findPageForms() # 寻找页面中的表单</span></div><div class="token-line"><span class="token plain">            _setDBMS() # 设置 DBMS</span></div><div class="token-line"><span class="token plain">            _setTechnique() # 设置检测类型</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        _setThreads() # 设置线程数</span></div><div class="token-line"><span class="token plain">        _setOS() # 设置操作系统类型</span></div><div class="token-line"><span class="token plain">        _setWriteFile() # 设置文件写入信息</span></div><div class="token-line"><span class="token plain">        _setMetasploit() # 设置 MSF 信息</span></div><div class="token-line"><span class="token plain">        _setDBMSAuthentication() # 设置 DBMS 的认证信息</span></div><div class="token-line"><span class="token plain">        loadBoundaries() # 加载 Boundaries</span></div><div class="token-line"><span class="token plain">        loadPayloads() # 加载 Payloads</span></div><div class="token-line"><span class="token plain">        _setPrefixSuffix() # 设置新的 prefix 和sufix</span></div><div class="token-line"><span class="token plain">        update() # 更新 sqlmap</span></div><div class="token-line"><span class="token plain">        _loadQueries() # 加载 queries</span></div></pre></div><p>其实我们只需要根据后面的注释，了解每个函数大概实现的功能就可以了，它们有些与初始化配置文件相关，有些与实际攻击过程相关。实际上，这里只是会初步解析命令行传入的参数，并不涉及到大部分函数的调用过程，在这里我们不需要理解的很细致，我们的核心关注点应该在注入逻辑上。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">init()</span></div><div class="token-line"><span class="token plain">            if not conf.updateAll:</span></div><div class="token-line"><span class="token plain">                # Postponed imports (faster start)</span></div><div class="token-line"><span class="token plain">                if conf.smokeTest:</span></div><div class="token-line"><span class="token plain">                    from lib.core.testing import smokeTest</span></div><div class="token-line"><span class="token plain">                    os._exitcode = 1 - (smokeTest() or 0)</span></div><div class="token-line"><span class="token plain">                elif conf.vulnTest:</span></div><div class="token-line"><span class="token plain">                    from lib.core.testing import vulnTest</span></div><div class="token-line"><span class="token plain">                    os._exitcode = 1 - (vulnTest() or 0)</span></div><div class="token-line"><span class="token plain">                else:</span></div><div class="token-line"><span class="token plain">                    from lib.controller.controller import start</span></div><div class="token-line"><span class="token plain">                    if conf.profile:</span></div><div class="token-line"><span class="token plain">                        from lib.core.profiling import profile</span></div><div class="token-line"><span class="token plain">                        globals()[&quot;start&quot;] = start</span></div><div class="token-line"><span class="token plain">                        profile()</span></div><div class="token-line"><span class="token plain">                    else:</span></div><div class="token-line"><span class="token plain">                        try:</span></div><div class="token-line"><span class="token plain">                            if conf.crawlDepth and conf.bulkFile:</span></div><div class="token-line"><span class="token plain">                                targets = getFileItems(conf.bulkFile)</span></div><div class="token-line"><span class="token plain">                                for i in xrange(len(targets)):</span></div><div class="token-line"><span class="token plain">                                    target = None</span></div><div class="token-line"><span class="token plain">                                    try:</span></div><div class="token-line"><span class="token plain">                                        kb.targets = OrderedSet()</span></div><div class="token-line"><span class="token plain">                                        target = targets[i]</span></div><div class="token-line"><span class="token plain">                                        if not re.search(r&quot;(?i)\Ahttp[s]*://&quot;, target)</span></div><div class="token-line"><span class="token plain">                                            target = &quot;http://%s&quot; % target</span></div><div class="token-line"><span class="token plain">                                        infoMsg = &quot;starting crawler for target URL &#x27;%s&#x27; (%d/%d)&quot; % (target, i + 1, len(targets))</span></div><div class="token-line"><span class="token plain">                                        logger.info(infoMsg)</span></div><div class="token-line"><span class="token plain">                                        crawl(target)</span></div><div class="token-line"><span class="token plain">                                    except Exception as ex:</span></div><div class="token-line"><span class="token plain">                                        if target and not isinstance(ex, SqlmapUserQuitException):</span></div><div class="token-line"><span class="token plain">                                            errMsg = &quot;problem occurred while crawling &#x27;%s&#x27; (&#x27;%s&#x27;)&quot; % (target, getSafeExString(ex))</span></div><div class="token-line"><span class="token plain">                                            logger.error(errMsg)</span></div><div class="token-line"><span class="token plain">                                        else:</span></div><div class="token-line"><span class="token plain">                                            raise</span></div><div class="token-line"><span class="token plain">                                    else:</span></div><div class="token-line"><span class="token plain">                                        if kb.targets:</span></div><div class="token-line"><span class="token plain">                                            start()</span></div></pre></div><p>学习完毕init方法之后，我们就完成了整个初始化过程。</p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="/blog/web漏洞挖掘实战/04.注入/03#总结"><span class="icon icon-link"></span></a>总结</h2><p>这节课，我们学习了自动化SQL注入测试工具–sqlmap的设计思路。</p><p>作为业内知名且常用的SQL自动化注入工具，sqlmap已经持续维护了超过10年的时间。作为有梦想的工程师，我们不仅需要掌握如何使用sqlmap，更要学习它的设计思想和工作原理，站在巨人的肩膀上才能帮助我们看的更远。</p><p>sqlmap的代码量十分庞大，因为掌握其核心设计思想和工作原理就十分重要，这会成为我们深入代码逻辑探索的风向标。因此，在了解如何获取sqlmap代码以及如何搭建sqlmap的运行环境后，我们进一步学习了sqlmap设计原理的相关知识，比如sqlmap的配置文件介绍等。</p><p>接下来，与大部分开源软件的设计思路类似，sqlmap在真正开始工作前需要做大量的初始化工作，因此我们对sqlmap的初始化流程进行了梳理。经过分析，总结出它主要包含有全局变量初始化、命令行参数解析、全局变量赋值以及环境检查这四个通用的初始化步骤，然后我们又具体学习了这四个流程是如何实现的。</p><p>在学习完sqlmap的初始化后，很快我们就会进入sqlmap的工作流程学习，这时我们需要重新审视sqlmap的设计架构，了解我们所处的位置。</p><p><img src="https://static001.geekbang.org/resource/image/0f/bc/0fbeefeec2d41ffd8949e164076180bc.png?wh=1436x768" alt="图片"/></p><p>这是我整理的一幅sqlmap工作原理图，在本节课我们学习了sqlmap工作前的初始化流程，这些内容可以帮助你认识到sqlmap设计时的底层逻辑。下节课我们将正式开始学习sqlmap的自动化注入功能，它的起点是预注入，也是我们在前几节课程中所讲的起手式阶段。</p><h2 id="思考"><a aria-hidden="true" tabindex="-1" href="/blog/web漏洞挖掘实战/04.注入/03#思考"><span class="icon icon-link"></span></a>思考</h2><p>sqlmap的初始化流程有什么值得改进的地方吗？</p><p>欢迎在评论区留下你的思考，我们下节课再见。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/docs/web漏洞挖掘实战/04.注入/03.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">5/2/2022 10:56:59</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog/umi.js"></script>
  </body>
</html>
