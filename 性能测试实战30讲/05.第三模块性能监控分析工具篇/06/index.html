<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog/umi.css" />
    <script>
      window.routerBase = "/blog";
    </script>
    <script>
      //! umi version: 3.5.17
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.indexOf(e) > -1 ? e : r[0]
        );
      })();
    </script>
    <title>21丨Tomcat：中间件监控及常用计数器解析</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/性能测试实战30讲/05.第三模块性能监控分析工具篇/06" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>计算机基础<ul><li><a href="/blog/编译原理之美">编译原理之美</a></li><li><a href="/blog/编译原理实战">编译原理实战</a></li><li><a href="/blog/深入浅出计算机组成原理">深入浅出计算机组成原理</a></li><li><a href="/blog/详解http">详解http</a></li><li><a href="/blog/计算机网络通关29讲">计算机网络通关29讲</a></li><li><a href="/blog/网络排查案例课">网络排查案例课</a></li><li><a href="/blog/linux操作系统">linux操作系统</a></li><li><a href="/blog/linux性能优化实战">linux性能优化实战</a></li><li><a href="/blog/程序员数学基础">程序员数学基础</a></li><li><a href="/blog/趣谈网络协议">趣谈网络协议</a></li><li><a href="/blog/操作系统实战">操作系统实战</a></li><li><a href="/blog/软件工程之美">软件工程之美</a></li><li><a href="/blog/sql必知必会">sql必知必会</a></li><li><a href="/blog/操作系统实战45讲">操作系统实战45讲</a></li><li><a href="/blog/网络编程实战">网络编程实战</a></li></ul></span><span>算法<ul><li><a href="/blog/常用算法25讲">常用算法25讲</a></li><li><a href="/blog/数据结构与算法之美">数据结构与算法之美</a></li><li><a href="/blog/业务开发算法50讲">业务开发算法50讲</a></li><li><a href="/blog/动态规划面试宝典">动态规划面试宝典</a></li></ul></span><span>前端开发<ul><li><a href="/blog/浏览器工作原理与实践">浏览器工作原理与实践</a></li><li><a href="/blog/新时代产品经理进阶之路">新时代产品经理进阶之路</a></li><li><a href="/blog/全栈工程师修炼指南">全栈工程师修炼指南</a></li><li><a href="/blog/flutter核心技术与实战">flutter核心技术与实战</a></li><li><a href="/blog/java-script核心原理解析">java-script核心原理解析</a></li><li><a href="/blog/说透低代码">说透低代码</a></li><li><a href="/blog/nodejs应用开发实战">nodejs应用开发实战</a></li><li><a href="/blog/反爬虫兵法演绎20讲">反爬虫兵法演绎20讲</a></li><li><a href="/blog/reactnative新架构实战课">reactnative新架构实战课</a></li><li><a href="/blog/正则表达式入门">正则表达式入门</a></li><li><a href="/blog/重学前端">重学前端</a></li><li><a href="/blog/serverless入门课">serverless入门课</a></li><li><a href="/blog/type-script入门实战笔记">type-script入门实战笔记</a></li><li><a href="/blog/图解googlev8">图解googlev8</a></li><li><a href="/blog/vue3源码分析">vue3源码分析</a></li><li><a href="/blog/玩转Vue3全家桶">玩转Vue3全家桶</a></li><li><a href="/blog/webassembly入门">webassembly入门</a></li><li><a href="/blog/手把手带你写一个Web框架">手把手带你写一个Web框架</a></li><li><a href="/blog/web漏洞挖掘实战">web漏洞挖掘实战</a></li><li><a href="/blog/跟月影学可视化">跟月影学可视化</a></li><li><a href="/blog/搞定音频技术">搞定音频技术</a></li><li><a href="/blog/攻克视频技术">攻克视频技术</a></li></ul></span><span>前端工程化<ul><li><a href="/blog/logger">logger</a></li><li><a href="/blog/webpack">webpack</a></li><li><a href="/blog/webpackChain">webpackChain</a></li></ul></span><span>前端性能优化<ul><li><a href="/blog/react性能调优">react性能调优</a></li></ul></span><span>软件测试<ul><li><a href="/blog/全链路压测实战30讲">全链路压测实战30讲</a></li><li><a aria-current="page" class="active" href="/blog/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog/自动化测试高手课">自动化测试高手课</a></li><li><a href="/blog/软件测试52讲">软件测试52讲</a></li></ul></span><span>面试<ul><li><a href="/blog/面试现场">面试现场</a></li></ul></span><span>杂谈<ul><li><a href="/blog/超级访谈对话张雪峰">超级访谈对话张雪峰</a></li><li><a href="/blog/Git实战手册">Git实战手册</a></li><li><a href="/blog/NodeJS">NodeJS</a></li><li><a href="/blog/ReactJS">ReactJS</a></li><li><a href="/blog/UI设计">UI设计</a></li><li><a href="/blog/webpack4系列教程">webpack4系列教程</a></li><li><a href="/blog/前端知识体系">前端知识体系</a></li><li><a href="/blog/剑指offer刷题笔记">剑指offer刷题笔记</a></li><li><a href="/blog/思考与成长">思考与成长</a></li><li><a href="/blog/设计模式手册">设计模式手册</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>计算机基础<ul><li><a href="/blog/编译原理之美">编译原理之美</a></li><li><a href="/blog/编译原理实战">编译原理实战</a></li><li><a href="/blog/深入浅出计算机组成原理">深入浅出计算机组成原理</a></li><li><a href="/blog/详解http">详解http</a></li><li><a href="/blog/计算机网络通关29讲">计算机网络通关29讲</a></li><li><a href="/blog/网络排查案例课">网络排查案例课</a></li><li><a href="/blog/linux操作系统">linux操作系统</a></li><li><a href="/blog/linux性能优化实战">linux性能优化实战</a></li><li><a href="/blog/程序员数学基础">程序员数学基础</a></li><li><a href="/blog/趣谈网络协议">趣谈网络协议</a></li><li><a href="/blog/操作系统实战">操作系统实战</a></li><li><a href="/blog/软件工程之美">软件工程之美</a></li><li><a href="/blog/sql必知必会">sql必知必会</a></li><li><a href="/blog/操作系统实战45讲">操作系统实战45讲</a></li><li><a href="/blog/网络编程实战">网络编程实战</a></li></ul></li><li>算法<ul><li><a href="/blog/常用算法25讲">常用算法25讲</a></li><li><a href="/blog/数据结构与算法之美">数据结构与算法之美</a></li><li><a href="/blog/业务开发算法50讲">业务开发算法50讲</a></li><li><a href="/blog/动态规划面试宝典">动态规划面试宝典</a></li></ul></li><li>前端开发<ul><li><a href="/blog/浏览器工作原理与实践">浏览器工作原理与实践</a></li><li><a href="/blog/新时代产品经理进阶之路">新时代产品经理进阶之路</a></li><li><a href="/blog/全栈工程师修炼指南">全栈工程师修炼指南</a></li><li><a href="/blog/flutter核心技术与实战">flutter核心技术与实战</a></li><li><a href="/blog/java-script核心原理解析">java-script核心原理解析</a></li><li><a href="/blog/说透低代码">说透低代码</a></li><li><a href="/blog/nodejs应用开发实战">nodejs应用开发实战</a></li><li><a href="/blog/反爬虫兵法演绎20讲">反爬虫兵法演绎20讲</a></li><li><a href="/blog/reactnative新架构实战课">reactnative新架构实战课</a></li><li><a href="/blog/正则表达式入门">正则表达式入门</a></li><li><a href="/blog/重学前端">重学前端</a></li><li><a href="/blog/serverless入门课">serverless入门课</a></li><li><a href="/blog/type-script入门实战笔记">type-script入门实战笔记</a></li><li><a href="/blog/图解googlev8">图解googlev8</a></li><li><a href="/blog/vue3源码分析">vue3源码分析</a></li><li><a href="/blog/玩转Vue3全家桶">玩转Vue3全家桶</a></li><li><a href="/blog/webassembly入门">webassembly入门</a></li><li><a href="/blog/手把手带你写一个Web框架">手把手带你写一个Web框架</a></li><li><a href="/blog/web漏洞挖掘实战">web漏洞挖掘实战</a></li><li><a href="/blog/跟月影学可视化">跟月影学可视化</a></li><li><a href="/blog/搞定音频技术">搞定音频技术</a></li><li><a href="/blog/攻克视频技术">攻克视频技术</a></li></ul></li><li>前端工程化<ul><li><a href="/blog/logger">logger</a></li><li><a href="/blog/webpack">webpack</a></li><li><a href="/blog/webpackChain">webpackChain</a></li></ul></li><li>前端性能优化<ul><li><a href="/blog/react性能调优">react性能调优</a></li></ul></li><li>软件测试<ul><li><a href="/blog/全链路压测实战30讲">全链路压测实战30讲</a></li><li><a aria-current="page" class="active" href="/blog/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog/自动化测试高手课">自动化测试高手课</a></li><li><a href="/blog/软件测试52讲">软件测试52讲</a></li></ul></li><li>面试<ul><li><a href="/blog/面试现场">面试现场</a></li></ul></li><li>杂谈<ul><li><a href="/blog/超级访谈对话张雪峰">超级访谈对话张雪峰</a></li><li><a href="/blog/Git实战手册">Git实战手册</a></li><li><a href="/blog/NodeJS">NodeJS</a></li><li><a href="/blog/ReactJS">ReactJS</a></li><li><a href="/blog/UI设计">UI设计</a></li><li><a href="/blog/webpack4系列教程">webpack4系列教程</a></li><li><a href="/blog/前端知识体系">前端知识体系</a></li><li><a href="/blog/剑指offer刷题笔记">剑指offer刷题笔记</a></li><li><a href="/blog/思考与成长">思考与成长</a></li><li><a href="/blog/设计模式手册">设计模式手册</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog/性能测试实战30讲/01.开篇词">01.开篇词</a><ul><li><a href="/blog/性能测试实战30讲/01.开篇词/01"><span>开篇词丨“老板，之前咱TPS是100，我优化完是10000”</span></a></li></ul></li><li><a href="/blog/性能测试实战30讲/02.第一模块性能测试基础篇">02.第一模块性能测试基础篇</a><ul><li><a href="/blog/性能测试实战30讲/02.第一模块性能测试基础篇/01"><span>01丨性能综述：性能测试的概念到底是什么？</span></a></li><li><a href="/blog/性能测试实战30讲/02.第一模块性能测试基础篇/02"><span>02丨性能综述：TPS和响应时间之间是什么关系？</span></a></li><li><a href="/blog/性能测试实战30讲/02.第一模块性能测试基础篇/03"><span>03丨性能综述：怎么理解TPS、QPS、RT、吞吐量这些性能指标？</span></a></li><li><a href="/blog/性能测试实战30讲/02.第一模块性能测试基础篇/04"><span>04丨JMeter和LoadRunner：要知道工具仅仅只是工具</span></a></li><li><a href="/blog/性能测试实战30讲/02.第一模块性能测试基础篇/05"><span>05丨指标关系：你知道并发用户数应该怎么算吗？</span></a></li><li><a href="/blog/性能测试实战30讲/02.第一模块性能测试基础篇/06"><span>06丨倾囊相授：我毕生所学的性能分析思路都在这里了</span></a></li></ul></li><li><a href="/blog/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇">03.第二模块性能测试工具及性能场景篇</a><ul><li><a href="/blog/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/01"><span>07丨性能测试工具：如何录制脚本？</span></a></li><li><a href="/blog/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/02"><span>08丨案例： 手把手教你编写最简单的性能脚本</span></a></li><li><a href="/blog/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/03"><span>09丨关联和断言：一动一静，核心都是在取数据</span></a></li><li><a href="/blog/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/04"><span>10丨案例：在JMeter中如何设置参数化数据？</span></a></li><li><a href="/blog/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/05"><span>11丨性能脚本：用案例和图示帮你理解HTTP协议</span></a></li><li><a href="/blog/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/06"><span>12丨性能场景：做参数化之前，我们需要考虑什么？</span></a></li><li><a href="/blog/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/07"><span>13丨性能测试场景：如何进行场景设计？</span></a></li><li><a href="/blog/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/08"><span>14丨性能测试场景：如何理解业务模型？</span></a></li><li><a href="/blog/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/09"><span>15丨性能测试场景：如何进行监控设计？</span></a></li></ul></li><li><a href="/blog/性能测试实战30讲/04.春节策划">04.春节策划</a><ul><li><a href="/blog/性能测试实战30讲/04.春节策划/01"><span>春节策划丨性能评估和性能分析试题，等你挑战！</span></a></li><li><a href="/blog/性能测试实战30讲/04.春节策划/02"><span>春节策划丨快来挑战一下自己的分析逻辑吧！</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇">05.第三模块性能监控分析工具篇</a><ul><li><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/01"><span>16丨案例：性能监控工具之Grafana+Prometheus+Exporters</span></a></li><li><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/02"><span>17丨CentOS：操作系统级监控及常用计数器解析（上）</span></a></li><li><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/03"><span>18丨CentOS：操作系统级监控及常用计数器解析（下）</span></a></li><li><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/04"><span>19丨Java &amp; C ++：代码级监控及常用计数器解析（上）</span></a></li><li><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/05"><span>20丨Java &amp; C ++：代码级监控及常用计数器解析（下）</span></a></li><li><a aria-current="page" class="active" href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06"><span>21丨Tomcat：中间件监控及常用计数器解析</span></a></li><li><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/07"><span>22丨MySQL：数据库级监控及常用计数器解析（上）</span></a></li><li><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/08"><span>23丨MySQL：数据库级监控及常用计数器解析（下）</span></a></li><li><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/09"><span>24丨Kafka：性能监控工具之队列级监控及常用计数器解析</span></a></li><li><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/10"><span>25丨SkyWalking：性能监控工具之链路级监控及常用计数器解析</span></a></li></ul></li><li><a href="/blog/性能测试实战30讲/06.第四模块性能测试分析实战篇">06.第四模块性能测试分析实战篇</a><ul><li><a href="/blog/性能测试实战30讲/06.第四模块性能测试分析实战篇/01"><span>26丨案例：手把手带你理解TPS趋势分析</span></a></li><li><a href="/blog/性能测试实战30讲/06.第四模块性能测试分析实战篇/02"><span>27丨案例：带宽消耗以及Swap（上）</span></a></li><li><a href="/blog/性能测试实战30讲/06.第四模块性能测试分析实战篇/03"><span>28丨案例：带宽消耗以及Swap（下）</span></a></li><li><a href="/blog/性能测试实战30讲/06.第四模块性能测试分析实战篇/04"><span>29丨案例：如何应对因网络参数导致的TPS呈锯齿状？</span></a></li><li><a href="/blog/性能测试实战30讲/06.第四模块性能测试分析实战篇/05"><span>30丨案例：为什么参数化数据会导致TPS突然下降？</span></a></li><li><a href="/blog/性能测试实战30讲/06.第四模块性能测试分析实战篇/06"><span>31丨案例：当磁盘参数导致I/O高的时候，应该怎么办？</span></a></li><li><a href="/blog/性能测试实战30讲/06.第四模块性能测试分析实战篇/07"><span>32丨当Postgres磁盘读引起I/O高的时候，应该怎么办？</span></a></li></ul></li><li><a href="/blog/性能测试实战30讲/07.结束语">07.结束语</a><ul><li><a href="/blog/性能测试实战30讲/07.结束语/01"><span>结束语丨见过林林总总的乱象，才知未来的无限可能</span></a></li></ul></li><li><a href="/blog/性能测试实战30讲/08.结课测试">08.结课测试</a><ul><li><a href="/blog/性能测试实战30讲/08.结课测试/01"><span>期末测试题丨快来测试一下你对性能掌握到何种程度了吧！</span></a></li></ul></li><li><a href="/blog/性能测试实战30讲/summary">性能测试实战30讲</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="运行模式之争" data-depth="2"><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#运行模式之争"><span>运行模式之争</span></a></li><li title="请求量、请求时间、响应时间" data-depth="2"><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#请求量请求时间响应时间"><span>请求量、请求时间、响应时间</span></a></li><li title="协议 HTTP、HTTPS" data-depth="2"><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#协议-httphttps"><span>协议 HTTP、HTTPS</span></a></li><li title="线程池" data-depth="3"><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#线程池"><span>线程池</span></a></li><li title="场景一：当压力线程远远小于服务端线程数时" data-depth="3"><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#场景一当压力线程远远小于服务端线程数时"><span>场景一：当压力线程远远小于服务端线程数时</span></a></li><li title="场景二：当压力线程数通过递增，慢慢超过服务端线程数时" data-depth="3"><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#场景二当压力线程数通过递增慢慢超过服务端线程数时"><span>场景二：当压力线程数通过递增，慢慢超过服务端线程数时</span></a></li><li title="场景三：当压力线程数远高于服务端线程数时" data-depth="3"><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#场景三当压力线程数远高于服务端线程数时"><span>场景三：当压力线程数远高于服务端线程数时</span></a></li><li title="场景四：设置最大最小空闲线程数" data-depth="3"><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#场景四设置最大最小空闲线程数"><span>场景四：设置最大最小空闲线程数</span></a></li><li title="禁用AJP" data-depth="3"><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#禁用ajp"><span>禁用AJP</span></a></li><li title="压缩" data-depth="3"><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#压缩"><span>压缩</span></a></li><li title="acceptCount" data-depth="3"><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#acceptcount"><span>acceptCount</span></a></li><li title="acceptCount=“10000”" data-depth="3"><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#acceptcount10000"><span>acceptCount=“10000”</span></a></li><li title="acceptCount=“100”" data-depth="3"><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#acceptcount100"><span>acceptCount=“100”</span></a></li><li title="connectionTimeout" data-depth="3"><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#connectiontimeout"><span>connectionTimeout</span></a></li><li title="总结" data-depth="2"><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#总结"><span>总结</span></a></li><li title="思考题" data-depth="2"><a href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#思考题"><span>思考题</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="21丨tomcat中间件监控及常用计数器解析"><a aria-hidden="true" tabindex="-1" href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#21丨tomcat中间件监控及常用计数器解析"><span class="icon icon-link"></span></a>21丨Tomcat：中间件监控及常用计数器解析</h1><p>在当今Spring Cloud微服务架构盛行的时代，Tomcat仍然作为应用最广的应用服务器而存在着，所以我们不得不说一说对它的性能分析。</p><p>很多时候，我们做性能测试分析时，都会把Tomcat这类的应用弄混淆。对它的监控和分析，总是会和JDK、框架代码、业务代码混合来看，这就导致了分析上的混乱。我们应该把这些分析内容分隔开来，哪些是tomcat，哪些是JDK等。</p><p>在我看来，Tomcat、WebLogic、WebSphere、JBoss等，它们都具有同样的分析思路。因为Tomcat的市场范围更大，所以，今天，我们以它为例来说明这类应用应该如何分析。</p><p>首先我们得知道它的架构是什么样的。</p><p><img src="https://static001.geekbang.org/resource/image/bb/10/bb22a5bea7abe133a8db73e2fe311f10.jpg?wh=1650*1123" alt=""/></p><p>这是一个在网上随处可见的架构图，它能告诉我们Tomcat内部如何运作。如果你有兴趣，还可以看一下官方对它的架构描述。</p><p>然而，我们做性能分析的人真的要完全掌握这些细节吗？当然不是。从经验上来说，基本上有几大方面，是Tomcat优化时需要关注的。</p><p>如下图所示：</p><p><img src="https://static001.geekbang.org/resource/image/c1/90/c1c6e4a479c53a3365cbffe476ab6090.png?wh=1353*904" alt=""/></p><p>最上面，我放了两个框，分别是操作系统和JDK。因为要调优Tomcat，和这两者非常相关，但是操作系统和JDK又各自有独立的分析逻辑，而在本篇中，我专门讲Tomcat类型的组件，所以上面两块的内容我将尽量不涉及，以免混乱。</p><p>在Tomcat的性能分析中，我将我认为重要的几个技术点列在了思维导图中，同时也对它们做了重要程度的标识。在我分析经验中，这些内容已经包括了大部分的优化场景。</p><h2 id="运行模式之争"><a aria-hidden="true" tabindex="-1" href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#运行模式之争"><span class="icon icon-link"></span></a>运行模式之争</h2><p>有很多人对运行模式非常敏感，大家也看到经常有文章说：“对于性能来说，显然是BIO&lt;NIO&lt;APR的。”然而也有人做过测试说，其实不见得BIO性能就最差，这取决于应用场景；也有人说在压力低的情况下，显然BIO的性能更高。</p><p>从我的经验上来说，真的没必要纠结这一点。本着对Tomcat官方的信任，我觉得最好就是用官方给的默认运行模式，它肯定是经过了更严格的测试才被选择的。这就跟相信世上好人多是一样的道理。</p><p>现在新的Tomcat版本中默认的是NIO了，你可以在启动日志中看到相应的信息，如下所示：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">21-Jan-2020 16:50:57.989 INFO [main] org.apache.coyote.AbstractProtocol.init Initializing ProtocolHandler [&quot;https-jsse-nio-443&quot;]</span></div></pre></div><p>简单地说BIO和NIO的区别如下面两张图所示。</p><p>BIO图示：</p><p><img src="https://static001.geekbang.org/resource/image/60/74/60199e42afcd7283eb19616506aa5874.jpg?wh=742*139" alt=""/></p><p>NIO图示：</p><p><img src="https://static001.geekbang.org/resource/image/28/44/286d1ba0019496abcb5f545d40b3c844.jpg?wh=1081*205" alt=""/><br/>要理解这个区别，首先得知道几个知识点：</p><ol><li>Acceptor是TCP层面的东西，它负责完成TCP握手的过程，放入全连接队列，然后将数据生成request，调用servlet容器处理。</li><li>而Worker干的就是接到request数据，处理后给出response。</li><li>Poller是一个队列，属于典型的生产者-消费者模式。</li></ol><p>知道了这些，你就会明白其实对于Acceptor和Worker本身来说，仍然是阻塞的。而这个Poller只能是在大并发的时候，可以hold住更多的请求而已，看起来Tomcat处理请求的容量增加了，但是我们还是要在具体的应用中去测试，来比对响应时间的差异。</p><p>但是还有一点区别我们得知道，Tomcat的keepAliveTimeout参数默认使用的是connectionTimeout的值。这样一来，由于使用BIO时，Acceptor读取socket中的数据并传递给Worker这个过程是阻塞的，意味着当代码执行到Worker中时，这个socket仍然被占着；而使用NIO时，Acceptor读取socket数据后交给了Poller了，Worker从Poller中得到请求内容并处理，这个过程就分开了，这样Worker在处理时就不会阻塞socket，所以Tomcat可以处理更多的socket，这才是NIO性能提升的关键点。</p><p>而APR是个啥呢？它是利用了OS中的能力来进行高并发地文件读取或者网络传输，来提高对静态文件的处理。有很多网上的实验结果都可以证明，在具体的应用中它并没有比NIO的性能高到哪里去，并且配置起来还麻烦，所以这个模式现在并没有很广泛的使用。</p><p>所以在Tomcat中，运行模式之争应该说已经不存在了。</p><h2 id="请求量请求时间响应时间"><a aria-hidden="true" tabindex="-1" href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#请求量请求时间响应时间"><span class="icon icon-link"></span></a>请求量、请求时间、响应时间</h2><p>这是我希望你能在分析Tomcat时关注的内容。我们有很多种方式可以看这些信息，最简单的就是访问日志了。通过在conf/server.xml中做如下配置：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</span></div><div class="token-line"><span class="token plain">                 prefix=&quot;localhost_access_log&quot; suffix=&quot;.txt&quot;</span></div><div class="token-line"><span class="token plain">                 pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b %D %F&quot; /&gt;</span></div></pre></div><p>其中%D就是请求时间，%F是响应时间。配置了之后，在日志中就会看到如下内容：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">172.17.211.144 - - [21/Jan/2020:18:06:57 +0800] &quot;POST /back/save HTTP/1.1&quot; 200 14 29 29</span></div><div class="token-line"><span class="token plain">    172.17.211.144 - - [21/Jan/2020:18:06:57 +0800] &quot;GET /validate/code/pic HTTP/1.1&quot; 200 541 5 0</span></div></pre></div><p>最后两列就是请求时间和响应时间。通过这两个时间的比对，你就可以知道，Tomcat本身消耗了多少时间以及Tomcat之后的操作又消耗了多少时间。</p><p>当然，如果你喜欢的话，也可以看这样的监控图表。</p><p><img src="https://static001.geekbang.org/resource/image/18/9b/18ceb1d636507f8a11f039f54054c59b.png?wh=802*327" alt=""/></p><p>这是一个小工具Probe的监控数据，从这里，你可以知道Tomcat这段时间处理了多少请求，以及处理这些请求的时间、最大时间、最小时间和平均时间。</p><p>但是！我不建议用这个工具来监控Tomcat，因为它性能差。你可能会问，那你还说它干吗？因为其他的性能监控工具中，很少有见到这个角度的图表展示，在这里只是为了告诉你，分析Tomcat全局性能状态时，可以通过总请求数，以及平均响应时间来看Tomcat的全局处理能力如何。</p><p>当然这些数据你同样可以通过分析访问日志获取。</p><p>显然有了这些数据，我们就可以做一个大体的判断了。在服务节点多的时候，只要看这里的平均响应时间，你就能知道在这个Tomcat上有没有消耗掉你在压力工具中看到的响应时间。</p><p>下面我通过测试结果来说明几个Tomcat中常用的优化动作。</p><p>在展示优化动作之前，先看一下connector基本配置：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;Connector</span></div><div class="token-line"><span class="token plain">        SSLEnabled=&quot;true&quot;</span></div><div class="token-line"><span class="token plain">        acceptCount=&quot;100&quot;</span></div><div class="token-line"><span class="token plain">        clientAuth=&quot;false&quot;</span></div><div class="token-line"><span class="token plain">        disableUploadTimeout=&quot;true&quot;</span></div><div class="token-line"><span class="token plain">        enableLookups=&quot;false&quot;</span></div><div class="token-line"><span class="token plain">        maxThreads=&quot;25&quot;</span></div><div class="token-line"><span class="token plain">        port=&quot;443&quot;</span></div><div class="token-line"><span class="token plain">        connectionTimeout=&quot;20000&quot;</span></div><div class="token-line"><span class="token plain">        keystoreFile=&quot;/PathToTomcat/bin/server.keystore&quot;</span></div><div class="token-line"><span class="token plain">        keystorePass=&quot;12345678&quot;</span></div><div class="token-line"><span class="token plain">        protocol=&quot;org.apache.coyote.http11.Http11NioProtocol&quot;</span></div><div class="token-line"><span class="token plain">        scheme=&quot;https&quot;</span></div><div class="token-line"><span class="token plain">        secure=&quot;true&quot;</span></div><div class="token-line"><span class="token plain">        sslProtocol=&quot;TLS&quot; /&gt;</span></div></pre></div><p>这只是一个基本配置。至于是不是最优的配置，我们需要在针对一个应用测试的过程中慢慢来看。</p><p>比如有人会说，你这里为什么不配置minSpareThreads和maxSpareThreads之类的参数？首先，我们要知道，为什么要配置这两个参数？对于一个线程数超高的应用来说，长期维护大量的线程肯定会导致操作系统中context switch的增加，在一个应用的波峰波谷差别较大的时候，我们用这两个参数其实是为了减少在波谷时产生的维护成本。但是同时你也要知道，在线程不够用的时候，开新的线程也同样需要成本，所以这两个值需不需要配置，完全取决于应用场景的具体测试结果。</p><p>总之，所有的配置都需要在具体的应用场景测试了之后，再下定论，别凭感觉。</p><h2 id="协议-httphttps"><a aria-hidden="true" tabindex="-1" href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#协议-httphttps"><span class="icon icon-link"></span></a>协议 HTTP、HTTPS</h2><p>我们知道在HTTPS的协议中，因为加入了SSL证书会导致性能下降，但是对有些应用来说，又不得不用SSL证书。在这里我自己配置了一个证书，来给你看看证书对性能产生的影响。</p><p><img src="https://static001.geekbang.org/resource/image/a7/9a/a7c39bf9d167036fe1373f2d729f7b9a.png?wh=484*542" alt=""/></p><p>我的证书配置是这样的：</p><ul><li>根证书：RSA证书、sha256，8192位</li><li>中级证书：RSA，sha256、4096位</li><li>终端证书：RSA，sha256、4096位</li></ul><p>一般情况下，SSL证书都是分为三层的。在这个例子中，我生成的时候还特意用了高位数，位数越高，对性能影响越大，因为计算成本增加了。现在我们在市场上买的证书，根据价值的不同，加密方式和位数都会不一样，请稍微注意一下。</p><p>下面来看看测试结果。</p><p>Tomcat with SSL：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">summary +    588 in 00:00:13 =   46.0/s Avg:    10 Min:     1 Max:   804 Err:     0 (0.00%) Active: 1 Started: 1 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary +   4403 in 00:00:30 =  146.8/s Avg:     4 Min:     0 Max:    87 Err:     0 (0.00%) Active: 2 Started: 2 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =   4991 in 00:00:43 =  116.7/s Avg:     5 Min:     0 Max:   804 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +   7107 in 00:00:30 =  237.1/s Avg:     4 Min:     0 Max:    77 Err:     0 (0.00%) Active: 3 Started: 3 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  12098 in 00:01:13 =  166.3/s Avg:     5 Min:     0 Max:   804 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  11121 in 00:00:30 =  370.7/s Avg:     4 Min:     0 Max:    72 Err:     0 (0.00%) Active: 4 Started: 4 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  23219 in 00:01:43 =  226.0/s Avg:     4 Min:     0 Max:   804 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  12709 in 00:00:30 =  423.6/s Avg:     4 Min:     0 Max:    87 Err:     0 (0.00%) Active: 5 Started: 5 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  35928 in 00:02:13 =  270.6/s Avg:     4 Min:     0 Max:   804 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  14548 in 00:00:30 =  485.0/s Avg:     4 Min:     0 Max:    69 Err:     0 (0.00%) Active: 6 Started: 6 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  50476 in 00:02:43 =  310.1/s Avg:     4 Min:     0 Max:   804 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  15810 in 00:00:30 =  527.0/s Avg:     5 Min:     0 Max:    83 Err:     0 (0.00%) Active: 7 Started: 7 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  66286 in 00:03:13 =  343.9/s Avg:     4 Min:     0 Max:   804 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  15242 in 00:00:30 =  508.0/s Avg:     5 Min:     0 Max:    77 Err:     0 (0.00%) Active: 8 Started: 8 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  81528 in 00:03:43 =  366.0/s Avg:     4 Min:     0 Max:   804 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  16709 in 00:00:30 =  557.1/s Avg:     5 Min:     0 Max:    75 Err:     0 (0.00%) Active: 9 Started: 9 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  98237 in 00:04:13 =  388.7/s Avg:     5 Min:     0 Max:   804 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  17099 in 00:00:30 =  570.0/s Avg:     6 Min:     0 Max:   161 Err:     0 (0.00%) Active: 10 Started: 10 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 115336 in 00:04:43 =  407.9/s Avg:     5 Min:     0 Max:   804 Err:     0 (0.00%)</span></div></pre></div><p>Tomcat without SSL：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">summary +     12 in 00:00:03 =    4.2/s Avg:   148 Min:     4 Max:   937 Err:     0 (0.00%) Active: 1 Started: 1 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary +   3531 in 00:00:30 =  117.8/s Avg:     4 Min:     0 Max:    63 Err:     0 (0.00%) Active: 2 Started: 2 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =   3543 in 00:00:33 =  107.8/s Avg:     4 Min:     0 Max:   937 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +   7283 in 00:00:30 =  242.8/s Avg:     4 Min:     0 Max:    90 Err:     0 (0.00%) Active: 3 Started: 3 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  10826 in 00:01:03 =  172.2/s Avg:     4 Min:     0 Max:   937 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +   9554 in 00:00:30 =  318.5/s Avg:     3 Min:     0 Max:    35 Err:     0 (0.00%) Active: 4 Started: 4 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  20380 in 00:01:33 =  219.5/s Avg:     4 Min:     0 Max:   937 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  14747 in 00:00:30 =  491.6/s Avg:     3 Min:     0 Max:    49 Err:     0 (0.00%) Active: 5 Started: 5 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  35127 in 00:02:03 =  285.9/s Avg:     3 Min:     0 Max:   937 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  16844 in 00:00:30 =  561.4/s Avg:     3 Min:     0 Max:    47 Err:     0 (0.00%) Active: 6 Started: 6 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  51971 in 00:02:33 =  340.0/s Avg:     3 Min:     0 Max:   937 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  17547 in 00:00:30 =  585.0/s Avg:     3 Min:     0 Max:    47 Err:     0 (0.00%) Active: 7 Started: 7 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  69518 in 00:03:03 =  380.2/s Avg:     3 Min:     0 Max:   937 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  18798 in 00:00:30 =  626.6/s Avg:     4 Min:     0 Max:   213 Err:     0 (0.00%) Active: 8 Started: 8 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  88316 in 00:03:33 =  414.9/s Avg:     3 Min:     0 Max:   937 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  18529 in 00:00:30 =  617.6/s Avg:     4 Min:     0 Max:   204 Err:     0 (0.00%) Active: 9 Started: 9 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 106845 in 00:04:03 =  439.9/s Avg:     3 Min:     0 Max:   937 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  18837 in 00:00:30 =  627.9/s Avg:     4 Min:     0 Max:    53 Err:     0 (0.00%) Active: 10 Started: 10 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 125682 in 00:04:33 =  460.6/s Avg:     4 Min:     0 Max:   937 Err:     0 (0.00%)</span></div></pre></div><p>这里稍微啰嗦一下，我们以这种终端直接输出的数据看JMeter的结果时，主要关注下&quot;summary +&quot;的数据，因为&quot;summary =&quot;的数据是整个场景执行的平均数据。另外，第一行的数据会不准确，可以忽略，如果你把粒度调低一些，可以看到更细的数据。</p><p>通过上面的数据可以看到，没有SSL比有SSL证书是要高出一些TPS的。如下图所示：</p><p><img src="https://static001.geekbang.org/resource/image/a0/4e/a0c999ecb1f005daa4da51880753c34e.jpg?wh=767*445" alt=""/></p><p>显然SSL证书对性能有明显的影响了，最大的影响到18.93%，是在8个线程时，而在五六个线程时，TPS损耗有13%左右。</p><p>这和加密位数、应用场景等都有关系，所以这一段可以给你的结论就是：SSL证书对性能会有损耗。但具体损耗是多少，在你的应用场景中需要具体测试。</p><h3 id="线程池"><a aria-hidden="true" tabindex="-1" href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#线程池"><span class="icon icon-link"></span></a>线程池</h3><p>Tomcat的线程池，一直是调优Tomcat的重点对象。在我的工作经验中，我发现经常有人不太清楚对Tomcat应该配置多大的线程池。</p><p>之前，我见过有一个人在一个4C8G的机器上把一个Tomcat节点的线程池配置到了4000。我问他为什么要这么配置，他说想支持4000的并发用户。</p><p>我们先不说他有没有理解在线用户、并发用户和TPS之间的逻辑关系，只说把Tomcat配置为4000这个事情。就算Tomcat能支撑得住4000，但机器能撑得住吗？结果还没跑多少压力线程，操作系统的CS就不断走高，消耗了大量的sy CPU，只有少量的us CPU能处理正常的业务。</p><p>然后我告诉他把Tomcat线程数调到默认的200先看看，结果TPS上升了好几倍。</p><p>这就是对线程在系统中运行的逻辑不理解导致的情况。</p><p>我们在测试的时候，先得学会判断：线程数到底够不够用。要是不够用，但又有足够的硬件资源，那你可以增加线程。</p><p>但是在增加线程之前，先要判断，代码是不是运行得足够快，如果代码本身就慢，那就先优化代码，再调整线程。</p><p>这里就有一个小的分析链路了。如下所示：</p><p><img src="https://static001.geekbang.org/resource/image/72/8a/7200322d770436e0007d56eaaab5508a.png?wh=1080*553" alt=""/></p><p>怎么来判断代码运行得足够快呢？</p><p>下面我们来看几个例子，然后我会说一下如何判断代码快不快（当然这个具体的应用也有关，你还需要在具体的应用中做详细地分析哦）。</p><h3 id="场景一当压力线程远远小于服务端线程数时"><a aria-hidden="true" tabindex="-1" href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#场景一当压力线程远远小于服务端线程数时"><span class="icon icon-link"></span></a>场景一：当压力线程远远小于服务端线程数时</h3><p><img src="https://static001.geekbang.org/resource/image/8d/ca/8d0aa1603e1ab8325234ef35f445e4ca.png?wh=2396*668" alt=""/></p><p>测试结果：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">summary +    930 in 00:00:16 =   59.7/s Avg:     7 Min:     0 Max:   922 Err:     0 (0.00%) Active: 1 Started: 1 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary +   4546 in 00:00:30 =  151.6/s Avg:     3 Min:     0 Max:    46 Err:     0 (0.00%) Active: 1 Started: 1 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =   5476 in 00:00:46 =  120.2/s Avg:     3 Min:     0 Max:   922 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +   5822 in 00:00:30 =  194.0/s Avg:     2 Min:     0 Max:    32 Err:     0 (0.00%) Active: 1 Started: 1 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  11298 in 00:01:16 =  149.5/s Avg:     3 Min:     0 Max:   922 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +   5295 in 00:00:24 =  216.5/s Avg:     2 Min:     0 Max:    26 Err:     0 (0.00%) Active: 0 Started: 1 Finished: 1</span></div><div class="token-line"><span class="token plain">    summary =  16593 in 00:01:40 =  165.9/s Avg:     2 Min:     0 Max:   922 Err:     0 (0.00%)</span></div></pre></div><p>线程监控结果：</p><p><img src="https://static001.geekbang.org/resource/image/45/91/4555aa52c4ad29ca58875b43d32d5591.png?wh=1879*220" alt=""/></p><p>jvisualvm的thread监控图是每秒刷新一次，其中橙色代表TIMED_WAITING状态，没活干；绿色代表RUNNABLE状态，在干活。</p><p>通过这个测试结果，你可以看到，在只有一个压力线程的情况下，这10个Worker是轮流提供响应的。</p><p>这就是<strong>典型的线程足够用的状态</strong>。</p><h3 id="场景二当压力线程数通过递增慢慢超过服务端线程数时"><a aria-hidden="true" tabindex="-1" href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#场景二当压力线程数通过递增慢慢超过服务端线程数时"><span class="icon icon-link"></span></a>场景二：当压力线程数通过递增，慢慢超过服务端线程数时</h3><p><img src="https://static001.geekbang.org/resource/image/e5/4b/e5420d0a3eccb3fbef84c57dd322a64b.png?wh=2480*684" alt=""/><br/>测试结果：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">summary +   4529 in 00:00:22 =  203.6/s Avg:     2 Min:     0 Max:   464 Err:     0 (0.00%) Active: 2 Started: 2 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary +  11023 in 00:00:30 =  367.7/s Avg:     2 Min:     0 Max:    71 Err:     0 (0.00%) Active: 3 Started: 3 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  15552 in 00:00:52 =  297.8/s Avg:     2 Min:     0 Max:   464 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  15131 in 00:00:30 =  504.4/s Avg:     2 Min:     0 Max:   166 Err:     0 (0.00%) Active: 5 Started: 5 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  30683 in 00:01:22 =  373.2/s Avg:     2 Min:     0 Max:   464 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  17420 in 00:00:30 =  580.7/s Avg:     3 Min:     0 Max:    68 Err:     0 (0.00%) Active: 6 Started: 6 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  48103 in 00:01:52 =  428.6/s Avg:     3 Min:     0 Max:   464 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  17416 in 00:00:30 =  580.5/s Avg:     3 Min:     0 Max:    72 Err:     0 (0.00%) Active: 8 Started: 8 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  65519 in 00:02:22 =  460.7/s Avg:     3 Min:     0 Max:   464 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  17389 in 00:00:30 =  579.6/s Avg:     4 Min:     0 Max:    71 Err:     0 (0.00%) Active: 9 Started: 9 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  82908 in 00:02:52 =  481.4/s Avg:     3 Min:     0 Max:   464 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  18591 in 00:00:30 =  619.8/s Avg:     4 Min:     0 Max:    82 Err:     0 (0.00%) Active: 11 Started: 11 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 101499 in 00:03:22 =  501.9/s Avg:     3 Min:     0 Max:   464 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  18692 in 00:00:30 =  623.1/s Avg:     5 Min:     0 Max:    72 Err:     0 (0.00%) Active: 12 Started: 12 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 120191 in 00:03:52 =  517.6/s Avg:     4 Min:     0 Max:   464 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  18577 in 00:00:30 =  619.2/s Avg:     6 Min:     0 Max:    83 Err:     0 (0.00%) Active: 14 Started: 14 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 138768 in 00:04:22 =  529.2/s Avg:     4 Min:     0 Max:   464 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  19371 in 00:00:30 =  645.7/s Avg:     6 Min:     0 Max:   113 Err:     0 (0.00%) Active: 15 Started: 15 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 158139 in 00:04:52 =  541.2/s Avg:     4 Min:     0 Max:   464 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  18891 in 00:00:30 =  629.7/s Avg:     7 Min:     0 Max:   146 Err:     0 (0.00%) Active: 17 Started: 17 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 177030 in 00:05:22 =  549.4/s Avg:     4 Min:     0 Max:   464 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  19075 in 00:00:30 =  635.6/s Avg:     7 Min:     0 Max:    99 Err:     0 (0.00%) Active: 18 Started: 18 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 196105 in 00:05:52 =  556.7/s Avg:     5 Min:     0 Max:   464 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  18782 in 00:00:30 =  625.4/s Avg:     8 Min:     0 Max:   122 Err:     0 (0.00%) Active: 20 Started: 20 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 214887 in 00:06:22 =  562.1/s Avg:     5 Min:     0 Max:   464 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  18911 in 00:00:30 =  631.3/s Avg:     8 Min:     0 Max:   146 Err:     0 (0.00%) Active: 21 Started: 21 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 233798 in 00:06:52 =  567.2/s Avg:     5 Min:     0 Max:   464 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  18153 in 00:00:30 =  605.1/s Avg:     9 Min:     0 Max:   147 Err:     0 (0.00%) Active: 23 Started: 23 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 251951 in 00:07:22 =  569.7/s Avg:     5 Min:     0 Max:   464 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  14704 in 00:00:30 =  490.1/s Avg:    10 Min:     0 Max:   175 Err:     0 (0.00%) Active: 24 Started: 24 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 266655 in 00:07:52 =  564.7/s Avg:     6 Min:     0 Max:   464 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  18196 in 00:00:30 =  606.6/s Avg:    10 Min:     0 Max:   147 Err:     0 (0.00%) Active: 26 Started: 26 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 284851 in 00:08:22 =  567.2/s Avg:     6 Min:     0 Max:   464 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  17768 in 00:00:30 =  592.3/s Avg:    10 Min:     0 Max:   227 Err:     0 (0.00%) Active: 27 Started: 27 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 302619 in 00:08:52 =  568.6/s Avg:     6 Min:     0 Max:   464 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  16754 in 00:00:30 =  558.2/s Avg:    12 Min:     0 Max:   218 Err:     0 (0.00%) Active: 29 Started: 29 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 319373 in 00:09:22 =  568.0/s Avg:     7 Min:     0 Max:   464 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  17216 in 00:00:30 =  574.0/s Avg:    12 Min:     0 Max:   249 Err:     0 (0.00%) Active: 30 Started: 30 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 336589 in 00:09:52 =  568.3/s Avg:     7 Min:     0 Max:   464 Err:     0 (0.00%)</span></div></pre></div><p>线程监控结果：</p><p><img src="https://static001.geekbang.org/resource/image/15/0e/15df234451fadf3d3ab9106bb985c80e.png?wh=1879*522" alt=""/></p><p>在这个场景中，我特意把压力工具中的线程数设置得高于Tomcat线程数，并且通过递增的方式加压。</p><p>一开始线程数是足够用的，还有挺多的时间处于空闲状态。但随着压力的增加，Tomcat的线程越来越忙，直到不够用，于是Tomcat就自己调整了线程数，直到maxThreads的值。然后线程的空闲状态就越来越少，到最后几乎没有空闲状态了。</p><p>你也可以看到响应时间随着线程数的不够用而不断的增加。</p><p>这就是<strong>典型的线程配置不够的状态</strong>。</p><h3 id="场景三当压力线程数远高于服务端线程数时"><a aria-hidden="true" tabindex="-1" href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#场景三当压力线程数远高于服务端线程数时"><span class="icon icon-link"></span></a>场景三：当压力线程数远高于服务端线程数时</h3><p><img src="https://static001.geekbang.org/resource/image/88/38/88b477ca0e28afdf5d2502f2f58faa38.png?wh=2176*594" alt=""/><br/>测试结果：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">summary +      1 in 00:00:02 =    0.5/s Avg:  1724 Min:  1724 Max:  1724 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary +   5821 in 00:00:28 =  204.3/s Avg:   128 Min:     1 Max:  1798 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =   5822 in 00:00:31 =  190.8/s Avg:   129 Min:     1 Max:  1798 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  10881 in 00:00:30 =  362.7/s Avg:    57 Min:     1 Max:   405 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  16703 in 00:01:01 =  276.0/s Avg:    82 Min:     1 Max:  1798 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  11548 in 00:00:30 =  384.9/s Avg:    52 Min:     1 Max:   308 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  28251 in 00:01:31 =  312.1/s Avg:    70 Min:     1 Max:  1798 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +   3747 in 00:00:10 =  387.8/s Avg:    51 Min:     1 Max:   328 Err:     0 (0.00%) Active: 0 Started: 50 Finished: 50</span></div><div class="token-line"><span class="token plain">    summary =  31998 in 00:01:40 =  319.4/s Avg:    67 Min:     1 Max:  1798 Err:     0 (0.00%)</span></div></pre></div><p>线程监控结果：</p><p><img src="https://static001.geekbang.org/resource/image/a8/fe/a84094c875c823e1aec552f244529bfe.png?wh=1874*519" alt=""/></p><p>在这个压力场景中，我直接把压力线程加上来，并且高于Tomcat的处理线程，Tomcat一下就上到了maxThreads的上限，然后就几乎没再闲过。同时你也可以看到响应时间远远大于场景二中的响应时间。</p><p>这就是<strong>典型的压力过高的状态</strong>。</p><p>对比前面三个场景，我们再比对之前专栏中的文章内容，就可以理解几个关键的知识点了。</p><p>首先，压力工具中的线程数到底应不应该在没有报错的情况下无休止地增加？</p><p>显然即使你增加，对服务端能处理的请求来说，并没有什么意义，只会导致响应时间的变长。</p><p>其次，把压力线程理解为并发用户数到底对不对？</p><p>如果你把压力线程理解为并发用户，通过这几个示例就可以看到，服务端能处理的压力线程必然不会超过自身的线程上限，也就是说，把压力线程理解为并发用户，并发用户的上限是固定的。你都不用测试，直接看服务端的线程数配置为多大就够了。这也是为什么我一再强调并发用户数不能用压力线程来描述，不能用压力线程来承载服务端性能指标的关键点。</p><p>而用TPS来描述的时候，因为有了“秒”的概念，就有了时间段，而在这个时间段内得到的响应都认为是被支持了的，所以用TPS来描述会更为合理。<br/>而T的定义具有业务含义时，也就对应起了技术和业务之间的关系，这个逻辑也就完整了。</p><p>从这里你也可以看到，我在整个专栏中所描述的概念在具体的落地时，都会秉承它的连贯性，要不然一个飞在空中的概念就没有意义了。</p><h3 id="场景四设置最大最小空闲线程数"><a aria-hidden="true" tabindex="-1" href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#场景四设置最大最小空闲线程数"><span class="icon icon-link"></span></a>场景四：设置最大最小空闲线程数</h3><p><img src="https://static001.geekbang.org/resource/image/f2/f1/f285ace2441abd42c09785ae69fb95f1.png?wh=2496*696" alt=""/><br/>测试结果：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">summary +      1 in 00:00:01 =    0.9/s Avg:   730 Min:   730 Max:   730 Err:     0 (0.00%) Active: 1 Started: 1 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary +   2915 in 00:00:30 =   97.5/s Avg:     5 Min:     0 Max:  1126 Err:     0 (0.00%) Active: 2 Started: 2 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =   2916 in 00:00:31 =   94.1/s Avg:     5 Min:     0 Max:  1126 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +   6690 in 00:00:30 =  222.9/s Avg:     4 Min:     0 Max:    81 Err:     0 (0.00%) Active: 4 Started: 4 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =   9606 in 00:01:01 =  157.5/s Avg:     4 Min:     0 Max:  1126 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +   9968 in 00:00:30 =  332.4/s Avg:     4 Min:     0 Max:    88 Err:     0 (0.00%) Active: 5 Started: 5 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  19574 in 00:01:31 =  215.2/s Avg:     4 Min:     0 Max:  1126 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  14140 in 00:00:30 =  471.1/s Avg:     3 Min:     0 Max:    87 Err:     0 (0.00%) Active: 7 Started: 7 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  33714 in 00:02:01 =  278.6/s Avg:     4 Min:     0 Max:  1126 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  14985 in 00:00:30 =  499.8/s Avg:     4 Min:     0 Max:    84 Err:     0 (0.00%) Active: 8 Started: 8 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  48699 in 00:02:31 =  322.6/s Avg:     4 Min:     0 Max:  1126 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  16446 in 00:00:30 =  548.1/s Avg:     4 Min:     0 Max:    76 Err:     0 (0.00%) Active: 10 Started: 10 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  65145 in 00:03:01 =  360.0/s Avg:     4 Min:     0 Max:  1126 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  16171 in 00:00:30 =  539.2/s Avg:     5 Min:     0 Max:   410 Err:     0 (0.00%) Active: 11 Started: 11 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  81316 in 00:03:31 =  385.4/s Avg:     4 Min:     0 Max:  1126 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  16419 in 00:00:30 =  547.2/s Avg:     7 Min:     0 Max:   646 Err:     0 (0.00%) Active: 13 Started: 13 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  97735 in 00:04:01 =  405.6/s Avg:     5 Min:     0 Max:  1126 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  15981 in 00:00:30 =  532.7/s Avg:     9 Min:     0 Max:   832 Err:     0 (0.00%) Active: 14 Started: 14 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 113716 in 00:04:31 =  419.7/s Avg:     5 Min:     0 Max:  1126 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  16064 in 00:00:30 =  535.6/s Avg:    11 Min:     0 Max:   888 Err:     0 (0.00%) Active: 16 Started: 16 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 129780 in 00:05:01 =  431.2/s Avg:     6 Min:     0 Max:  1126 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  15446 in 00:00:30 =  514.8/s Avg:    10 Min:     0 Max:  1022 Err:     0 (0.00%) Active: 17 Started: 17 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 145226 in 00:05:31 =  438.8/s Avg:     6 Min:     0 Max:  1126 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  14643 in 00:00:30 =  488.1/s Avg:    12 Min:     0 Max:  1114 Err:     0 (0.00%) Active: 19 Started: 19 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 159869 in 00:06:01 =  442.9/s Avg:     7 Min:     0 Max:  1126 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  14805 in 00:00:30 =  493.5/s Avg:    13 Min:     0 Max:  1250 Err:     0 (0.00%) Active: 20 Started: 20 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 174674 in 00:06:31 =  446.8/s Avg:     7 Min:     0 Max:  1250 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  14446 in 00:00:30 =  481.5/s Avg:    15 Min:     0 Max:  1385 Err:     0 (0.00%) Active: 22 Started: 22 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 189120 in 00:07:01 =  449.2/s Avg:     8 Min:     0 Max:  1385 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  14310 in 00:00:30 =  477.1/s Avg:    17 Min:     0 Max:  1454 Err:     0 (0.00%) Active: 23 Started: 23 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 203430 in 00:07:31 =  451.1/s Avg:     9 Min:     0 Max:  1454 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  13856 in 00:00:30 =  461.8/s Avg:    18 Min:     0 Max:  1454 Err:     0 (0.00%) Active: 25 Started: 25 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 217286 in 00:08:01 =  451.8/s Avg:     9 Min:     0 Max:  1454 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  13643 in 00:00:30 =  454.8/s Avg:    18 Min:     0 Max:  1591 Err:     0 (0.00%) Active: 26 Started: 26 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 230929 in 00:08:31 =  451.9/s Avg:    10 Min:     0 Max:  1591 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  13605 in 00:00:30 =  453.5/s Avg:    21 Min:     0 Max:  1593 Err:     0 (0.00%) Active: 28 Started: 28 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 244534 in 00:09:01 =  452.0/s Avg:    10 Min:     0 Max:  1593 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  13316 in 00:00:30 =  443.7/s Avg:    23 Min:     0 Max:  1598 Err:     0 (0.00%) Active: 29 Started: 29 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 257850 in 00:09:31 =  451.6/s Avg:    11 Min:     0 Max:  1598 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  12538 in 00:00:30 =  418.1/s Avg:    24 Min:     0 Max:  1599 Err:     0 (0.00%) Active: 30 Started: 30 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 270388 in 00:10:01 =  449.9/s Avg:    12 Min:     0 Max:  1599 Err:     0 (0.00%)</span></div></pre></div><p>线程监控结果：</p><p><img src="https://static001.geekbang.org/resource/image/b8/e2/b8cd1f7109a47c04a163091fcd1b73e2.png?wh=1880*264" alt=""/></p><p>这个场景是为了描述minSpareThreads和maxSpareThreads的能力，我们可以看到场景结束了之后，线程确实被回收了。</p><p>记住，这个回收的价值在于，当再次有少量请求进来时不会导致过多的维护线程的成本，从而导致TPS的下降。如果你的应用中，本身线程数就不是非常大，即使长时间维护着固定的线程池也不会有大的成本，那么不配置这两个参数也是可以的。</p><h3 id="禁用ajp"><a aria-hidden="true" tabindex="-1" href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#禁用ajp"><span class="icon icon-link"></span></a>禁用AJP</h3><p>什么是AJP呢？你可以点击<a target="_blank" rel="noopener noreferrer" href="https://tomcat.apache.org/connectors-doc/ajp/ajpv13a.html">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>看一下。</p><p>AJP是个二进制的TCP传输协议，相比HTTP来说有更高的性能和效率，只是支持AJP的代理服务器不多。在我们常用的应用场景中，用Nginx来连接Tomcat较多，AJP协议是用不上的，因为Nginx官方根本就没有支持AJP协议的模块。当然也有人提供过AJP的Nginx代理模块，只是实际应用的也不多。</p><p>下面我们看禁用AJP和启用AJP产生的效果。</p><p>首先看下启用AJP的测试结果。</p><p><img src="https://static001.geekbang.org/resource/image/ca/f0/ca10bcddc4e459abf3e486f2f10a2ff0.png?wh=2292*650" alt=""/></p><p>启动AJP（在Tomcat的conf/server.xml中配置）：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;Connector port=&quot;8009&quot; protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot; /&gt;</span></div></pre></div><p>启动日志：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">21-Jan-2020 01:14:58.404 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [ajp-nio-8009]</span></div></pre></div><p>测试结果为下面这样：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">summary +      4 in 00:00:02 =    1.8/s Avg:   482 Min:   188 Max:   903 Err:     0 (0.00%) Active: 1 Started: 1 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary +   2704 in 00:00:29 =   92.8/s Avg:     5 Min:     0 Max:    83 Err:     0 (0.00%) Active: 2 Started: 2 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =   2708 in 00:00:31 =   86.4/s Avg:     5 Min:     0 Max:   903 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +   6154 in 00:00:30 =  205.1/s Avg:     4 Min:     0 Max:    89 Err:     0 (0.00%) Active: 3 Started: 3 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =   8862 in 00:01:01 =  144.5/s Avg:     5 Min:     0 Max:   903 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +   8818 in 00:00:30 =  293.9/s Avg:     4 Min:     0 Max:    71 Err:     0 (0.00%) Active: 4 Started: 4 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  17680 in 00:01:31 =  193.6/s Avg:     4 Min:     0 Max:   903 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  13267 in 00:00:30 =  442.3/s Avg:     4 Min:     0 Max:    66 Err:     0 (0.00%) Active: 5 Started: 5 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  30947 in 00:02:01 =  255.0/s Avg:     4 Min:     0 Max:   903 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  13004 in 00:00:30 =  433.4/s Avg:     4 Min:     0 Max:    59 Err:     0 (0.00%) Active: 6 Started: 6 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  43951 in 00:02:31 =  290.4/s Avg:     4 Min:     0 Max:   903 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  15800 in 00:00:30 =  526.6/s Avg:     4 Min:     0 Max:    88 Err:     0 (0.00%) Active: 7 Started: 7 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  59751 in 00:03:01 =  329.5/s Avg:     4 Min:     0 Max:   903 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  16766 in 00:00:30 =  559.0/s Avg:     5 Min:     0 Max:    90 Err:     0 (0.00%) Active: 8 Started: 8 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  76517 in 00:03:31 =  362.1/s Avg:     4 Min:     0 Max:   903 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  16760 in 00:00:30 =  558.6/s Avg:     5 Min:     0 Max:    67 Err:     0 (0.00%) Active: 9 Started: 9 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  93277 in 00:04:01 =  386.5/s Avg:     4 Min:     0 Max:   903 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  16991 in 00:00:30 =  566.4/s Avg:     6 Min:     0 Max:   148 Err:     0 (0.00%) Active: 10 Started: 10 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 110268 in 00:04:31 =  406.4/s Avg:     5 Min:     0 Max:   903 Err:     0 (0.00%)</span></div></pre></div><p>然后我们再看下禁用AJP的测试结果。</p><p>禁用AJP：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;!-- Connector port=&quot;8009&quot; protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot; --&gt;</span></div></pre></div><p>无启动日志。</p><p>测试结果：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">summary +     90 in 00:00:05 =   16.9/s Avg:    33 Min:     2 Max:   812 Err:     0 (0.00%) Active: 1 Started: 1 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary +   3443 in 00:00:30 =  115.0/s Avg:     4 Min:     0 Max:    93 Err:     0 (0.00%) Active: 2 Started: 2 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =   3533 in 00:00:35 =  100.2/s Avg:     5 Min:     0 Max:   812 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +   7245 in 00:00:30 =  241.5/s Avg:     4 Min:     0 Max:    75 Err:     0 (0.00%) Active: 3 Started: 3 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  10778 in 00:01:05 =  165.2/s Avg:     4 Min:     0 Max:   812 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  11029 in 00:00:30 =  367.6/s Avg:     4 Min:     0 Max:   335 Err:     0 (0.00%) Active: 4 Started: 4 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  21807 in 00:01:35 =  228.9/s Avg:     4 Min:     0 Max:   812 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  12227 in 00:00:30 =  407.5/s Avg:     4 Min:     0 Max:    67 Err:     0 (0.00%) Active: 5 Started: 5 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  34034 in 00:02:05 =  271.7/s Avg:     4 Min:     0 Max:   812 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  14735 in 00:00:30 =  491.4/s Avg:     4 Min:     0 Max:    72 Err:     0 (0.00%) Active: 6 Started: 6 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  48769 in 00:02:35 =  314.1/s Avg:     4 Min:     0 Max:   812 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  16574 in 00:00:30 =  552.5/s Avg:     4 Min:     0 Max:    65 Err:     0 (0.00%) Active: 7 Started: 7 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  65343 in 00:03:05 =  352.7/s Avg:     4 Min:     0 Max:   812 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  17488 in 00:00:30 =  582.9/s Avg:     4 Min:     0 Max:    70 Err:     0 (0.00%) Active: 8 Started: 8 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  82831 in 00:03:35 =  384.8/s Avg:     4 Min:     0 Max:   812 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  16933 in 00:00:30 =  564.5/s Avg:     5 Min:     0 Max:    87 Err:     0 (0.00%) Active: 9 Started: 9 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  99764 in 00:04:05 =  406.8/s Avg:     4 Min:     0 Max:   812 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  17363 in 00:00:30 =  578.8/s Avg:     6 Min:     0 Max:    76 Err:     0 (0.00%) Active: 10 Started: 10 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 117127 in 00:04:35 =  425.5/s Avg:     4 Min:     0 Max:   812 Err:     0 (0.00%)</span></div></pre></div><p>通过比对，如下图所示：</p><p><img src="https://static001.geekbang.org/resource/image/30/71/30114785a6e692a14f9b17f27fbf0a71.jpg?wh=568*376" alt=""/></p><p>禁用AJP确实性能会高一点，在这个场景中最高的时候，同压力线程下，性能高出近20%。</p><h3 id="压缩"><a aria-hidden="true" tabindex="-1" href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#压缩"><span class="icon icon-link"></span></a>压缩</h3><p>在很多的压力测试中，我们说压缩这个功能都是基于两个目标：</p><ol><li>减少带宽的消耗；</li><li>减少传输的时间；</li></ol><p>但是这必然会导致服务端CPU消耗的增加，这是个必然的过程。所以它的配置前提就是CPU足够用，带宽不够用。如果你带宽足够用，CPU不够用时，显然这样做是不理智的。</p><p>下面我们来看一下Tomcat中压缩和不压缩产生的结果。</p><p>首先是不压缩。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">summary +    588 in 00:00:13 =   46.0/s Avg:    10 Min:     1 Max:   804 Err:     0 (0.00%) Active: 1 Started: 1 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary +   4403 in 00:00:30 =  146.8/s Avg:     4 Min:     0 Max:    87 Err:     0 (0.00%) Active: 2 Started: 2 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =   4991 in 00:00:43 =  116.7/s Avg:     5 Min:     0 Max:   804 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +   7107 in 00:00:30 =  237.1/s Avg:     4 Min:     0 Max:    77 Err:     0 (0.00%) Active: 3 Started: 3 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  12098 in 00:01:13 =  166.3/s Avg:     5 Min:     0 Max:   804 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  11121 in 00:00:30 =  370.7/s Avg:     4 Min:     0 Max:    72 Err:     0 (0.00%) Active: 4 Started: 4 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  23219 in 00:01:43 =  226.0/s Avg:     4 Min:     0 Max:   804 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  12709 in 00:00:30 =  423.6/s Avg:     4 Min:     0 Max:    87 Err:     0 (0.00%) Active: 5 Started: 5 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  35928 in 00:02:13 =  270.6/s Avg:     4 Min:     0 Max:   804 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  14548 in 00:00:30 =  485.0/s Avg:     4 Min:     0 Max:    69 Err:     0 (0.00%) Active: 6 Started: 6 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  50476 in 00:02:43 =  310.1/s Avg:     4 Min:     0 Max:   804 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  15810 in 00:00:30 =  527.0/s Avg:     5 Min:     0 Max:    83 Err:     0 (0.00%) Active: 7 Started: 7 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  66286 in 00:03:13 =  343.9/s Avg:     4 Min:     0 Max:   804 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  15242 in 00:00:30 =  508.0/s Avg:     5 Min:     0 Max:    77 Err:     0 (0.00%) Active: 8 Started: 8 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  81528 in 00:03:43 =  366.0/s Avg:     4 Min:     0 Max:   804 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  16709 in 00:00:30 =  557.1/s Avg:     5 Min:     0 Max:    75 Err:     0 (0.00%) Active: 9 Started: 9 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  98237 in 00:04:13 =  388.7/s Avg:     5 Min:     0 Max:   804 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  17099 in 00:00:30 =  570.0/s Avg:     6 Min:     0 Max:   161 Err:     0 (0.00%) Active: 10 Started: 10 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 115336 in 00:04:43 =  407.9/s Avg:     5 Min:     0 Max:   804 Err:     0 (0.00%)</span></div></pre></div><p>网络流量：</p><p><img src="https://static001.geekbang.org/resource/image/8d/5c/8dd475b263132ef93c3221246c32455c.png?wh=1889*785" alt=""/></p><p>然后是压缩。</p><p>在这里，我为了让压缩生效的范围更大，把最小值设置为了10bytes。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">compression=&quot;on&quot; compressionMinSize=&quot;10&quot; noCompressionUserAgents=&quot;gozilla,traviata&quot; compressableMimeType=&quot;text/html,text/xml,application/javascript,text/javascript,text/css,text/plain,text/json&quot;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    summary +   1037 in 00:00:09 =  117.5/s Avg:     4 Min:     0 Max:   418 Err:     0 (0.00%) Active: 1 Started: 1 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary +   5832 in 00:00:30 =  194.2/s Avg:     3 Min:     0 Max:    74 Err:     0 (0.00%) Active: 2 Started: 2 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =   6869 in 00:00:39 =  176.8/s Avg:     3 Min:     0 Max:   418 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  10378 in 00:00:30 =  346.3/s Avg:     3 Min:     0 Max:    71 Err:     0 (0.00%) Active: 3 Started: 3 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  17247 in 00:01:09 =  250.6/s Avg:     3 Min:     0 Max:   418 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  12670 in 00:00:30 =  422.2/s Avg:     3 Min:     0 Max:    64 Err:     0 (0.00%) Active: 4 Started: 4 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  29917 in 00:01:39 =  302.7/s Avg:     3 Min:     0 Max:   418 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  13917 in 00:00:30 =  464.0/s Avg:     4 Min:     0 Max:    78 Err:     0 (0.00%) Active: 5 Started: 5 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  43834 in 00:02:09 =  340.3/s Avg:     3 Min:     0 Max:   418 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  14815 in 00:00:30 =  493.9/s Avg:     4 Min:     0 Max:    79 Err:     0 (0.00%) Active: 6 Started: 6 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  58649 in 00:02:39 =  369.3/s Avg:     3 Min:     0 Max:   418 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  15710 in 00:00:30 =  523.6/s Avg:     5 Min:     0 Max:    89 Err:     0 (0.00%) Active: 7 Started: 7 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  74359 in 00:03:09 =  393.8/s Avg:     4 Min:     0 Max:   418 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  16059 in 00:00:30 =  535.3/s Avg:     5 Min:     0 Max:    70 Err:     0 (0.00%) Active: 8 Started: 8 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  90418 in 00:03:39 =  413.2/s Avg:     4 Min:     0 Max:   418 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  15909 in 00:00:30 =  530.2/s Avg:     6 Min:     0 Max:    96 Err:     0 (0.00%) Active: 9 Started: 9 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 106327 in 00:04:09 =  427.3/s Avg:     4 Min:     0 Max:   418 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  16011 in 00:00:30 =  533.8/s Avg:     6 Min:     0 Max:    75 Err:     0 (0.00%) Active: 10 Started: 10 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary = 122338 in 00:04:39 =  438.8/s Avg:     4 Min:     0 Max:   418 Err:     0 (0.00%)</span></div></pre></div><p>网络流量：</p><p><img src="https://static001.geekbang.org/resource/image/9c/2c/9c9b4f5a564ce9f142ff1a4a42caca2c.png?wh=1881*779" alt=""/></p><p>通过上面的测试比对结果可以看到：</p><p><img src="https://static001.geekbang.org/resource/image/40/d0/400a23da7e7fe4d93d3bdbcb8e3291d0.jpg?wh=539*353" alt=""/></p><p>确实在CPU资源足够用的时候，采用压缩，TPS要大一些，但随着压力的增加，CPU资源不够了之后，压缩就没啥用了。</p><p>从带宽传输上可以看到，不压缩时最大带宽达到40M，而压缩时最大带宽只有14M，可见压缩对带宽的作用还是很显著的。</p><h3 id="acceptcount"><a aria-hidden="true" tabindex="-1" href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#acceptcount"><span class="icon icon-link"></span></a>acceptCount</h3><p>在上面的思维导图中，线程池最后一个参数就是acceptCount，这个值就比较容易理解，就是TCP的接收队列长度。</p><p>这次我直接用一个大压力的场景说明它的值大小的区别。我直接上50个线程。为什么要这么做呢，就是为了让队列产生得多一些。</p><p>下面我们直接来看结果吧。</p><h3 id="acceptcount10000"><a aria-hidden="true" tabindex="-1" href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#acceptcount10000"><span class="icon icon-link"></span></a>acceptCount=“10000”</h3><p>测试结果：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">summary +   2400 in 00:00:11 =  217.6/s Avg:   108 Min:     3 Max:  1176 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary +  10322 in 00:00:30 =  344.1/s Avg:    62 Min:     1 Max:   470 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  12722 in 00:00:41 =  310.1/s Avg:    71 Min:     1 Max:  1176 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  12660 in 00:00:30 =  422.0/s Avg:    49 Min:     0 Max:   331 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  25382 in 00:01:11 =  357.4/s Avg:    60 Min:     0 Max:  1176 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  13337 in 00:00:30 =  444.6/s Avg:    46 Min:     1 Max:   410 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  38719 in 00:01:41 =  383.3/s Avg:    55 Min:     0 Max:  1176 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  14176 in 00:00:30 =  472.4/s Avg:    43 Min:     0 Max:   302 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  52895 in 00:02:11 =  403.7/s Avg:    52 Min:     0 Max:  1176 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  14696 in 00:00:30 =  489.7/s Avg:    42 Min:     1 Max:   261 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  67591 in 00:02:41 =  419.7/s Avg:    50 Min:     0 Max:  1176 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  16191 in 00:00:30 =  539.9/s Avg:    38 Min:     0 Max:   320 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  83782 in 00:03:11 =  438.6/s Avg:    47 Min:     0 Max:  1176 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +   5299 in 00:00:09 =  580.1/s Avg:    36 Min:     1 Max:   201 Err:     0 (0.00%) Active: 0 Started: 50 Finished: 50</span></div><div class="token-line"><span class="token plain">    summary =  89081 in 00:03:20 =  445.0/s Avg:    47 Min:     0 Max:  1176 Err:     0 (0.00%)</span></div></pre></div><h3 id="acceptcount100"><a aria-hidden="true" tabindex="-1" href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#acceptcount100"><span class="icon icon-link"></span></a>acceptCount=“100”</h3><p>测试结果：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">summary +   1115 in 00:00:11 =  100.1/s Avg:   306 Min:    11 Max:  1936 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary +   7923 in 00:00:30 =  264.1/s Avg:    87 Min:     1 Max:   521 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =   9038 in 00:00:41 =  219.7/s Avg:   114 Min:     1 Max:  1936 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  11414 in 00:00:30 =  380.5/s Avg:    56 Min:     1 Max:   381 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  20452 in 00:01:11 =  287.5/s Avg:    81 Min:     1 Max:  1936 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  11949 in 00:00:30 =  398.4/s Avg:    51 Min:     0 Max:   390 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  32401 in 00:01:41 =  320.4/s Avg:    70 Min:     0 Max:  1936 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  13403 in 00:00:30 =  446.7/s Avg:    46 Min:     0 Max:   326 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  45804 in 00:02:11 =  349.3/s Avg:    63 Min:     0 Max:  1936 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  13271 in 00:00:30 =  442.4/s Avg:    45 Min:     0 Max:   295 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  59075 in 00:02:41 =  366.6/s Avg:    59 Min:     0 Max:  1936 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  14307 in 00:00:30 =  476.9/s Avg:    43 Min:     1 Max:   288 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  73382 in 00:03:11 =  383.9/s Avg:    56 Min:     0 Max:  1936 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +   4292 in 00:00:09 =  476.3/s Avg:    42 Min:     1 Max:   226 Err:     0 (0.00%) Active: 0 Started: 50 Finished: 50</span></div><div class="token-line"><span class="token plain">    summary =  77674 in 00:03:20 =  388.1/s Avg:    55 Min:     0 Max:  1936 Err:     0 (0.00%)</span></div></pre></div><p>通过上面的结果，可以得到下图：</p><p><img src="https://static001.geekbang.org/resource/image/50/0a/50b80dc97fa05ed1571380e913a9ba0a.jpg?wh=528*339" alt=""/></p><p>可见当acceptCount大时，对TPS还是有明显帮助的。</p><p>接下来，我们再看下connectionTimeout。</p><h3 id="connectiontimeout"><a aria-hidden="true" tabindex="-1" href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#connectiontimeout"><span class="icon icon-link"></span></a>connectionTimeout</h3><p>我需要说明的是，以下场景均基于以下配置：acceptCount=“10000”。</p><p>这个值对我们来说，也是非常关键的数据，因为它影响着KeepAlive的超时和connection的超时。</p><p>我们在性能分析的时候，会遇到一种情况是，很多应用都用默认超时，而在压力大的时候，会有少量的报错是因为前端的超时已经到了，而后端还没到，因为毕竟后端是后接收到的请求。这就导致了大压力下少量的错误是因为超时配置导致的。</p><p>所以我们通常都会画一个图如下所示：</p><p><img src="https://static001.geekbang.org/resource/image/d9/61/d935ee8b317bada3264fc9e640a2c261.jpg?wh=1297*195" alt=""/></p><p>而在真实的应用场景中，应该配置多长时间的超时一定是经过严格的测试的。</p><p>下面我们来看看结果。</p><p>当<code>connectionTimeout=&quot;20000&quot;</code>时，这个结果直接拿上面的测试结果复用。</p><p>测试结果：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">summary +   2400 in 00:00:11 =  217.6/s Avg:   108 Min:     3 Max:  1176 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary +  10322 in 00:00:30 =  344.1/s Avg:    62 Min:     1 Max:   470 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  12722 in 00:00:41 =  310.1/s Avg:    71 Min:     1 Max:  1176 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  12660 in 00:00:30 =  422.0/s Avg:    49 Min:     0 Max:   331 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  25382 in 00:01:11 =  357.4/s Avg:    60 Min:     0 Max:  1176 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  13337 in 00:00:30 =  444.6/s Avg:    46 Min:     1 Max:   410 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  38719 in 00:01:41 =  383.3/s Avg:    55 Min:     0 Max:  1176 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  14176 in 00:00:30 =  472.4/s Avg:    43 Min:     0 Max:   302 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  52895 in 00:02:11 =  403.7/s Avg:    52 Min:     0 Max:  1176 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  14696 in 00:00:30 =  489.7/s Avg:    42 Min:     1 Max:   261 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  67591 in 00:02:41 =  419.7/s Avg:    50 Min:     0 Max:  1176 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +  16191 in 00:00:30 =  539.9/s Avg:    38 Min:     0 Max:   320 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  83782 in 00:03:11 =  438.6/s Avg:    47 Min:     0 Max:  1176 Err:     0 (0.00%)</span></div><div class="token-line"><span class="token plain">    summary +   5299 in 00:00:09 =  580.1/s Avg:    36 Min:     1 Max:   201 Err:     0 (0.00%) Active: 0 Started: 50 Finished: 50</span></div><div class="token-line"><span class="token plain">    summary =  89081 in 00:03:20 =  445.0/s Avg:    47 Min:     0 Max:  1176 Err:     0 (0.00%)</span></div></pre></div><p>当connectionTimeout=&quot;200&quot;时，测试结果为：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">summary +   1540 in 00:00:13 =  117.5/s Avg:   258 Min:     7 Max:  2150 Err:    15 (0.97%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary +  10080 in 00:00:30 =  336.4/s Avg:    65 Min:     1 Max:   465 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  11620 in 00:00:43 =  269.8/s Avg:    90 Min:     1 Max:  2150 Err:    15 (0.13%)</span></div><div class="token-line"><span class="token plain">    summary +  12691 in 00:00:30 =  422.8/s Avg:    49 Min:     0 Max:   317 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  24311 in 00:01:13 =  332.6/s Avg:    69 Min:     0 Max:  2150 Err:    15 (0.06%)</span></div><div class="token-line"><span class="token plain">    summary +  12707 in 00:00:30 =  423.8/s Avg:    48 Min:     1 Max:   312 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  37018 in 00:01:43 =  359.2/s Avg:    62 Min:     0 Max:  2150 Err:    15 (0.04%)</span></div><div class="token-line"><span class="token plain">    summary +  13530 in 00:00:30 =  450.7/s Avg:    45 Min:     0 Max:   306 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  50548 in 00:02:13 =  379.8/s Avg:    57 Min:     0 Max:  2150 Err:    15 (0.03%)</span></div><div class="token-line"><span class="token plain">    summary +  13791 in 00:00:30 =  460.0/s Avg:    44 Min:     1 Max:   344 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  64339 in 00:02:43 =  394.5/s Avg:    55 Min:     0 Max:  2150 Err:    15 (0.02%)</span></div><div class="token-line"><span class="token plain">    summary +  14840 in 00:00:30 =  494.6/s Avg:    41 Min:     0 Max:   319 Err:     0 (0.00%) Active: 50 Started: 50 Finished: 0</span></div><div class="token-line"><span class="token plain">    summary =  79179 in 00:03:13 =  410.1/s Avg:    52 Min:     0 Max:  2150 Err:    15 (0.02%)</span></div><div class="token-line"><span class="token plain">    summary +   3734 in 00:00:07 =  530.5/s Avg:    39 Min:     1 Max:   282 Err:     0 (0.00%) Active: 0 Started: 50 Finished: 50</span></div><div class="token-line"><span class="token plain">    summary =  82913 in 00:03:20 =  414.3/s Avg:    51 Min:     0 Max:  2150 Err:    15 (0.02%)</span></div></pre></div><p>看到没有，一开始就有少量的报错产生了，但一些我没加断言的报错应该没有在这里没显示出来。</p><p>所以根据应用的重要性，超时长度在具体的应用场景中，一定要做严格的测试。把完整的业务链路图画出来之后，一个个环节分析超时应该设置为多大，才是合理的做法。</p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#总结"><span class="icon icon-link"></span></a>总结</h2><p>至于其他的Tomcat调优参数，你可以在自己的场景中实际操作一下。</p><p>总之，Tomcat的优化就是这么几个关键环节：协议、运行模式（尽管现在我认为它已经不再有争议了，但是当你用老版本的Tomcat时还是要注意一下）、线程池（关键中的关键）等。</p><p>不止是Tomcat这样，其他类似的应用服务器也是一样。尽管这些应用服务器在架构设计上会不同，但是在我的调优生涯中，针对这样的应用服务器，可调优的关键点真的就这么几个。</p><p>可见这样的应用服务器本身可调优的点并不多。如果你要调的是SpringBoot中的Tomcat组件，也可以用同样的思路。</p><p>最后我还是要说，在你的具体工作中，一定要拿实际测试结果来分析判断，以免产生偏差。在任何时候，都要知道，性能测试的计数器中，没有哪个计数器的值可以直接告诉你性能问题的原因，只有通过自己的分析判断才能找得到。</p><h2 id="思考题"><a aria-hidden="true" tabindex="-1" href="/blog/性能测试实战30讲/05.第三模块性能监控分析工具篇/06#思考题"><span class="icon icon-link"></span></a>思考题</h2><p>最后给你留两道思考题吧。类似Tomcat的应用服务器，应该如何拆解监控计数器呢？我们应该如何判断应用服务器的线程是否够用？</p><p>欢迎你在评论区写下你的思考，也欢迎把这篇文章分享给你的朋友或者同事，一起交流进步一下。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/docs/性能测试实战30讲/05.第三模块性能监控分析工具篇/06.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">5/2/2022 10:57:07</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog/umi.js"></script>
  </body>
</html>
