<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog/umi.css" />
    <script>
      window.routerBase = "/blog";
    </script>
    <script>
      //! umi version: 3.5.17
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.indexOf(e) > -1 ? e : r[0]
        );
      })();
    </script>
    <title>12 | 模板解析：构造 AST 的完整流程是怎样的？（上）</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/vue3源码分析/04.模块三编译过程和背后的优化思想/02" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>计算机基础<ul><li><a href="/blog/编译原理之美">编译原理之美</a></li><li><a href="/blog/编译原理实战">编译原理实战</a></li><li><a href="/blog/深入浅出计算机组成原理">深入浅出计算机组成原理</a></li><li><a href="/blog/详解http">详解http</a></li><li><a href="/blog/计算机网络通关29讲">计算机网络通关29讲</a></li><li><a href="/blog/网络排查案例课">网络排查案例课</a></li><li><a href="/blog/linux操作系统">linux操作系统</a></li><li><a href="/blog/linux性能优化实战">linux性能优化实战</a></li><li><a href="/blog/程序员数学基础">程序员数学基础</a></li><li><a href="/blog/趣谈网络协议">趣谈网络协议</a></li><li><a href="/blog/操作系统实战">操作系统实战</a></li><li><a href="/blog/软件工程之美">软件工程之美</a></li><li><a href="/blog/sql必知必会">sql必知必会</a></li><li><a href="/blog/操作系统实战45讲">操作系统实战45讲</a></li><li><a href="/blog/网络编程实战">网络编程实战</a></li></ul></span><span>算法<ul><li><a href="/blog/常用算法25讲">常用算法25讲</a></li><li><a href="/blog/数据结构与算法之美">数据结构与算法之美</a></li><li><a href="/blog/业务开发算法50讲">业务开发算法50讲</a></li><li><a href="/blog/动态规划面试宝典">动态规划面试宝典</a></li></ul></span><span>前端开发<ul><li><a href="/blog/浏览器工作原理与实践">浏览器工作原理与实践</a></li><li><a href="/blog/新时代产品经理进阶之路">新时代产品经理进阶之路</a></li><li><a href="/blog/全栈工程师修炼指南">全栈工程师修炼指南</a></li><li><a href="/blog/flutter核心技术与实战">flutter核心技术与实战</a></li><li><a href="/blog/java-script核心原理解析">java-script核心原理解析</a></li><li><a href="/blog/说透低代码">说透低代码</a></li><li><a href="/blog/nodejs应用开发实战">nodejs应用开发实战</a></li><li><a href="/blog/反爬虫兵法演绎20讲">反爬虫兵法演绎20讲</a></li><li><a href="/blog/reactnative新架构实战课">reactnative新架构实战课</a></li><li><a href="/blog/正则表达式入门">正则表达式入门</a></li><li><a href="/blog/重学前端">重学前端</a></li><li><a href="/blog/serverless入门课">serverless入门课</a></li><li><a href="/blog/type-script入门实战笔记">type-script入门实战笔记</a></li><li><a href="/blog/图解googlev8">图解googlev8</a></li><li><a aria-current="page" class="active" href="/blog/vue3源码分析">vue3源码分析</a></li><li><a href="/blog/玩转Vue3全家桶">玩转Vue3全家桶</a></li><li><a href="/blog/webassembly入门">webassembly入门</a></li><li><a href="/blog/手把手带你写一个Web框架">手把手带你写一个Web框架</a></li><li><a href="/blog/web漏洞挖掘实战">web漏洞挖掘实战</a></li><li><a href="/blog/跟月影学可视化">跟月影学可视化</a></li><li><a href="/blog/搞定音频技术">搞定音频技术</a></li><li><a href="/blog/攻克视频技术">攻克视频技术</a></li></ul></span><span>前端工程化<ul><li><a href="/blog/logger">logger</a></li><li><a href="/blog/webpack">webpack</a></li><li><a href="/blog/webpackChain">webpackChain</a></li></ul></span><span>前端性能优化<ul><li><a href="/blog/react性能调优">react性能调优</a></li></ul></span><span>软件测试<ul><li><a href="/blog/全链路压测实战30讲">全链路压测实战30讲</a></li><li><a href="/blog/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog/自动化测试高手课">自动化测试高手课</a></li><li><a href="/blog/软件测试52讲">软件测试52讲</a></li></ul></span><span>面试<ul><li><a href="/blog/面试现场">面试现场</a></li></ul></span><span>杂谈<ul><li><a href="/blog/超级访谈对话张雪峰">超级访谈对话张雪峰</a></li><li><a href="/blog/Git实战手册">Git实战手册</a></li><li><a href="/blog/NodeJS">NodeJS</a></li><li><a href="/blog/ReactJS">ReactJS</a></li><li><a href="/blog/UI设计">UI设计</a></li><li><a href="/blog/webpack4系列教程">webpack4系列教程</a></li><li><a href="/blog/前端知识体系">前端知识体系</a></li><li><a href="/blog/剑指offer刷题笔记">剑指offer刷题笔记</a></li><li><a href="/blog/思考与成长">思考与成长</a></li><li><a href="/blog/设计模式手册">设计模式手册</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>计算机基础<ul><li><a href="/blog/编译原理之美">编译原理之美</a></li><li><a href="/blog/编译原理实战">编译原理实战</a></li><li><a href="/blog/深入浅出计算机组成原理">深入浅出计算机组成原理</a></li><li><a href="/blog/详解http">详解http</a></li><li><a href="/blog/计算机网络通关29讲">计算机网络通关29讲</a></li><li><a href="/blog/网络排查案例课">网络排查案例课</a></li><li><a href="/blog/linux操作系统">linux操作系统</a></li><li><a href="/blog/linux性能优化实战">linux性能优化实战</a></li><li><a href="/blog/程序员数学基础">程序员数学基础</a></li><li><a href="/blog/趣谈网络协议">趣谈网络协议</a></li><li><a href="/blog/操作系统实战">操作系统实战</a></li><li><a href="/blog/软件工程之美">软件工程之美</a></li><li><a href="/blog/sql必知必会">sql必知必会</a></li><li><a href="/blog/操作系统实战45讲">操作系统实战45讲</a></li><li><a href="/blog/网络编程实战">网络编程实战</a></li></ul></li><li>算法<ul><li><a href="/blog/常用算法25讲">常用算法25讲</a></li><li><a href="/blog/数据结构与算法之美">数据结构与算法之美</a></li><li><a href="/blog/业务开发算法50讲">业务开发算法50讲</a></li><li><a href="/blog/动态规划面试宝典">动态规划面试宝典</a></li></ul></li><li>前端开发<ul><li><a href="/blog/浏览器工作原理与实践">浏览器工作原理与实践</a></li><li><a href="/blog/新时代产品经理进阶之路">新时代产品经理进阶之路</a></li><li><a href="/blog/全栈工程师修炼指南">全栈工程师修炼指南</a></li><li><a href="/blog/flutter核心技术与实战">flutter核心技术与实战</a></li><li><a href="/blog/java-script核心原理解析">java-script核心原理解析</a></li><li><a href="/blog/说透低代码">说透低代码</a></li><li><a href="/blog/nodejs应用开发实战">nodejs应用开发实战</a></li><li><a href="/blog/反爬虫兵法演绎20讲">反爬虫兵法演绎20讲</a></li><li><a href="/blog/reactnative新架构实战课">reactnative新架构实战课</a></li><li><a href="/blog/正则表达式入门">正则表达式入门</a></li><li><a href="/blog/重学前端">重学前端</a></li><li><a href="/blog/serverless入门课">serverless入门课</a></li><li><a href="/blog/type-script入门实战笔记">type-script入门实战笔记</a></li><li><a href="/blog/图解googlev8">图解googlev8</a></li><li><a aria-current="page" class="active" href="/blog/vue3源码分析">vue3源码分析</a></li><li><a href="/blog/玩转Vue3全家桶">玩转Vue3全家桶</a></li><li><a href="/blog/webassembly入门">webassembly入门</a></li><li><a href="/blog/手把手带你写一个Web框架">手把手带你写一个Web框架</a></li><li><a href="/blog/web漏洞挖掘实战">web漏洞挖掘实战</a></li><li><a href="/blog/跟月影学可视化">跟月影学可视化</a></li><li><a href="/blog/搞定音频技术">搞定音频技术</a></li><li><a href="/blog/攻克视频技术">攻克视频技术</a></li></ul></li><li>前端工程化<ul><li><a href="/blog/logger">logger</a></li><li><a href="/blog/webpack">webpack</a></li><li><a href="/blog/webpackChain">webpackChain</a></li></ul></li><li>前端性能优化<ul><li><a href="/blog/react性能调优">react性能调优</a></li></ul></li><li>软件测试<ul><li><a href="/blog/全链路压测实战30讲">全链路压测实战30讲</a></li><li><a href="/blog/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog/自动化测试高手课">自动化测试高手课</a></li><li><a href="/blog/软件测试52讲">软件测试52讲</a></li></ul></li><li>面试<ul><li><a href="/blog/面试现场">面试现场</a></li></ul></li><li>杂谈<ul><li><a href="/blog/超级访谈对话张雪峰">超级访谈对话张雪峰</a></li><li><a href="/blog/Git实战手册">Git实战手册</a></li><li><a href="/blog/NodeJS">NodeJS</a></li><li><a href="/blog/ReactJS">ReactJS</a></li><li><a href="/blog/UI设计">UI设计</a></li><li><a href="/blog/webpack4系列教程">webpack4系列教程</a></li><li><a href="/blog/前端知识体系">前端知识体系</a></li><li><a href="/blog/剑指offer刷题笔记">剑指offer刷题笔记</a></li><li><a href="/blog/思考与成长">思考与成长</a></li><li><a href="/blog/设计模式手册">设计模式手册</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog/vue3源码分析">vue3源码分析</a></li><li><a href="/blog/vue3源码分析/01.开篇词">01.开篇词</a><ul><li><a href="/blog/vue3源码分析/01.开篇词/01"><span>开篇词 | 解析 Vue.js 源码，提升编码能力</span></a></li><li><a href="/blog/vue3源码分析/01.开篇词/02"><span>导读 | 一文看懂 Vue.js 3.0 的优化</span></a></li></ul></li><li><a href="/blog/vue3源码分析/02.模块一直击vue.js核心组件的实现">02.模块一直击Vue.js核心组件的实现</a><ul><li><a href="/blog/vue3源码分析/02.模块一直击vue.js核心组件的实现/01"><span>模块一导读 | 组件的实现：直击 Vue 核心的实现</span></a></li><li><a href="/blog/vue3源码分析/02.模块一直击vue.js核心组件的实现/02"><span>01 | 组件渲染：vnode 到真实 DOM 是如何转变的？</span></a></li><li><a href="/blog/vue3源码分析/02.模块一直击vue.js核心组件的实现/03"><span>02 | 组件更新：完整的 DOM diff 流程是怎样的？（上）</span></a></li><li><a href="/blog/vue3源码分析/02.模块一直击vue.js核心组件的实现/04"><span>03 | 组件更新：完整的 DOM diff 流程是怎样的？（下）</span></a></li></ul></li><li><a href="/blog/vue3源码分析/03.模块二学会新设计composition-api">03.模块二学会新设计CompositionAPI</a><ul><li><a href="/blog/vue3源码分析/03.模块二学会新设计composition-api/01"><span>模块二导读 | 逻辑复用最佳实践：Composition API</span></a></li><li><a href="/blog/vue3源码分析/03.模块二学会新设计composition-api/02"><span>04 | Setup：组件渲染前的初始化过程是怎样的？</span></a></li><li><a href="/blog/vue3源码分析/03.模块二学会新设计composition-api/03"><span>05 | 响应式：响应式内部的实现原理是怎样的？（上）</span></a></li><li><a href="/blog/vue3源码分析/03.模块二学会新设计composition-api/04"><span>06 | 响应式：响应式内部的实现原理是怎样的？（下）</span></a></li><li><a href="/blog/vue3源码分析/03.模块二学会新设计composition-api/05"><span>07 | 计算属性：计算属性比普通函数好在哪里？</span></a></li><li><a href="/blog/vue3源码分析/03.模块二学会新设计composition-api/06"><span>08 | 侦听器：侦听器的实现原理和使用场景是什么？（上）</span></a></li><li><a href="/blog/vue3源码分析/03.模块二学会新设计composition-api/07"><span>09 | 侦听器：侦听器的实现原理和使用场景是什么？（下）</span></a></li><li><a href="/blog/vue3源码分析/03.模块二学会新设计composition-api/08"><span>10 | 生命周期：各个生命周期的执行时机和应用场景是怎样的？</span></a></li><li><a href="/blog/vue3源码分析/03.模块二学会新设计composition-api/09"><span>11 | 依赖注入：子孙组件如何共享数据？</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog/vue3源码分析/04.模块三编译过程和背后的优化思想">04.模块三编译过程和背后的优化思想</a><ul><li><a href="/blog/vue3源码分析/04.模块三编译过程和背后的优化思想/01"><span>模块三导读 | 编译和优化：了解编译过程和背后的优化思想</span></a></li><li><a aria-current="page" class="active" href="/blog/vue3源码分析/04.模块三编译过程和背后的优化思想/02"><span>12 | 模板解析：构造 AST 的完整流程是怎样的？（上）</span></a></li><li><a href="/blog/vue3源码分析/04.模块三编译过程和背后的优化思想/03"><span>13 | 模板解析：构造 AST 的完整流程是怎样的？（下）</span></a></li><li><a href="/blog/vue3源码分析/04.模块三编译过程和背后的优化思想/04"><span>14 | AST 转换：AST 节点内部做了哪些转换？（上）</span></a></li><li><a href="/blog/vue3源码分析/04.模块三编译过程和背后的优化思想/05"><span>15 | AST 转换：AST 节点内部做了哪些转换？（下）</span></a></li><li><a href="/blog/vue3源码分析/04.模块三编译过程和背后的优化思想/06"><span>16 | 生成代码：AST 如何生成可运行的代码？（上）</span></a></li><li><a href="/blog/vue3源码分析/04.模块三编译过程和背后的优化思想/07"><span>17 | 生成代码：AST 如何生成可运行的代码？（下）</span></a></li></ul></li><li><a href="/blog/vue3源码分析/05.模块四探索更多实用特性背后的实现原理">05.模块四探索更多实用特性背后的实现原理</a><ul><li><a href="/blog/vue3源码分析/05.模块四探索更多实用特性背后的实现原理/01"><span>模块四导读 | 实用特性：探索更多实用特性背后的原理</span></a></li><li><a href="/blog/vue3源码分析/05.模块四探索更多实用特性背后的实现原理/02"><span>18 | Props：Props 的初始化和更新流程是怎样的？</span></a></li><li><a href="/blog/vue3源码分析/05.模块四探索更多实用特性背后的实现原理/03"><span>19 | 插槽：如何实现内容分发？</span></a></li><li><a href="/blog/vue3源码分析/05.模块四探索更多实用特性背后的实现原理/04"><span>20 | 指令：指令完整的生命周期是怎样的？</span></a></li><li><a href="/blog/vue3源码分析/05.模块四探索更多实用特性背后的实现原理/05"><span>21 | v-model：双向绑定到底是怎么实现的？</span></a></li></ul></li><li><a href="/blog/vue3源码分析/06.模块五学习vue内置组件的实现原理">06.模块五学习Vue内置组件的实现原理</a><ul><li><a href="/blog/vue3源码分析/06.模块五学习vue内置组件的实现原理/01"><span>模块五导读 | 内置组件：学习 Vue 内置组件的实现原理</span></a></li><li><a href="/blog/vue3源码分析/06.模块五学习vue内置组件的实现原理/02"><span>22 | Teleport 组件：如何脱离当前组件渲染子组件？</span></a></li><li><a href="/blog/vue3源码分析/06.模块五学习vue内置组件的实现原理/03"><span>23 | KeepAlive 组件：如何让组件在内存中缓存和调度？</span></a></li><li><a href="/blog/vue3源码分析/06.模块五学习vue内置组件的实现原理/04"><span>24 | Transition 组件：过渡动画的实现原理是怎样的？（上）</span></a></li><li><a href="/blog/vue3源码分析/06.模块五学习vue内置组件的实现原理/05"><span>25 | Transition 组件：过渡动画的实现原理是怎样的？（下）</span></a></li></ul></li><li><a href="/blog/vue3源码分析/07.特别放送研究vue官方生态的实现原理">07.特别放送研究Vue官方生态的实现原理</a><ul><li><a href="/blog/vue3源码分析/07.特别放送研究vue官方生态的实现原理/01"><span>特别放送导读 | 研究 Vue 官方生态的实现原理</span></a></li><li><a href="/blog/vue3源码分析/07.特别放送研究vue官方生态的实现原理/02"><span>26 | Vue Router：如何实现一个前端路由？（上）</span></a></li><li><a href="/blog/vue3源码分析/07.特别放送研究vue官方生态的实现原理/03"><span>27 |  Vue Router：如何实现一个前端路由？（下）</span></a></li></ul></li><li><a href="/blog/vue3源码分析/08.结束语">08.结束语</a><ul><li><a href="/blog/vue3源码分析/08.结束语/01"><span>结束语 | 终点也是起点</span></a></li></ul></li><li><a href="/blog/vue3源码分析/summary">vue3源码分析</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="生成 AST 抽象语法树" data-depth="3"><a href="/blog/vue3源码分析/04.模块三编译过程和背后的优化思想/02#生成-ast-抽象语法树"><span>生成 AST 抽象语法树</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="12--模板解析构造-ast-的完整流程是怎样的上"><a aria-hidden="true" tabindex="-1" href="/blog/vue3源码分析/04.模块三编译过程和背后的优化思想/02#12--模板解析构造-ast-的完整流程是怎样的上"><span class="icon icon-link"></span></a>12 | 模板解析：构造 AST 的完整流程是怎样的？（上）</h1><p>Vue.js 3.0 的编译场景分<strong>服务端 SSR 编译</strong>和 <strong>web 编译</strong>，本文我们只分析 web 的编译。</p><p>我们先来看 web 编译的入口 compile 函数，分析它的实现原理：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">function compile(template, options = {}) { </span></div><div class="token-line"><span class="token plain">      return baseCompile(template, extend({}, parserOptions, options, { </span></div><div class="token-line"><span class="token plain">        nodeTransforms: [...DOMNodeTransforms, ...(options.nodeTransforms || [])], </span></div><div class="token-line"><span class="token plain">        directiveTransforms: extend({}, DOMDirectiveTransforms, options.directiveTransforms || {}), </span></div><div class="token-line"><span class="token plain">        transformHoist:  null </span></div><div class="token-line"><span class="token plain">      })) </span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>compile 函数支持两个参数，第一个参数 template 是待编译的模板字符串，第二个参数 options 是编译的一些配置信息。</p><p>compile 内部通过执行 baseCompile 方法完成编译工作，可以看到 baseCompile 在参数 options 的基础上又扩展了一些配置。对于这些编译相关的配置，我们后面会在具体的场景具体分析。</p><p>接下来，我们来看一下 baseCompile 的实现：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">function baseCompile(template,  options = {}) { </span></div><div class="token-line"><span class="token plain">      const prefixIdentifiers = false </span></div><div class="token-line"><span class="token plain">      // 解析 template 生成 AST </span></div><div class="token-line"><span class="token plain">      const ast = isString(template) ? baseParse(template, options) : template </span></div><div class="token-line"><span class="token plain">      const [nodeTransforms, directiveTransforms] = getBaseTransformPreset() </span></div><div class="token-line"><span class="token plain">      // AST 转换 </span></div><div class="token-line"><span class="token plain">      transform(ast, extend({}, options, { </span></div><div class="token-line"><span class="token plain">        prefixIdentifiers, </span></div><div class="token-line"><span class="token plain">        nodeTransforms: [ </span></div><div class="token-line"><span class="token plain">          ...nodeTransforms, </span></div><div class="token-line"><span class="token plain">          ...(options.nodeTransforms || []) </span></div><div class="token-line"><span class="token plain">        ], </span></div><div class="token-line"><span class="token plain">        directiveTransforms: extend({}, directiveTransforms, options.directiveTransforms || {} </span></div><div class="token-line"><span class="token plain">        ) </span></div><div class="token-line"><span class="token plain">      })) </span></div><div class="token-line"><span class="token plain">      // 生成代码 </span></div><div class="token-line"><span class="token plain">      return generate(ast, extend({}, options, { </span></div><div class="token-line"><span class="token plain">        prefixIdentifiers </span></div><div class="token-line"><span class="token plain">      })) </span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>可以看到，baseCompile 函数主要做三件事情：<strong>解析 template 生成 AST</strong>，<strong>AST 转换</strong>和<strong>生成代码</strong>。</p><p>这一节课我们的目标就是<strong>解析 template 生成 AST 背后的实现原理</strong>。</p><h3 id="生成-ast-抽象语法树"><a aria-hidden="true" tabindex="-1" href="/blog/vue3源码分析/04.模块三编译过程和背后的优化思想/02#生成-ast-抽象语法树"><span class="icon icon-link"></span></a>生成 AST 抽象语法树</h3><p>你可以在百度百科中看到 <a target="_blank" rel="noopener noreferrer" href="https://baike.baidu.com/item/%E6%8A%BD%E8%B1%A1%E8%AF%AD%E6%B3%95%E6%A0%91/6129952?fr=aladdin">AST 的定义<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，这里我就不赘述啦，对应到我们的 template，也可以用 AST 去描述它，比如我们有如下 template：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;div class=&quot;app&quot;&gt; </span></div><div class="token-line"><span class="token plain">      &lt;!-- 这是一段注释 --&gt; </span></div><div class="token-line"><span class="token plain">      &lt;hello&gt; </span></div><div class="token-line"><span class="token plain">        &lt;p&gt;{{ msg }}&lt;/p&gt; </span></div><div class="token-line"><span class="token plain">      &lt;/hello&gt; </span></div><div class="token-line"><span class="token plain">      &lt;p&gt;This is an app&lt;/p&gt; </span></div><div class="token-line"><span class="token plain">    &lt;/div&gt;</span></div></pre></div><p>它经过第一步解析后，生成相应的 AST 对象：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">{ </span></div><div class="token-line"><span class="token plain">      &quot;type&quot;: 0, </span></div><div class="token-line"><span class="token plain">      &quot;children&quot;: [ </span></div><div class="token-line"><span class="token plain">        { </span></div><div class="token-line"><span class="token plain">          &quot;type&quot;: 1, </span></div><div class="token-line"><span class="token plain">          &quot;ns&quot;: 0, </span></div><div class="token-line"><span class="token plain">          &quot;tag&quot;: &quot;div&quot;, </span></div><div class="token-line"><span class="token plain">          &quot;tagType&quot;: 0, </span></div><div class="token-line"><span class="token plain">          &quot;props&quot;: [ </span></div><div class="token-line"><span class="token plain">            { </span></div><div class="token-line"><span class="token plain">              &quot;type&quot;: 6, </span></div><div class="token-line"><span class="token plain">              &quot;name&quot;: &quot;class&quot;, </span></div><div class="token-line"><span class="token plain">              &quot;value&quot;: { </span></div><div class="token-line"><span class="token plain">                &quot;type&quot;: 2, </span></div><div class="token-line"><span class="token plain">                &quot;content&quot;: &quot;app&quot;, </span></div><div class="token-line"><span class="token plain">                &quot;loc&quot;: { </span></div><div class="token-line"><span class="token plain">                  &quot;start&quot;: { </span></div><div class="token-line"><span class="token plain">                    &quot;column&quot;: 12, </span></div><div class="token-line"><span class="token plain">                    &quot;line&quot;: 1, </span></div><div class="token-line"><span class="token plain">                    &quot;offset&quot;: 11 </span></div><div class="token-line"><span class="token plain">                  }, </span></div><div class="token-line"><span class="token plain">                  &quot;end&quot;: { </span></div><div class="token-line"><span class="token plain">                    &quot;column&quot;: 17, </span></div><div class="token-line"><span class="token plain">                    &quot;line&quot;: 1, </span></div><div class="token-line"><span class="token plain">                    &quot;offset&quot;: 16 </span></div><div class="token-line"><span class="token plain">                  }, </span></div><div class="token-line"><span class="token plain">                  &quot;source&quot;: &quot;\&quot;app\&quot;&quot; </span></div><div class="token-line"><span class="token plain">                } </span></div><div class="token-line"><span class="token plain">              }, </span></div><div class="token-line"><span class="token plain">              &quot;loc&quot;: { </span></div><div class="token-line"><span class="token plain">                &quot;start&quot;: { </span></div><div class="token-line"><span class="token plain">                  &quot;column&quot;: 6, </span></div><div class="token-line"><span class="token plain">                  &quot;line&quot;: 1, </span></div><div class="token-line"><span class="token plain">                  &quot;offset&quot;: 5 </span></div><div class="token-line"><span class="token plain">                }, </span></div><div class="token-line"><span class="token plain">                &quot;end&quot;: { </span></div><div class="token-line"><span class="token plain">                  &quot;column&quot;: 17, </span></div><div class="token-line"><span class="token plain">                  &quot;line&quot;: 1, </span></div><div class="token-line"><span class="token plain">                  &quot;offset&quot;: 16 </span></div><div class="token-line"><span class="token plain">                }, </span></div><div class="token-line"><span class="token plain">                &quot;source&quot;: &quot;class=\&quot;app\&quot;&quot; </span></div><div class="token-line"><span class="token plain">              } </span></div><div class="token-line"><span class="token plain">            } </span></div><div class="token-line"><span class="token plain">          ], </span></div><div class="token-line"><span class="token plain">          &quot;isSelfClosing&quot;: false, </span></div><div class="token-line"><span class="token plain">          &quot;children&quot;: [ </span></div><div class="token-line"><span class="token plain">            { </span></div><div class="token-line"><span class="token plain">              &quot;type&quot;: 3, </span></div><div class="token-line"><span class="token plain">              &quot;content&quot;: &quot; 这是一段注释 &quot;, </span></div><div class="token-line"><span class="token plain">              &quot;loc&quot;: { </span></div><div class="token-line"><span class="token plain">                &quot;start&quot;: { </span></div><div class="token-line"><span class="token plain">                  &quot;column&quot;: 3, </span></div><div class="token-line"><span class="token plain">                  &quot;line&quot;: 2, </span></div><div class="token-line"><span class="token plain">                  &quot;offset&quot;: 20 </span></div><div class="token-line"><span class="token plain">                }, </span></div><div class="token-line"><span class="token plain">                &quot;end&quot;: { </span></div><div class="token-line"><span class="token plain">                  &quot;column&quot;: 18, </span></div><div class="token-line"><span class="token plain">                  &quot;line&quot;: 2, </span></div><div class="token-line"><span class="token plain">                  &quot;offset&quot;: 35 </span></div><div class="token-line"><span class="token plain">                }, </span></div><div class="token-line"><span class="token plain">                &quot;source&quot;: &quot;&lt;!-- 这是一段注释 --&gt;&quot; </span></div><div class="token-line"><span class="token plain">              } </span></div><div class="token-line"><span class="token plain">            }, </span></div><div class="token-line"><span class="token plain">            { </span></div><div class="token-line"><span class="token plain">              &quot;type&quot;: 1, </span></div><div class="token-line"><span class="token plain">              &quot;ns&quot;: 0, </span></div><div class="token-line"><span class="token plain">              &quot;tag&quot;: &quot;hello&quot;, </span></div><div class="token-line"><span class="token plain">              &quot;tagType&quot;: 1, </span></div><div class="token-line"><span class="token plain">              &quot;props&quot;: [], </span></div><div class="token-line"><span class="token plain">              &quot;isSelfClosing&quot;: false, </span></div><div class="token-line"><span class="token plain">              &quot;children&quot;: [ </span></div><div class="token-line"><span class="token plain">                { </span></div><div class="token-line"><span class="token plain">                  &quot;type&quot;: 1, </span></div><div class="token-line"><span class="token plain">                  &quot;ns&quot;: 0, </span></div><div class="token-line"><span class="token plain">                  &quot;tag&quot;: &quot;p&quot;, </span></div><div class="token-line"><span class="token plain">                  &quot;tagType&quot;: 0, </span></div><div class="token-line"><span class="token plain">                  &quot;props&quot;: [], </span></div><div class="token-line"><span class="token plain">                  &quot;isSelfClosing&quot;: false, </span></div><div class="token-line"><span class="token plain">                  &quot;children&quot;: [ </span></div><div class="token-line"><span class="token plain">                    { </span></div><div class="token-line"><span class="token plain">                      &quot;type&quot;: 5, </span></div><div class="token-line"><span class="token plain">                      &quot;content&quot;: { </span></div><div class="token-line"><span class="token plain">                        &quot;type&quot;: 4, </span></div><div class="token-line"><span class="token plain">                        &quot;isStatic&quot;: false, </span></div><div class="token-line"><span class="token plain">                        &quot;isConstant&quot;: false, </span></div><div class="token-line"><span class="token plain">                        &quot;content&quot;: &quot;msg&quot;, </span></div><div class="token-line"><span class="token plain">                        &quot;loc&quot;: { </span></div><div class="token-line"><span class="token plain">                          &quot;start&quot;: { </span></div><div class="token-line"><span class="token plain">                            &quot;column&quot;: 11, </span></div><div class="token-line"><span class="token plain">                            &quot;line&quot;: 4, </span></div><div class="token-line"><span class="token plain">                            &quot;offset&quot;: 56 </span></div><div class="token-line"><span class="token plain">                          }, </span></div><div class="token-line"><span class="token plain">                          &quot;end&quot;: { </span></div><div class="token-line"><span class="token plain">                            &quot;column&quot;: 14, </span></div><div class="token-line"><span class="token plain">                            &quot;line&quot;: 4, </span></div><div class="token-line"><span class="token plain">                            &quot;offset&quot;: 59 </span></div><div class="token-line"><span class="token plain">                          }, </span></div><div class="token-line"><span class="token plain">                          &quot;source&quot;: &quot;msg&quot; </span></div><div class="token-line"><span class="token plain">                        } </span></div><div class="token-line"><span class="token plain">                      }, </span></div><div class="token-line"><span class="token plain">                      &quot;loc&quot;: { </span></div><div class="token-line"><span class="token plain">                        &quot;start&quot;: { </span></div><div class="token-line"><span class="token plain">                          &quot;column&quot;: 8, </span></div><div class="token-line"><span class="token plain">                          &quot;line&quot;: 4, </span></div><div class="token-line"><span class="token plain">                          &quot;offset&quot;: 53 </span></div><div class="token-line"><span class="token plain">                        }, </span></div><div class="token-line"><span class="token plain">                        &quot;end&quot;: { </span></div><div class="token-line"><span class="token plain">                          &quot;column&quot;: 17, </span></div><div class="token-line"><span class="token plain">                          &quot;line&quot;: 4, </span></div><div class="token-line"><span class="token plain">                          &quot;offset&quot;: 62 </span></div><div class="token-line"><span class="token plain">                        }, </span></div><div class="token-line"><span class="token plain">                        &quot;source&quot;: &quot;{{ msg }}&quot; </span></div><div class="token-line"><span class="token plain">                      } </span></div><div class="token-line"><span class="token plain">                    } </span></div><div class="token-line"><span class="token plain">                  ], </span></div><div class="token-line"><span class="token plain">                  &quot;loc&quot;: { </span></div><div class="token-line"><span class="token plain">                    &quot;start&quot;: { </span></div><div class="token-line"><span class="token plain">                      &quot;column&quot;: 5, </span></div><div class="token-line"><span class="token plain">                      &quot;line&quot;: 4, </span></div><div class="token-line"><span class="token plain">                      &quot;offset&quot;: 50 </span></div><div class="token-line"><span class="token plain">                    }, </span></div><div class="token-line"><span class="token plain">                    &quot;end&quot;: { </span></div><div class="token-line"><span class="token plain">                      &quot;column&quot;: 21, </span></div><div class="token-line"><span class="token plain">                      &quot;line&quot;: 4, </span></div><div class="token-line"><span class="token plain">                      &quot;offset&quot;: 66 </span></div><div class="token-line"><span class="token plain">                    }, </span></div><div class="token-line"><span class="token plain">                    &quot;source&quot;: &quot;&lt;p&gt;{{ msg }}&lt;/p&gt;&quot; </span></div><div class="token-line"><span class="token plain">                  } </span></div><div class="token-line"><span class="token plain">                } </span></div><div class="token-line"><span class="token plain">              ], </span></div><div class="token-line"><span class="token plain">              &quot;loc&quot;: { </span></div><div class="token-line"><span class="token plain">                &quot;start&quot;: { </span></div><div class="token-line"><span class="token plain">                  &quot;column&quot;: 3, </span></div><div class="token-line"><span class="token plain">                  &quot;line&quot;: 3, </span></div><div class="token-line"><span class="token plain">                  &quot;offset&quot;: 38 </span></div><div class="token-line"><span class="token plain">                }, </span></div><div class="token-line"><span class="token plain">                &quot;end&quot;: { </span></div><div class="token-line"><span class="token plain">                  &quot;column&quot;: 11, </span></div><div class="token-line"><span class="token plain">                  &quot;line&quot;: 5, </span></div><div class="token-line"><span class="token plain">                  &quot;offset&quot;: 77 </span></div><div class="token-line"><span class="token plain">                }, </span></div><div class="token-line"><span class="token plain">                &quot;source&quot;: &quot;&lt;hello&gt;\n    &lt;p&gt;{{ msg }}&lt;/p&gt;\n  &lt;/hello&gt;&quot; </span></div><div class="token-line"><span class="token plain">              } </span></div><div class="token-line"><span class="token plain">            }, </span></div><div class="token-line"><span class="token plain">            { </span></div><div class="token-line"><span class="token plain">              &quot;type&quot;: 1, </span></div><div class="token-line"><span class="token plain">              &quot;ns&quot;: 0, </span></div><div class="token-line"><span class="token plain">              &quot;tag&quot;: &quot;p&quot;, </span></div><div class="token-line"><span class="token plain">              &quot;tagType&quot;: 0, </span></div><div class="token-line"><span class="token plain">              &quot;props&quot;: [], </span></div><div class="token-line"><span class="token plain">              &quot;isSelfClosing&quot;: false, </span></div><div class="token-line"><span class="token plain">              &quot;children&quot;: [ </span></div><div class="token-line"><span class="token plain">                { </span></div><div class="token-line"><span class="token plain">                  &quot;type&quot;: 2, </span></div><div class="token-line"><span class="token plain">                  &quot;content&quot;: &quot;This is an app&quot;, </span></div><div class="token-line"><span class="token plain">                  &quot;loc&quot;: { </span></div><div class="token-line"><span class="token plain">                    &quot;start&quot;: { </span></div><div class="token-line"><span class="token plain">                      &quot;column&quot;: 6, </span></div><div class="token-line"><span class="token plain">                      &quot;line&quot;: 6, </span></div><div class="token-line"><span class="token plain">                      &quot;offset&quot;: 83 </span></div><div class="token-line"><span class="token plain">                    }, </span></div><div class="token-line"><span class="token plain">                    &quot;end&quot;: { </span></div><div class="token-line"><span class="token plain">                      &quot;column&quot;: 20, </span></div><div class="token-line"><span class="token plain">                      &quot;line&quot;: 6, </span></div><div class="token-line"><span class="token plain">                      &quot;offset&quot;: 97 </span></div><div class="token-line"><span class="token plain">                    }, </span></div><div class="token-line"><span class="token plain">                    &quot;source&quot;: &quot;This is an app&quot; </span></div><div class="token-line"><span class="token plain">                  } </span></div><div class="token-line"><span class="token plain">                } </span></div><div class="token-line"><span class="token plain">              ], </span></div><div class="token-line"><span class="token plain">              &quot;loc&quot;: { </span></div><div class="token-line"><span class="token plain">                &quot;start&quot;: { </span></div><div class="token-line"><span class="token plain">                  &quot;column&quot;: 3, </span></div><div class="token-line"><span class="token plain">                  &quot;line&quot;: 6, </span></div><div class="token-line"><span class="token plain">                  &quot;offset&quot;: 80 </span></div><div class="token-line"><span class="token plain">                }, </span></div><div class="token-line"><span class="token plain">                &quot;end&quot;: { </span></div><div class="token-line"><span class="token plain">                  &quot;column&quot;: 24, </span></div><div class="token-line"><span class="token plain">                  &quot;line&quot;: 6, </span></div><div class="token-line"><span class="token plain">                  &quot;offset&quot;: 101 </span></div><div class="token-line"><span class="token plain">                }, </span></div><div class="token-line"><span class="token plain">                &quot;source&quot;: &quot;&lt;p&gt;This is an app&lt;/p&gt;&quot; </span></div><div class="token-line"><span class="token plain">              } </span></div><div class="token-line"><span class="token plain">            } </span></div><div class="token-line"><span class="token plain">          ], </span></div><div class="token-line"><span class="token plain">          &quot;loc&quot;: { </span></div><div class="token-line"><span class="token plain">            &quot;start&quot;: { </span></div><div class="token-line"><span class="token plain">              &quot;column&quot;: 1, </span></div><div class="token-line"><span class="token plain">              &quot;line&quot;: 1, </span></div><div class="token-line"><span class="token plain">              &quot;offset&quot;: 0 </span></div><div class="token-line"><span class="token plain">            }, </span></div><div class="token-line"><span class="token plain">            &quot;end&quot;: { </span></div><div class="token-line"><span class="token plain">              &quot;column&quot;: 7, </span></div><div class="token-line"><span class="token plain">              &quot;line&quot;: 7, </span></div><div class="token-line"><span class="token plain">              &quot;offset&quot;: 108 </span></div><div class="token-line"><span class="token plain">            }, </span></div><div class="token-line"><span class="token plain">            &quot;source&quot;: &quot;&lt;div class=\&quot;app\&quot;&gt;\n  &lt;!-- 这是一段注释 --&gt;\n  &lt;hello&gt;\n    &lt;p&gt;{{ msg }}&lt;/p&gt;\n  &lt;/hello&gt;\n  &lt;p&gt;This is an app&lt;/p&gt;\n&lt;/div&gt;&quot; </span></div><div class="token-line"><span class="token plain">          } </span></div><div class="token-line"><span class="token plain">        } </span></div><div class="token-line"><span class="token plain">      ], </span></div><div class="token-line"><span class="token plain">      &quot;helpers&quot;: [], </span></div><div class="token-line"><span class="token plain">      &quot;components&quot;: [], </span></div><div class="token-line"><span class="token plain">      &quot;directives&quot;: [], </span></div><div class="token-line"><span class="token plain">      &quot;hoists&quot;: [], </span></div><div class="token-line"><span class="token plain">      &quot;imports&quot;: [], </span></div><div class="token-line"><span class="token plain">      &quot;cached&quot;: 0, </span></div><div class="token-line"><span class="token plain">      &quot;temps&quot;: 0, </span></div><div class="token-line"><span class="token plain">      &quot;loc&quot;: { </span></div><div class="token-line"><span class="token plain">        &quot;start&quot;: { </span></div><div class="token-line"><span class="token plain">          &quot;column&quot;: 1, </span></div><div class="token-line"><span class="token plain">          &quot;line&quot;: 1, </span></div><div class="token-line"><span class="token plain">          &quot;offset&quot;: 0 </span></div><div class="token-line"><span class="token plain">        }, </span></div><div class="token-line"><span class="token plain">        &quot;end&quot;: { </span></div><div class="token-line"><span class="token plain">          &quot;column&quot;: 7, </span></div><div class="token-line"><span class="token plain">          &quot;line&quot;: 7, </span></div><div class="token-line"><span class="token plain">          &quot;offset&quot;: 108 </span></div><div class="token-line"><span class="token plain">        }, </span></div><div class="token-line"><span class="token plain">        &quot;source&quot;: &quot;&lt;div class=\&quot;app\&quot;&gt;\n  &lt;!-- 这是一段注释 --&gt;\n  &lt;hello&gt;\n    &lt;p&gt;{{ msg }}&lt;/p&gt;\n  &lt;/hello&gt;\n  &lt;p&gt;This is an app&lt;/p&gt;\n&lt;/div&gt;&quot; </span></div><div class="token-line"><span class="token plain">      } </span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>可以看到，AST 是树状结构，对于树中的每个节点，会有 type 字段描述节点的类型，tag 字段描述节点的标签，props 描述节点的属性，loc 描述节点对应代码相关信息，children 指向它的子节点对象数组。</p><p>当然 AST 中的节点还包含其他的一些属性，我在这里就不一一介绍了，你现在要理解的是 <strong>AST 中的节点是可以完整地描述它在模板中映射的节点信息</strong>。</p><p>注意，<strong>AST 对象根节点其实是一个虚拟节点</strong>，<strong>它并不会映射到一个具体节点</strong>，另外它还包含了其他的一些属性，这些属性在后续的 AST 转换的过程中会赋值，并在生成代码阶段用到。</p><p>那么，为什么要设计一个虚拟节点呢？</p><p>因为 Vue.js 3.0 和 Vue.js 2.x 有一个很大的不同——Vue.js 3.0 支持了 Fragment 的语法，即组件可以有多个根节点，比如：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;img src=&quot;./logo.jpg&quot;&gt; </span></div><div class="token-line"><span class="token plain">    &lt;hello :msg=&quot;msg&quot;&gt;&lt;/hello&gt;</span></div></pre></div><p>这种写法在 Vue.js 2.x 中会报错，提示模板只能有一个根节点，而 Vue.js 3.0 允许了这种写法。但是对于一棵树而言，必须有一个根节点，所以虚拟节点在这种场景下就非常有用了，它可以作为 AST 的根节点，然后其 children 包含了 img 和 hello 的节点。</p><p>好了，到这里你已经大致了解了 AST，那么接下来我们看一下如何根据模板字符串来构建这个 AST 对象吧。</p><p>先来看一下 baseParse 的实现：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">function baseParse(content, options = {}) { </span></div><div class="token-line"><span class="token plain">        // 创建解析上下文 </span></div><div class="token-line"><span class="token plain">        const context = createPa  rserContext(content, options) </span></div><div class="token-line"><span class="token plain">        const start = getCursor(context) </span></div><div class="token-line"><span class="token plain">        // 解析子节点，并创建 AST  </span></div><div class="token-line"><span class="token plain">        return createRoot(parseChildren(context, 0 /* DATA */, []), getSelection(context, start)) </span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>baseParse 主要就做三件事情：<strong>创建解析上下文</strong>，<strong>解析子节点</strong>，<strong>创建 AST 根节点</strong>。</p><h4 id="创建解析上下文"><a aria-hidden="true" tabindex="-1" href="/blog/vue3源码分析/04.模块三编译过程和背后的优化思想/02#创建解析上下文"><span class="icon icon-link"></span></a>创建解析上下文</h4><p>首先，我们来分析创建解析上下文的过程，先来看 createParserContext 的实现：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// 默认解析配置 </span></div><div class="token-line"><span class="token plain">    const defaultParserOptions = { </span></div><div class="token-line"><span class="token plain">      delimiters: [`{{`, `}}`], </span></div><div class="token-line"><span class="token plain">      getNamespace: () =&gt; 0 /* HTML */, </span></div><div class="token-line"><span class="token plain">      getTextMode: () =&gt; 0 /* DATA */, </span></div><div class="token-line"><span class="token plain">      isVoidTag: NO, </span></div><div class="token-line"><span class="token plain">      isPreTag: NO, </span></div><div class="token-line"><span class="token plain">      isCustomElement: NO, </span></div><div class="token-line"><span class="token plain">      decodeEntities: (rawText) =&gt; rawText.replace(decodeRE, (_, p1) =&gt; decodeMap[p1]), </span></div><div class="token-line"><span class="token plain">      onError: defaultOnError </span></div><div class="token-line"><span class="token plain">    } </span></div><div class="token-line"><span class="token plain">    function createParserContext(content, options) { </span></div><div class="token-line"><span class="token plain">      return { </span></div><div class="token-line"><span class="token plain">        options: extend({}, defaultParserOptions, options), </span></div><div class="token-line"><span class="token plain">        column: 1, </span></div><div class="token-line"><span class="token plain">        line: 1, </span></div><div class="token-line"><span class="token plain">        offset: 0, </span></div><div class="token-line"><span class="token plain">        originalSource: content, </span></div><div class="token-line"><span class="token plain">        source: content, </span></div><div class="token-line"><span class="token plain">        inPre: false, </span></div><div class="token-line"><span class="token plain">        inVPre: false </span></div><div class="token-line"><span class="token plain">      } </span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>解析上下文实际上就是一个 JavaScript 对象，它维护着解析过程中的上下文，其中 options 表示解析相关配置 ，column 表示当前代码的列号，line 表示当前代码的行号，originalSource 表示最初的原始代码，source 表示当前代码，offset 表示当前代码相对于原始代码的偏移量，inPre 表示当前代码是否在 pre 标签内，inVPre 表示当前代码是否在 v-pre 指令的环境下。</p><p>在后续解析的过程中，会始终维护和更新这个解析上下文，它能够表示当前解析的状态。</p><p>创建完解析上下文，接下来就开始解析子节点了。</p><h4 id="解析子节点"><a aria-hidden="true" tabindex="-1" href="/blog/vue3源码分析/04.模块三编译过程和背后的优化思想/02#解析子节点"><span class="icon icon-link"></span></a>解析子节点</h4><p>我们先来看一下 parseChildren 函数的实现：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">function parseChildren(context, mode, ancestors) { </span></div><div class="token-line"><span class="token plain">      const parent = last(ancestors) </span></div><div class="token-line"><span class="token plain">      const ns = parent ? parent.ns : 0 /* HTML */ </span></div><div class="token-line"><span class="token plain">      const nodes = [] </span></div><div class="token-line"><span class="token plain">       </span></div><div class="token-line"><span class="token plain">      // 自顶向下分析代码，生成 nodes </span></div><div class="token-line"><span class="token plain">       </span></div><div class="token-line"><span class="token plain">      let removedWhitespace = false </span></div><div class="token-line"><span class="token plain">      // 空白字符管理 </span></div><div class="token-line"><span class="token plain">       </span></div><div class="token-line"><span class="token plain">      return removedWhitespace ? nodes.filter(Boolean) : nodes </span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>parseChildren 的目的就是解析并创建 AST 节点数组。它有两个主要流程，第一个是自顶向下分析代码，生成 AST 节点数组 nodes；第二个是空白字符管理，用于提高编译的效率。</p><p>首先，我们来看<strong>生成 AST 节点数组</strong>的流程：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">function parseChildren(context, mode, ancestors) { </span></div><div class="token-line"><span class="token plain">      // 父节点 </span></div><div class="token-line"><span class="token plain">      const parent = last(ancestors) </span></div><div class="token-line"><span class="token plain">      const ns = parent ? parent.ns : 0 /* HTML */ </span></div><div class="token-line"><span class="token plain">      const nodes = [] </span></div><div class="token-line"><span class="token plain">      // 判断是否遍历结束 </span></div><div class="token-line"><span class="token plain">      while (!isEnd(context, mode, ancestors)) { </span></div><div class="token-line"><span class="token plain">        const s = context.source </span></div><div class="token-line"><span class="token plain">        let node = undefined </span></div><div class="token-line"><span class="token plain">        if (mode === 0 /* DATA */ || mode === 1 /* RCDATA */) { </span></div><div class="token-line"><span class="token plain">          if (!context.inVPre &amp;&amp; startsWith(s, context.options.delimiters[0])) { </span></div><div class="token-line"><span class="token plain">            // 处理 {{ 插值代码 </span></div><div class="token-line"><span class="token plain">            node = parseInterpolation(context, mode) </span></div><div class="token-line"><span class="token plain">          } </span></div><div class="token-line"><span class="token plain">          else if (mode === 0 /* DATA */ &amp;&amp; s[0] === &#x27;&lt;&#x27;) { </span></div><div class="token-line"><span class="token plain">            // 处理 &lt; 开头的代码 </span></div><div class="token-line"><span class="token plain">            if (s.length === 1) { </span></div><div class="token-line"><span class="token plain">              // s 长度为 1，说明代码结尾是 &lt;，报错 </span></div><div class="token-line"><span class="token plain">              emitError(context, 5 /* EOF_BEFORE_TAG_NAME */, 1) </span></div><div class="token-line"><span class="token plain">            } </span></div><div class="token-line"><span class="token plain">            else if (s[1] === &#x27;!&#x27;) { </span></div><div class="token-line"><span class="token plain">              // 处理 &lt;! 开头的代码 </span></div><div class="token-line"><span class="token plain">              if (startsWith(s, &#x27;&lt;!--&#x27;)) { </span></div><div class="token-line"><span class="token plain">                // 处理注释节点 </span></div><div class="token-line"><span class="token plain">                node = parseComment(context) </span></div><div class="token-line"><span class="token plain">              } </span></div><div class="token-line"><span class="token plain">              else if (startsWith(s, &#x27;&lt;!DOCTYPE&#x27;)) { </span></div><div class="token-line"><span class="token plain">                // 处理 &lt;!DOCTYPE 节点 </span></div><div class="token-line"><span class="token plain">                node = parseBogusComment(context) </span></div><div class="token-line"><span class="token plain">              } </span></div><div class="token-line"><span class="token plain">              else if (startsWith(s, &#x27;&lt;![CDATA[&#x27;)) { </span></div><div class="token-line"><span class="token plain">                // 处理 &lt;![CDATA[ 节点 </span></div><div class="token-line"><span class="token plain">                if (ns !== 0 /* HTML */) { </span></div><div class="token-line"><span class="token plain">                  node = parseCDATA(context, ancestors) </span></div><div class="token-line"><span class="token plain">                } </span></div><div class="token-line"><span class="token plain">                else { </span></div><div class="token-line"><span class="token plain">                  emitError(context, 1 /* CDATA_IN_HTML_CONTENT */) </span></div><div class="token-line"><span class="token plain">                  node = parseBogusComment(context) </span></div><div class="token-line"><span class="token plain">                } </span></div><div class="token-line"><span class="token plain">              } </span></div><div class="token-line"><span class="token plain">              else { </span></div><div class="token-line"><span class="token plain">                emitError(context, 11 /* INCORRECTLY_OPENED_COMMENT */) </span></div><div class="token-line"><span class="token plain">                node = parseBogusComment(context) </span></div><div class="token-line"><span class="token plain">              } </span></div><div class="token-line"><span class="token plain">            } </span></div><div class="token-line"><span class="token plain">            else if (s[1] === &#x27;/&#x27;) { </span></div><div class="token-line"><span class="token plain">              // 处理 &lt;/ 结束标签 </span></div><div class="token-line"><span class="token plain">              if (s.length === 2) { </span></div><div class="token-line"><span class="token plain">                // s 长度为 2，说明代码结尾是 &lt;/，报错 </span></div><div class="token-line"><span class="token plain">                emitError(context, 5 /* EOF_BEFORE_TAG_NAME */, 2) </span></div><div class="token-line"><span class="token plain">              } </span></div><div class="token-line"><span class="token plain">              else if (s[2] === &#x27;&gt;&#x27;) { </span></div><div class="token-line"><span class="token plain">                // &lt;/&gt; 缺少结束标签，报错 </span></div><div class="token-line"><span class="token plain">                emitError(context, 14 /* MISSING_END_TAG_NAME */, 2) </span></div><div class="token-line"><span class="token plain">                advanceBy(context, 3) </span></div><div class="token-line"><span class="token plain">                continue </span></div><div class="token-line"><span class="token plain">              } </span></div><div class="token-line"><span class="token plain">              else if (/[a-z]/i.test(s[2])) { </span></div><div class="token-line"><span class="token plain">                // 多余的结束标签 </span></div><div class="token-line"><span class="token plain">                emitError(context, 23 /* X_INVALID_END_TAG */) </span></div><div class="token-line"><span class="token plain">                parseTag(context, 1 /* End */, parent) </span></div><div class="token-line"><span class="token plain">                continue </span></div><div class="token-line"><span class="token plain">              } </span></div><div class="token-line"><span class="token plain">              else { </span></div><div class="token-line"><span class="token plain">                emitError(context, 12 /* INVALID_FIRST_CHARACTER_OF_TAG_NAME */, 2) </span></div><div class="token-line"><span class="token plain">                node = parseBogusComment(context) </span></div><div class="token-line"><span class="token plain">              } </span></div><div class="token-line"><span class="token plain">            } </span></div><div class="token-line"><span class="token plain">            else if (/[a-z]/i.test(s[1])) { </span></div><div class="token-line"><span class="token plain">              // 解析标签元素节点 </span></div><div class="token-line"><span class="token plain">              node = parseElement(context, ancestors) </span></div><div class="token-line"><span class="token plain">            } </span></div><div class="token-line"><span class="token plain">            else if (s[1] === &#x27;?&#x27;) { </span></div><div class="token-line"><span class="token plain">              emitError(context, 21 /* UNEXPECTED_QUESTION_MARK_INSTEAD_OF_TAG_NAME */, 1) </span></div><div class="token-line"><span class="token plain">              node = parseBogusComment(context) </span></div><div class="token-line"><span class="token plain">            } </span></div><div class="token-line"><span class="token plain">            else { </span></div><div class="token-line"><span class="token plain">              emitError(context, 12 /* INVALID_FIRST_CHARACTER_OF_TAG_NAME */, 1) </span></div><div class="token-line"><span class="token plain">            } </span></div><div class="token-line"><span class="token plain">          } </span></div><div class="token-line"><span class="token plain">        } </span></div><div class="token-line"><span class="token plain">        if (!node) { </span></div><div class="token-line"><span class="token plain">          // 解析普通文本节点 </span></div><div class="token-line"><span class="token plain">          node = parseText(context, mode) </span></div><div class="token-line"><span class="token plain">        } </span></div><div class="token-line"><span class="token plain">        if (isArray(node)) { </span></div><div class="token-line"><span class="token plain">          // 如果 node 是数组，则遍历添加 </span></div><div class="token-line"><span class="token plain">          for (let i = 0; i &lt; node.length; i++) { </span></div><div class="token-line"><span class="token plain">            pushNode(nodes, node[i]) </span></div><div class="token-line"><span class="token plain">          } </span></div><div class="token-line"><span class="token plain">        } </span></div><div class="token-line"><span class="token plain">        else { </span></div><div class="token-line"><span class="token plain">          // 添加单个 node </span></div><div class="token-line"><span class="token plain">          pushNode(nodes, node) </span></div><div class="token-line"><span class="token plain">        } </span></div><div class="token-line"><span class="token plain">      } </span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>这些代码看起来很复杂，但它的思路就是自顶向下地去遍历代码，然后根据不同的情况尝试去解析代码，然后把生成的 node 添加到 AST nodes 数组中。在解析的过程中，解析上下文 context 的状态也是在不断发生变化的，我们可以通过 context.source 拿到当前解析剩余的代码 s，然后根据 s 不同的情况走不同的分支处理逻辑。在解析的过程中，可能会遇到各种错误，都会通过 emitError 方法报错。</p><p>我们没有必要去了解所有代码的分支细节，只需要知道大致的解析思路即可，因此我们这里只分析四种情况：注释节点的解析、插值的解析、普通文本的解析，以及元素节点的解析。</p><ul><li>注释节点的解析</li></ul><p>首先，我们来看注释节点的解析过程，它会解析模板中的注释节点，比如 <code>&lt;!-- 这是一段注释 \--&gt;，</code> 即当前代码 s 是以 <code>&lt;!--</code> 开头的字符串，则走到注释节点的解析处理逻辑。</p><p>我们来看 parseComment 的实现：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">function parseComment(context) { </span></div><div class="token-line"><span class="token plain">      const start = getCursor(context) </span></div><div class="token-line"><span class="token plain">      let content </span></div><div class="token-line"><span class="token plain">      // 常规注释的结束符 </span></div><div class="token-line"><span class="token plain">      const match = /--(\!)?&gt;/.exec(context.source) </span></div><div class="token-line"><span class="token plain">      if (!match) { </span></div><div class="token-line"><span class="token plain">        // 没有匹配的注释结束符 </span></div><div class="token-line"><span class="token plain">        content = context.source.slice(4) </span></div><div class="token-line"><span class="token plain">        advanceBy(context, context.source.length) </span></div><div class="token-line"><span class="token plain">        emitError(context, 7 /* EOF_IN_COMMENT */) </span></div><div class="token-line"><span class="token plain">      } </span></div><div class="token-line"><span class="token plain">      else { </span></div><div class="token-line"><span class="token plain">        if (match.index &lt;= 3) { </span></div><div class="token-line"><span class="token plain">          // 非法的注释符号 </span></div><div class="token-line"><span class="token plain">          emitError(context, 0 /* ABRUPT_CLOSING_OF_EMPTY_COMMENT */) </span></div><div class="token-line"><span class="token plain">        } </span></div><div class="token-line"><span class="token plain">        if (match[1]) { </span></div><div class="token-line"><span class="token plain">          // 注释结束符不正确 </span></div><div class="token-line"><span class="token plain">          emitError(context, 10 /* INCORRECTLY_CLOSED_COMMENT */) </span></div><div class="token-line"><span class="token plain">        } </span></div><div class="token-line"><span class="token plain">        // 获取注释的内容 </span></div><div class="token-line"><span class="token plain">        content = context.source.slice(4, match.index) </span></div><div class="token-line"><span class="token plain">        // 截取到注释结尾之间的代码，用于后续判断嵌套注释 </span></div><div class="token-line"><span class="token plain">        const s = context.source.slice(0, match.index) </span></div><div class="token-line"><span class="token plain">        let prevIndex = 1, nestedIndex = 0 </span></div><div class="token-line"><span class="token plain">        // 判断嵌套注释符的情况，存在即报错 </span></div><div class="token-line"><span class="token plain">        while ((nestedIndex = s.indexOf(&#x27;&lt;!--&#x27;, prevIndex)) !== -1) { </span></div><div class="token-line"><span class="token plain">          advanceBy(context, nestedIndex - prevIndex + 1) </span></div><div class="token-line"><span class="token plain">          if (nestedIndex + 4 &lt; s.length) { </span></div><div class="token-line"><span class="token plain">            emitError(context, 16 /* NESTED_COMMENT */) </span></div><div class="token-line"><span class="token plain">          } </span></div><div class="token-line"><span class="token plain">          prevIndex = nestedIndex + 1 </span></div><div class="token-line"><span class="token plain">        } </span></div><div class="token-line"><span class="token plain">        // 前进代码到注释结束符后 </span></div><div class="token-line"><span class="token plain">        advanceBy(context, match.index + match[0].length - prevIndex + 1) </span></div><div class="token-line"><span class="token plain">      } </span></div><div class="token-line"><span class="token plain">      return { </span></div><div class="token-line"><span class="token plain">        type: 3 /* COMMENT */, </span></div><div class="token-line"><span class="token plain">        content, </span></div><div class="token-line"><span class="token plain">        loc: getSelection(context, start) </span></div><div class="token-line"><span class="token plain">      } </span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>其实，parseComment 的实现很简单，首先它会利用注释结束符的正则表达式去匹配代码，找出注释结束符。如果没有匹配到或者注释结束符不合法，都会报错。<br/>如果找到合法的注释结束符，则获取它中间的注释内容 content，然后截取注释开头到结尾之间的代码，并判断是否有嵌套注释，如果有嵌套注释也会报错。</p><p>接着就是通过调用 advanceBy 前进代码到注释结束符后，这个函数在整个模板解析过程中经常被调用，它的目的是用来前进代码，更新 context 解析上下文，我们来看一下它的实现：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">function advanceBy(context, numberOfCharacters) { </span></div><div class="token-line"><span class="token plain">      const { source } = context </span></div><div class="token-line"><span class="token plain">      // 更新 context 的 offset、line、column </span></div><div class="token-line"><span class="token plain">      advancePositionWithMutation(context, source, numberOfCharacters) </span></div><div class="token-line"><span class="token plain">      // 更新 context 的 source </span></div><div class="token-line"><span class="token plain">      context.source = source.slice(numberOfCharacters) </span></div><div class="token-line"><span class="token plain">    } </span></div><div class="token-line"><span class="token plain">    function advancePositionWithMutation(pos, source, numberOfCharacters = source.length) { </span></div><div class="token-line"><span class="token plain">      let linesCount = 0 </span></div><div class="token-line"><span class="token plain">      let lastNewLinePos = -1 </span></div><div class="token-line"><span class="token plain">      for (let i = 0; i &lt; numberOfCharacters; i++) { </span></div><div class="token-line"><span class="token plain">        if (source.charCodeAt(i) === 10 /* newline char code */) { </span></div><div class="token-line"><span class="token plain">          linesCount++ </span></div><div class="token-line"><span class="token plain">          lastNewLinePos = i </span></div><div class="token-line"><span class="token plain">        } </span></div><div class="token-line"><span class="token plain">      } </span></div><div class="token-line"><span class="token plain">      pos.offset += numberOfCharacters </span></div><div class="token-line"><span class="token plain">      pos.line += linesCount </span></div><div class="token-line"><span class="token plain">      pos.column = </span></div><div class="token-line"><span class="token plain">        lastNewLinePos === -1 </span></div><div class="token-line"><span class="token plain">          ? pos.column + numberOfCharacters </span></div><div class="token-line"><span class="token plain">          : numberOfCharacters - lastNewLinePos </span></div><div class="token-line"><span class="token plain">      return pos </span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>advanceBy 的实现很简单，主要就是更新解析上下文 context 中的 source 来前进代码，同时更新 offset、line、column 等和代码位置相关的属性。</p><p>为了更直观地说明 advanceBy 的作用，前面的示例可以通过下图表示：</p><p><img src="https://s0.lgstatic.com/i/image/M00/43/D2/Ciqc1F88z3mACHOrAAFRdAq-Jxw187.png" alt="22.png"/></p><p>经过 advanceBy 前进代码到注释结束符后，表示注释部分代码处理完毕，可以继续解析后续代码了。</p><p>parseComment 最终返回的值就是一个描述注释节点的对象，其中 type 表示它是一个注释节点，content 表示注释的内容，loc 表示注释的代码开头和结束的位置信息。</p><ul><li>插值的解析</li></ul><p>接下来，我们来看插值的解析过程，它会解析模板中的插值，比如 <code>{<!-- -->{<!-- --> msg <!-- -->}<!-- -->}</code> ，即当前代码 s 是以 <!-- -->{<!-- -->{<!-- --> 开头的字符串，且不在 v-pre 指令的环境下（v-pre 会跳过插值的解析），则会走到插值的解析处理逻辑 parseInterpolation 函数，我们来看它的实现：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">function parseInterpolation(context, mode) { </span></div><div class="token-line"><span class="token plain">      // 从配置中获取插值开始和结束分隔符，默认是 {{ 和 }} </span></div><div class="token-line"><span class="token plain">      const [open, close] = context.options.delimiters </span></div><div class="token-line"><span class="token plain">      const closeIndex = context.source.indexOf(close, open.length) </span></div><div class="token-line"><span class="token plain">      if (closeIndex === -1) { </span></div><div class="token-line"><span class="token plain">        emitError(context, 25 /* X_MISSING_INTERPOLATION_END */) </span></div><div class="token-line"><span class="token plain">        return undefined </span></div><div class="token-line"><span class="token plain">      } </span></div><div class="token-line"><span class="token plain">      const start = getCursor(context) </span></div><div class="token-line"><span class="token plain">      // 代码前进到插值开始分隔符后 </span></div><div class="token-line"><span class="token plain">      advanceBy(context, open.length) </span></div><div class="token-line"><span class="token plain">      // 内部插值开始位置 </span></div><div class="token-line"><span class="token plain">      const innerStart = getCursor(context) </span></div><div class="token-line"><span class="token plain">      // 内部插值结束位置 </span></div><div class="token-line"><span class="token plain">      const innerEnd = getCursor(context) </span></div><div class="token-line"><span class="token plain">      // 插值原始内容的长度 </span></div><div class="token-line"><span class="token plain">      const rawContentLength = closeIndex - open.length </span></div><div class="token-line"><span class="token plain">      // 插值原始内容 </span></div><div class="token-line"><span class="token plain">      const rawContent = context.source.slice(0, rawContentLength) </span></div><div class="token-line"><span class="token plain">      // 获取插值的内容，并前进代码到插值的内容后 </span></div><div class="token-line"><span class="token plain">      const preTrimContent = parseTextData(context, rawContentLength, mode) </span></div><div class="token-line"><span class="token plain">      const content = preTrimContent.trim() </span></div><div class="token-line"><span class="token plain">      // 内容相对于插值开始分隔符的头偏移 </span></div><div class="token-line"><span class="token plain">      const startOffset = preTrimContent.indexOf(content) </span></div><div class="token-line"><span class="token plain">      if (startOffset &gt; 0) { </span></div><div class="token-line"><span class="token plain">        // 更新内部插值开始位置 </span></div><div class="token-line"><span class="token plain">        advancePositionWithMutation(innerStart, rawContent, startOffset) </span></div><div class="token-line"><span class="token plain">      } </span></div><div class="token-line"><span class="token plain">      // 内容相对于插值结束分隔符的尾偏移 </span></div><div class="token-line"><span class="token plain">      const endOffset = rawContentLength - (preTrimContent.length - content.length - startOffset) </span></div><div class="token-line"><span class="token plain">      // 更新内部插值结束位置 </span></div><div class="token-line"><span class="token plain">      advancePositionWithMutation(innerEnd, rawContent, endOffset); </span></div><div class="token-line"><span class="token plain">      // 前进代码到插值结束分隔符后 </span></div><div class="token-line"><span class="token plain">      advanceBy(context, close.length) </span></div><div class="token-line"><span class="token plain">      return { </span></div><div class="token-line"><span class="token plain">        type: 5 /* INTERPOLATION */, </span></div><div class="token-line"><span class="token plain">        content: { </span></div><div class="token-line"><span class="token plain">          type: 4 /* SIMPLE_EXPRESSION */, </span></div><div class="token-line"><span class="token plain">          isStatic: false, </span></div><div class="token-line"><span class="token plain">          isConstant: false, </span></div><div class="token-line"><span class="token plain">          content, </span></div><div class="token-line"><span class="token plain">          loc: getSelection(context, innerStart, innerEnd) </span></div><div class="token-line"><span class="token plain">        }, </span></div><div class="token-line"><span class="token plain">        loc: getSelection(context, start) </span></div><div class="token-line"><span class="token plain">      } </span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>parseInterpolation 的实现也很简单，首先它会尝试找插值的结束分隔符，如果找不到则报错。</p><p>如果找到，先前进代码到插值开始分隔符后，然后通过 parseTextData 获取插值中间的内容并前进代码到插值内容后，除了普通字符串，parseTextData 内部会处理一些 HTML 实体符号比如 <code>&amp;nbsp</code> 。由于插值的内容可能是前后有空白字符的，所以最终返回的 content 需要执行一下 trim 函数。</p><p>为了准确地反馈插值内容的代码位置信息，我们使用了 innerStart 和 innerEnd 去记录插值内容（不包含空白字符）的代码开头和结束位置。</p><p>接着就是前进代码到插值结束分隔符后，表示插值部分代码处理完毕，可以继续解析后续代码了。</p><p>parseInterpolation 最终返回的值就是一个描述插值节点的对象，其中 type 表示它是一个插值节点，loc 表示插值的代码开头和结束的位置信息，而 content 又是一个描述表达式节点的对象，其中 type 表示它是一个表达式节点，loc 表示内容的代码开头和结束的位置信息，content 表示插值的内容。</p><ul><li>普通文本的解析</li></ul><p>接下来，我们来看普通文本的解析过程，它会解析模板中的普通文本，比如 <code>This is an app</code> ，即当前代码 s 既不是以 <!-- -->{<!-- -->{<!-- --> 插值分隔符开头的字符串，也不是以 &lt; 开头的字符串，则走到普通文本的解析处理逻辑，我们来看 parseText 的实现：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">function parseText(context, mode) { </span></div><div class="token-line"><span class="token plain">      // 文本结束符 </span></div><div class="token-line"><span class="token plain">      const endTokens = [&#x27;&lt;&#x27;, context.options.delimiters[0]] </span></div><div class="token-line"><span class="token plain">      if (mode === 3 /* CDATA */) { </span></div><div class="token-line"><span class="token plain">        // CDATA 标记 XML 中的纯文本 </span></div><div class="token-line"><span class="token plain">        endTokens.push(&#x27;]]&gt;&#x27;) </span></div><div class="token-line"><span class="token plain">      } </span></div><div class="token-line"><span class="token plain">      let endIndex = context.source.length </span></div><div class="token-line"><span class="token plain">      // 遍历文本结束符，匹配找到结束的位置 </span></div><div class="token-line"><span class="token plain">      for (let i = 0; i &lt; endTokens.length; i++) { </span></div><div class="token-line"><span class="token plain">        const index = context.source.indexOf(endTokens[i], 1) </span></div><div class="token-line"><span class="token plain">        if (index !== -1 &amp;&amp; endIndex &gt; index) { </span></div><div class="token-line"><span class="token plain">          endIndex = index </span></div><div class="token-line"><span class="token plain">        } </span></div><div class="token-line"><span class="token plain">      } </span></div><div class="token-line"><span class="token plain">      const start = getCursor(context) </span></div><div class="token-line"><span class="token plain">      // 获取文本的内容，并前进代码到文本的内容后 </span></div><div class="token-line"><span class="token plain">      const content = parseTextData(context, endIndex, mode) </span></div><div class="token-line"><span class="token plain">      return { </span></div><div class="token-line"><span class="token plain">        type: 2 /* TEXT */, </span></div><div class="token-line"><span class="token plain">        content, </span></div><div class="token-line"><span class="token plain">        loc: getSelection(context, start) </span></div><div class="token-line"><span class="token plain">      } </span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>同样，parseText 的实现很简单。对于一段文本来说，都是在遇到 &lt; 或者插值分隔符 <!-- -->{<!-- -->{<!-- --> 结束，所以会遍历这些结束符，匹配并找到文本结束的位置，然后执行 parseTextData 获取文本的内容，并前进代码到文本的内容后。</p><p>parseText 最终返回的值就是一个描述文本节点的对象，其中 type 表示它是一个文本节点，content 表示文本的内容，loc 表示文本的代码开头和结束的位置信息。</p><p>这部分内容比较多，所以本课时的内容就先到这。下节课中，我们接着分析元素节点，继续解析 template 生成 AST 的背后实现原理。</p><blockquote><p><strong>本节课的相关代码在源代码中的位置如下：</strong><br/>packages/compiler-core/src/compile.ts<br/>packages/compiler-core/src/parse.ts</p></blockquote></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/docs/vue3源码分析/04.模块三编译过程和背后的优化思想/02.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">5/2/2022 10:56:55</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog/umi.js"></script>
  </body>
</html>
